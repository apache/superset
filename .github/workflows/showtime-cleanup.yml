name: ðŸŽª Showtime Cleanup

# Scheduled cleanup of expired environments
on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

  # Manual trigger for testing
  workflow_dispatch:

# Common environment variables
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}
  GITHUB_ORG: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}

jobs:
  cleanup-expired:
    name: Clean up expired showtime environments
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Install Superset Showtime
        run: pip install superset-showtime

      - name: Cleanup expired environments
        run: |
          echo "Cleaning up environments respecting TTL labels"
          python -m showtime cleanup --respect-ttl
