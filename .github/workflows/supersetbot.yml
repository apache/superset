name: SupersetBot Workflow

on:
  issue_comment:
    types: [created, edited]

  # Making the workflow testable since `issue_comment` only trigges on
  # the default branch
  workflow_dispatch:
    inputs:
      comment_body:
        description: 'Comment Body'
        required: true
        type: string

jobs:
  supersetbot:
    runs-on: ubuntu-latest
    steps:
      - name: Execute SupersetBot Command
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = github.event_name === 'workflow_dispatch' ?
              github.event.inputs.comment_body :
              context.payload.comment.body;
            const commentBody = context.payload.comment.body;
            const commandPrefix = '@supersetbot';
            if (!commentBody.startsWith(commandPrefix)) return;

            const regex = /"([^"]+)"|\S+/g;
            let matches = [...commentBody.slice(commandPrefix.length).trim().matchAll(regex)];
            // Extracting the command which is the first match
            const command = matches[0] ? matches[0][0] : null;
            // Generating args array, skipping the first element (command)
            const args = matches.slice(1).map(match => match[1] ? match[1] : match[0]);

            if (command === 'label') {
              const label = args[0];
              await github.rest.issues.addLabels({
                context.repo.owner,
                context.repo.repo,
                context.issue.number,
                labels: [label],
              });
            } else if (command === 'unlabel') {
              const label = args[0];
              await github.rest.issues.removeLabel({
                context.repo.owner,
                context.repo.repo,
                context.issue.number,
                name: label,
              }).catch(error => {
                if (error.status !== 404) {
                  throw error;
                }
              });
            }
