name: SupersetBot Workflow

on:
  issue_comment:
    types: [created, edited]

  # Making the workflow testable since `issue_comment` only trigges on
  # the default branch
  workflow_dispatch:
    inputs:
      comment_body:
        description: 'Comment Body'
        required: true
        type: string
      issue_number:
        required: true
        type: string


jobs:
  supersetbot:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@supersetbot'))
    steps:
      - name: Execute SupersetBot Command
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.eventName === 'workflow_dispatch' ?
              context.payload.inputs.comment_body :
              context.payload.comment.body;
            const issueNumber = context.eventName === 'workflow_dispatch' ?
              context.payload.inputs.issue_number :
              context.issue.number;
            const commandPrefix = '@supersetbot';

            const regex = /"([^"]+)"|\S+/g;
            let matches = [...commentBody.slice(commandPrefix.length).trim().matchAll(regex)];
            // Extracting the command which is the first match
            const command = matches[0] ? matches[0][0] : null;
            // Generating args array, skipping the first element (command)
            const args = matches.slice(1).map(match => match[1] ? match[1] : match[0]);

            if (command === 'label') {
              const label = args[0];
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [label],
              }).catch(error => {
                console.log(error);
              });
            } else if (command === 'unlabel') {
              const label = args[0];
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: label,
              }).catch(error => {
                console.log(error);
              });
            }
