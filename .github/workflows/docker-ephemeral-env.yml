name: Push Image

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build_test_scan_and_push:
    name: Build, test, scan and push image
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ self-hosted-ubuntu-2004 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Environment variables
        id: vars
        run: |
          echo "::set-output name=image-tag::$(git rev-parse --short HEAD)"
          echo "::set-output name=repository-name::imgarena/dataops/superset"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: eu-west-1

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          registries: 724428741115

      - name: Build, Lint, Test & Scan EMR on EKS Image
        run: |
          docker build -t ${{ steps.login-ecr.outputs.registry }}/${{ steps.vars.outputs.repository-name }}:${{ steps.vars.outputs.image-tag }} -f Dockerfile .

      - name: Push container images to AWS ECR
        run: |
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ steps.vars.outputs.repository-name }}:${{ steps.vars.outputs.image-tag }}
