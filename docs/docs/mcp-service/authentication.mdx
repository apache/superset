---
title: Authentication & Security
sidebar_position: 4
version: 1
---

# Authentication & Security

The MCP service provides enterprise-grade JWT Bearer authentication with flexible configuration options and comprehensive security controls.

## Quick Start

### Development Mode (Default)

:::tip
Authentication is **disabled by default** for local development - no configuration needed.
:::

```bash
# No configuration needed - service runs without authentication
superset mcp run --port 5008 --debug
```

### Production Mode

:::warning
Always enable authentication for production deployments to secure your Superset instance.
:::

Enable JWT authentication in your Superset configuration:

```python
# In superset_config.py
MCP_AUTH_ENABLED = True
MCP_JWKS_URI = "https://auth.company.com/.well-known/jwks.json"
MCP_JWT_ISSUER = "https://auth.company.com/"
MCP_JWT_AUDIENCE = "superset-mcp-api"
MCP_REQUIRED_SCOPES = ["dashboard:read", "chart:read", "dataset:read"]
```

## Configuration Options

### Option 1: Simple Configuration

Add to your `superset_config.py`:

```python
# Enable authentication
MCP_AUTH_ENABLED = True

# JWT settings
MCP_JWKS_URI = "https://auth.company.com/.well-known/jwks.json"
MCP_JWT_ISSUER = "https://auth.company.com/"
MCP_JWT_AUDIENCE = "superset-mcp-api"
MCP_REQUIRED_SCOPES = ["dashboard:read", "chart:read"]

# Optional: User resolution
MCP_JWT_USER_CLAIM = "sub"              # JWT claim for username (default: "sub")
MCP_JWT_EMAIL_CLAIM = "email"           # JWT claim for email (default: "email")
MCP_FALLBACK_USER = "admin"             # Fallback user if JWT user not found
```

### Option 2: Custom Factory

For advanced authentication requirements:

```python
def create_custom_mcp_auth(app):
    """Custom auth factory for enterprise environments."""
    from fastmcp.server.auth.providers.bearer import BearerAuthProvider

    return BearerAuthProvider(
        jwks_uri=app.config["MCP_JWKS_URI"],
        issuer=app.config["MCP_JWT_ISSUER"],
        audience=app.config["MCP_JWT_AUDIENCE"],
        required_scopes=app.config.get("MCP_REQUIRED_SCOPES", []),
        user_resolver=custom_user_resolver,
        cache_ttl=300  # Cache JWKS for 5 minutes
    )

MCP_AUTH_FACTORY = create_custom_mcp_auth
```

### Option 3: Environment Variables

For containerized deployments:

```bash
# Environment variables
export MCP_AUTH_ENABLED=true
export MCP_JWKS_URI=https://auth.company.com/.well-known/jwks.json
export MCP_JWT_ISSUER=https://auth.company.com/
export MCP_JWT_AUDIENCE=superset-mcp-api
export MCP_REQUIRED_SCOPES=dashboard:read,chart:read,dataset:read
```

## Identity Provider Integration

### Auth0

```python
# Auth0 configuration
MCP_JWKS_URI = "https://your-tenant.auth0.com/.well-known/jwks.json"
MCP_JWT_ISSUER = "https://your-tenant.auth0.com/"
MCP_JWT_AUDIENCE = "superset-mcp-api"
```

### Okta

```python
# Okta configuration
MCP_JWKS_URI = "https://your-org.okta.com/oauth2/default/v1/keys"
MCP_JWT_ISSUER = "https://your-org.okta.com/oauth2/default"
MCP_JWT_AUDIENCE = "api://superset-mcp"
```

### AWS Cognito

```python
# Cognito configuration
MCP_JWKS_URI = "https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/jwks.json"
MCP_JWT_ISSUER = "https://cognito-idp.{region}.amazonaws.com/{userPoolId}"
MCP_JWT_AUDIENCE = "your-app-client-id"
```

### Azure AD

```python
# Azure AD configuration
MCP_JWKS_URI = "https://login.microsoftonline.com/{tenant}/discovery/v2.0/keys"
MCP_JWT_ISSUER = "https://login.microsoftonline.com/{tenant}/v2.0"
MCP_JWT_AUDIENCE = "api://superset-mcp"
```

## Scope-Based Authorization

### Standard Scopes

The MCP service defines these standard scopes:

| Scope | Description | Required For |
|-------|-------------|--------------|
| `dashboard:read` | Read dashboard information | `list_dashboards`, `get_dashboard_info` |
| `dashboard:write` | Create/modify dashboards | `generate_dashboard`, `add_chart_to_existing_dashboard` |
| `chart:read` | Read chart information | `list_charts`, `get_chart_info`, `get_chart_data` |
| `chart:write` | Create/modify charts | `generate_chart`, `update_chart` |
| `dataset:read` | Read dataset information | `list_datasets`, `get_dataset_info` |
| `instance:read` | Read instance information | `get_superset_instance_info` |

### Custom Scopes

Define custom scopes for specific use cases:

```python
# Custom scope definitions
CUSTOM_MCP_SCOPES = {
    "analytics:export": "Export analytical data",
    "reports:generate": "Generate automated reports",
    "admin:config": "Access administrative configuration"
}

# Map tools to custom scopes
def get_custom_required_scopes(tool_name: str) -> List[str]:
    scope_map = {
        "get_chart_data": ["chart:read", "analytics:export"],
        "generate_dashboard": ["dashboard:write", "reports:generate"],
        "get_superset_instance_info": ["instance:read", "admin:config"]
    }
    return scope_map.get(tool_name, [])

MCP_SCOPE_RESOLVER = get_custom_required_scopes
```

## JWT Token Format

### Required Claims

Your JWT tokens must include these standard claims:

```json
{
  "iss": "https://auth.company.com/",      // Issuer
  "aud": "superset-mcp-api",               // Audience
  "sub": "user@company.com",               // Subject (username)
  "exp": 1704118800,                       // Expiration timestamp
  "iat": 1704115200,                       // Issued at timestamp
  "scope": "dashboard:read chart:read"     // Space-separated scopes
}
```

### Optional Claims

Additional claims for enhanced functionality:

```json
{
  "email": "user@company.com",             // User email
  "name": "John Doe",                      // Full name
  "groups": ["analysts", "sales_team"],    // User groups
  "tenant_id": "company_123",              // Multi-tenant ID
  "role": "analyst"                        // User role
}
```

## Client Integration

### API Client Usage

```python
import requests

# Get JWT token from your identity provider
token = get_jwt_token()

# Call MCP service with Bearer authentication
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

response = requests.post(
    "http://localhost:5008/call_tool",
    headers=headers,
    json={
        "tool": "list_dashboards",
        "arguments": {"search": "sales"}
    }
)

data = response.json()
```

### Claude Desktop with Authentication

For Claude Desktop, the proxy script handles authentication:

```bash
#!/bin/bash
# run_proxy_with_auth.sh

# Get token from environment or file
if [ -f ~/.superset_mcp_token ]; then
    TOKEN=$(cat ~/.superset_mcp_token)
else
    TOKEN=${SUPERSET_MCP_TOKEN}
fi

# Export token for proxy
export MCP_AUTH_TOKEN="$TOKEN"

cd /path/to/superset
source venv/bin/activate
exec fastmcp proxy http://localhost:5008 --auth-header "Authorization: Bearer $TOKEN"
```

## User Resolution

### Default User Resolution

The service maps JWT claims to Superset users:

```python
def default_user_resolver(claims: Dict[str, Any]) -> User:
    """Default user resolution from JWT claims."""

    # Extract username from configurable claim
    username = claims.get(app.config.get("MCP_JWT_USER_CLAIM", "sub"))

    # Find Superset user
    user = security_manager.find_user(username=username)

    if not user:
        # Try email lookup
        email = claims.get(app.config.get("MCP_JWT_EMAIL_CLAIM", "email"))
        if email:
            user = security_manager.find_user(email=email)

    if not user and app.config.get("MCP_FALLBACK_USER"):
        # Use fallback user for development
        user = security_manager.find_user(username=app.config["MCP_FALLBACK_USER"])

    return user
```

### Custom User Resolution

Implement custom user resolution logic:

```python
def custom_user_resolver(claims: Dict[str, Any]) -> User:
    """Custom user resolution for enterprise environments."""

    # Extract custom claims
    employee_id = claims.get("employee_id")
    tenant_id = claims.get("tenant_id")

    # Multi-tenant user lookup
    user = find_user_by_employee_id(employee_id, tenant_id)

    if user:
        # Set additional context
        user.mcp_tenant_id = tenant_id
        user.mcp_groups = claims.get("groups", [])

    return user

# Use custom resolver
MCP_USER_RESOLVER = custom_user_resolver
```

## Security Features

### Token Validation

Comprehensive JWT validation:

- **Signature verification**: RS256 with JWKS key rotation support
- **Expiration checking**: Automatic token expiry validation
- **Audience validation**: Prevents token reuse across services
- **Issuer validation**: Ensures tokens from trusted sources only
- **Scope validation**: Enforces tool-level permissions

### Request Security

- **HTTPS enforcement**: Production deployments should use HTTPS
- **Rate limiting**: Configurable per-user rate limits
- **Request logging**: All authenticated requests logged with user context
- **Input validation**: Comprehensive request schema validation

### Audit Logging

Every tool call is logged with security context:

```json
{
  "timestamp": "2024-01-25T14:30:00Z",
  "user_id": "user@company.com",
  "tool_name": "get_chart_data",
  "source": "mcp",
  "jwt_subject": "user@company.com",
  "jwt_scopes": ["chart:read", "analytics:export"],
  "tenant_id": "company_123",
  "request_id": "req_12345",
  "execution_time": 0.145,
  "status": "success"
}
```

## Testing Authentication

### Generate Test Tokens

For development and testing:

```python
from fastmcp.server.auth.providers.bearer import RSAKeyPair

# Generate test keypair
keypair = RSAKeyPair.generate()
print("Public key:", keypair.public_key)

# Create test token
token = keypair.create_token(
    subject="test@example.com",
    issuer="https://test.example.com",
    audience="superset-mcp-api",
    scopes=["dashboard:read", "chart:read", "dataset:read"],
    expires_in=3600  # 1 hour
)
print("Test token:", token)
```

### Test Configuration

```python
# Test configuration with generated keypair
MCP_AUTH_ENABLED = True
MCP_JWT_PUBLIC_KEY = """-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
-----END PUBLIC KEY-----"""
MCP_JWT_ISSUER = "https://test.example.com"
MCP_JWT_AUDIENCE = "superset-mcp-api"
MCP_FALLBACK_USER = "admin"
```

### Manual Testing

```bash
# Test with curl
curl -X POST http://localhost:5008/call_tool \
  -H "Authorization: Bearer $TEST_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "get_superset_instance_info",
    "arguments": {"include_statistics": true}
  }'
```

## Troubleshooting

### Common Issues

**Token Validation Errors:**
```
Error: Invalid JWT signature
Solution: Verify JWKS_URI is accessible and contains correct keys
```

**User Not Found:**
```
Error: User not found for JWT subject
Solution: Check MCP_JWT_USER_CLAIM configuration and user exists in Superset
```

**Insufficient Scopes:**
```
Error: Missing required scope 'chart:read'
Solution: Update JWT token to include required scopes
```

### Debug Configuration

Enable debug logging for authentication issues:

```python
# Enhanced logging for auth debugging
import logging
logging.getLogger('superset.mcp_service.auth').setLevel(logging.DEBUG)

# Log all JWT validation steps
MCP_AUTH_DEBUG = True
```

This authentication guide provides comprehensive coverage for securing the MCP service in production environments while maintaining development flexibility.
