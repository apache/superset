#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# <<<<<<< HEAD
# version: '3'
# services:
#   superset:
#     container_name: ais-service-superset
#     build:
#       context: .
#       args:
#         SQLALCHEMY_DATABASE_URI: $SQLALCHEMY_DATABASE_URI
#         TENANT: $TENANT
#         STAGE: $STAGE
#         REDIS_ENDPOINT: $REDIS_ENDPOINT
#         NO_OF_WORKERS: $NO_OF_WORKERS
#         ADMIN_EMAIL: $ADMIN_EMAIL
#         ADMIN_PASSWORD: $ADMIN_PASSWORD
#         GUEST_EMAIL: $GUEST_EMAIL
#         GUEST_PASSWORD: $GUEST_PASSWORD
#         PEAK_USER_EMAIL: $PEAK_USER_EMAIL
#         PEAK_USER_PASSWORD: $PEAK_USER_PASSWORD
#         PEAK_ADMIN_EMAIL: $PEAK_ADMIN_EMAIL
#         PEAK_ADMIN_PASSWORD: $PEAK_ADMIN_PASSWORD
#         SUPERSET_ENV: $SUPERSET_ENV
#     restart: always
#     environment:
#         AWS_PROFILE: peak-dev
#         AWS_REGION: eu-west-1
#     env_file:
#       - .env
#     ports:
#       - 8088:8088
#     volumes:
#       - .:/home/superset
#       - $HOME/.aws:/root/.aws
#     tty: true
# =======

x-superset-image: &superset-image superset-custom
# x-superset-depends-on: &superset-depends-on
#   - db
#   - redis
x-superset-volumes: &superset-volumes
  # /app/pythonpath_docker will be appended to the PYTHONPATH in the final container
  - ./docker:/app/docker
  - ./superset:/app/superset
  - ./superset-frontend:/app/superset-frontend
  - superset_home:/app/superset_home
  - ./tests:/app/tests
  - $HOME/.aws:/root/.aws

version: "3.7"
services:
  superset:
    env_file: docker/.env
    image: *superset-image
    container_name: superset_app
    command: ["/app/docker/docker-bootstrap.sh", "app"]
    restart: unless-stopped
    ports:
      - 8088:8088
    user: "root"
    # depends_on: *superset-depends-on
    volumes: *superset-volumes
    environment:
      CYPRESS_CONFIG: "${CYPRESS_CONFIG}"

  superset-init:
    image: *superset-image
    container_name: superset_init
    command: ["/app/docker/docker-init.sh"]
    env_file: docker/.env
    # depends_on: *superset-depends-on
    user: "root"
    volumes: *superset-volumes
    environment:
      CYPRESS_CONFIG: "${CYPRESS_CONFIG}"

  superset-node:
    image: node:14
    container_name: superset_node
    command: ["/app/docker/docker-frontend.sh"]
    env_file: docker/.env
    # depends_on: *superset-depends-on
    volumes: *superset-volumes

  # superset-worker:
  #   image: *superset-image
  #   container_name: superset_worker
  #   command: ["/app/docker/docker-bootstrap.sh", "worker"]
  #   env_file: docker/.env
  #   restart: unless-stopped
  #   # depends_on: *superset-depends-on
  #   user: "root"
  #   volumes: *superset-volumes

  # superset-worker-beat:
  #   image: *superset-image
  #   container_name: superset_worker_beat
  #   command: ["/app/docker/docker-bootstrap.sh", "beat"]
  #   env_file: docker/.env
  #   restart: unless-stopped
  #   # depends_on: *superset-depends-on
  #   user: "root"
  #   volumes: *superset-volumes
volumes:
  superset_home:
    external: false
# >>>>>>> f506bad12589b849e0fabf7f757f6edb2d50c9ab
