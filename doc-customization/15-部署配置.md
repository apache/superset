# Apache Superset 部署配置

## 1. 部署概述

### 1.1 部署方式

Apache Superset 支持多种部署方式：

| 部署方式 | 适用场景 | 优点 | 缺点 |
|---------|---------|------|------|
| **Docker** | 开发、测试、小规模生产 | 简单快速、环境一致 | 资源开销较大 |
| **Docker Compose** | 中小规模生产 | 易于管理、可扩展 | 单机部署 |
| **Kubernetes** | 大规模生产 | 高可用、自动扩缩容 | 配置复杂 |
| **传统部署** | 特定环境 | 灵活可控 | 手动配置 |

### 1.2 部署架构

```
部署架构
├── Web 层
│   ├── Nginx (反向代理)
│   └── Gunicorn (WSGI 服务器)
├── 应用层
│   ├── Superset (Flask 应用)
│   ├── Celery (异步任务)
│   └── Redis (缓存/消息队列)
├── 数据层
│   ├── PostgreSQL (元数据存储)
│   └── 数据源 (业务数据)
└── 监控层
    ├── Prometheus (监控)
    ├── Grafana (可视化)
    └── ELK (日志)
```

## 2. Docker 部署

### 2.1 Dockerfile

[Dockerfile](../Dockerfile) 定义了 Docker 镜像构建：

```dockerfile
FROM python:3.11-slim

# 设置环境变量
ENV PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    CRYPTOGRAPHY_DONT_BUILD_RUST=1

# 安装系统依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        default-libmysqlclient-dev \
        libsasl2-dev \
        libldap2-dev \
        libpq-dev \
        libxml2-dev \
        libxslt-dev \
        libgeos-dev \
        libspatialindex-dev \
        binutils \
        libproj-dev \
        gdal-bin \
        && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt requirements-dev.txt setup.py pyproject.toml ./

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY superset superset
COPY superset-frontend/package.json superset-frontend/package.json
COPY superset-frontend/yarn.lock superset-frontend/yarn.lock
COPY superset-frontend/tsconfig.json superset-frontend/tsconfig.json

# 构建前端
WORKDIR /app/superset-frontend
RUN npm install -g yarn && \
    yarn install && \
    yarn build-fixed

# 设置工作目录
WORKDIR /app

# 暴露端口
EXPOSE 8088

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8088/health || exit 1

# 启动命令
CMD ["gunicorn", \
     "--bind", "0.0.0.0:8088", \
     "--access-logfile", "-", \
     "--error-logfile", "-", \
     "--workers", "4", \
     "--worker-class", "sync", \
     "--timeout", "120", \
     "superset.app:create_app()"]
```

### 2.2 Docker Compose

[docker-compose.yml](../docker-compose.yml) 定义了多容器编排：

```yaml
version: '3.8'

services:
  # PostgreSQL 数据库
  db:
    image: postgres:16
    container_name: superset_db
    environment:
      POSTGRES_USER: superset
      POSTGRES_PASSWORD: superset
      POSTGRES_DB: superset
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superset"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7
    container_name: superset_redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Superset Web
  superset:
    build: .
    container_name: superset_app
    command: >
      sh -c "
      superset db upgrade &&
      superset fab create-admin \
        --username admin \
        --firstname Admin \
        --lastname User \
        --email admin@superset.com \
        --password admin &&
      superset init &&
      gunicorn --bind 0.0.0.0:8088 \
        --access-logfile - \
        --error-logfile - \
        --workers 4 \
        --worker-class sync \
        --timeout 120 \
        'superset.app:create_app()'
      "
    ports:
      - "8088:8088"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SUPERSET_SECRET_KEY: 'your-secret-key'
      SUPERSET_LOAD_EXAMPLES: 'yes'
      DATABASE_DIALECT: postgresql
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_DB: superset
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./superset_home:/app/superset_home

  # Superset Celery Worker
  superset-worker:
    build: .
    container_name: superset_worker
    command: >
      celery --app=superset.tasks.celery_app:app worker
        --loglevel=info
    depends_on:
      - db
      - redis
    environment:
      SUPERSET_SECRET_KEY: 'your-secret-key'
      DATABASE_DIALECT: postgresql
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_DB: superset
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./superset_home:/app/superset_home

  # Superset Celery Beat
  superset-beat:
    build: .
    container_name: superset_beat
    command: >
      celery --app=superset.tasks.celery_app:app beat
        --loglevel=info
    depends_on:
      - db
      - redis
    environment:
      SUPERSET_SECRET_KEY: 'your-secret-key'
      DATABASE_DIALECT: postgresql
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_DB: superset
      DATABASE_USER: superset
      DATABASE_PASSWORD: superset
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./superset_home:/app/superset_home

volumes:
  db_data:
```

### 2.3 使用 Docker Compose 部署

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 停止服务并删除数据
docker-compose down -v
```

## 3. Kubernetes 部署

### 3.1 Helm Charts

[helm/superset](../helm/superset/) 目录包含 Kubernetes 部署配置：

```yaml
# helm/superset/values.yaml
replicaCount: 3

image:
  repository: apache/superset
  tag: latest
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer
  port: 8088

ingress:
  enabled: true
  annotations:
    kubernetes.io/ingress.class: nginx
  hosts:
    - host: superset.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: superset-tls
      hosts:
        - superset.example.com

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

postgresql:
  enabled: true
  auth:
    username: superset
    password: superset
    database: superset
  primary:
    persistence:
      enabled: true
      size: 10Gi

redis:
  enabled: true
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      size: 5Gi

celery:
  enabled: true
  replicaCount: 2

config:
  secretKey: your-secret-key
  loadExamples: yes
  database:
    dialect: postgresql
    host: superset-postgresql
    port: 5432
    db: superset
    user: superset
    password: superset
  redis:
    host: superset-redis-master
    port: 6379
```

### 3.2 部署到 Kubernetes

```bash
# 添加 Helm 仓库
helm repo add superset https://apache.github.io/superset
helm repo update

# 安装 Superset
helm install superset superset/superset -f values.yaml

# 查看部署状态
kubectl get pods -l app=superset

# 查看 Service
kubectl get svc superset

# 查看 Ingress
kubectl get ingress superset

# 升级部署
helm upgrade superset superset/superset -f values.yaml

# 卸载部署
helm uninstall superset
```

## 4. 配置文件

### 4.1 主配置文件

[config.py](../config.py) 是 Superset 的主配置文件：

```python
from superset import config

# Flask 配置
SECRET_KEY = 'your-secret-key-here'
DEBUG = False
TESTING = False

# 数据库配置
SQLALCHEMY_DATABASE_URI = 'postgresql://superset:superset@localhost:5432/superset'
SQLALCHEMY_TRACK_MODIFICATIONS = False

# 缓存配置
CACHE_CONFIG = {
    'CACHE_TYPE': 'redis',
    'CACHE_REDIS_URL': 'redis://localhost:6379/0',
    'CACHE_DEFAULT_TIMEOUT': 3600,
}

# Celery 配置
CELERY_BROKER_URL = 'redis://localhost:6379/1'
CELERY_RESULT_BACKEND = 'redis://localhost:6379/2'
CELERY_CONFIG = 'superset.config'

# Web 服务器配置
SUPERSET_WEBSERVER_PORT = 8088
SUPERSET_WEBSERVER_TIMEOUT = 120

# 日志配置
LOG_LEVEL = 'INFO'
LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'

# 文件上传配置
UPLOAD_FOLDER = '/app/superset_home/uploads'
MAX_UPLOAD_SIZE = 16 * 1024 * 1024  # 16MB

# CSV 导入配置
CSV_EXPORT = {
    'encoding': 'utf-8',
}

# 启用示例数据
LOAD_EXAMPLES = True

# 启用 CORS
ENABLE_PROXY_FIX = True

# 启用时间序列缓存
ENABLE_TIME_SERIES_EXTRA_CACHING = True

# 启用查询结果缓存
ENABLE_CACHE_HEADERS = True

# 启用图表数据缓存
SUPERSET_CACHE_TIMEOUT = 3600

# 启用 SQL Lab
ENABLE_PROXY_FIX = True

# 启用嵌入式 SDK
SUPERSET_EMBEDDED_SDK = True

# 启用扩展
SUPERSET_EXTENSIONS = {
    'my_extension': {
        'enabled': True,
        'config': {},
    },
}
```

### 4.2 环境变量配置

```bash
# .env 文件
SUPERSET_SECRET_KEY=your-secret-key-here
SUPERSET_LOAD_EXAMPLES=yes

# 数据库配置
DATABASE_DIALECT=postgresql
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_DB=superset
DATABASE_USER=superset
DATABASE_PASSWORD=superset

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Celery 配置
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2

# Web 服务器配置
SUPERSET_WEBSERVER_PORT=8088
SUPERSET_WEBSERVER_TIMEOUT=120

# 日志配置
LOG_LEVEL=INFO

# 文件上传配置
UPLOAD_FOLDER=/app/superset_home/uploads
MAX_UPLOAD_SIZE=16777216
```

## 5. 生产环境配置

### 5.1 Nginx 反向代理

```nginx
# /etc/nginx/conf.d/superset.conf
upstream superset {
    least_conn;
    server superset1:8088;
    server superset2:8088;
    server superset3:8088;
}

server {
    listen 80;
    server_name superset.example.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name superset.example.com;

    # SSL 证书
    ssl_certificate /etc/nginx/ssl/superset.crt;
    ssl_certificate_key /etc/nginx/ssl/superset.key;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 日志
    access_log /var/log/nginx/superset_access.log;
    error_log /var/log/nginx/superset_error.log;

    # 代理配置
    location / {
        proxy_pass http://superset;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时配置
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # WebSocket 支持
    location /ws {
        proxy_pass http://superset;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时配置
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # 静态文件
    location /static/ {
        alias /app/superset/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 5.2 Gunicorn 配置

```python
# gunicorn_config.py
import multiprocessing

# 服务器配置
bind = '0.0.0.0:8088'
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = 'sync'
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 50
timeout = 120
keepalive = 5

# 日志配置
accesslog = '-'
errorlog = '-'
loglevel = 'info'
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# 进程配置
daemon = False
pidfile = '/var/run/gunicorn.pid'
user = 'superset'
group = 'superset'
umask = 0o007

# 安全配置
limit_request_line = 4096
limit_request_fields = 100
limit_request_field_size = 8190

# 性能配置
preload_app = True
sendfile = True
reuse_port = True
```

### 5.3 PostgreSQL 配置

```ini
# postgresql.conf
# 连接配置
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 1310kB
min_wal_size = 1GB
max_wal_size = 4GB

# 日志配置
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_statement = 'all'
log_duration = on
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 性能配置
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all
```

### 5.4 Redis 配置

```ini
# redis.conf
# 网络配置
bind 0.0.0.0
port 6379
protected-mode no

# 持久化配置
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec

# 内存配置
maxmemory 2gb
maxmemory-policy allkeys-lru

# 日志配置
loglevel notice
logfile /var/log/redis/redis.log

# 性能配置
tcp-keepalive 300
tcp-backlog 511
timeout 0
```

## 6. 监控和日志

### 6.1 Prometheus 监控

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'superset'
    static_configs:
      - targets: ['superset:8088']
    metrics_path: '/metrics'

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

### 6.2 Grafana 仪表板

```json
{
  "dashboard": {
    "title": "Superset Dashboard",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(superset_requests_total[5m])"
          }
        ]
      },
      {
        "title": "Response Time",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(superset_request_duration_seconds_bucket[5m]))"
          }
        ]
      },
      {
        "title": "Database Connections",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends"
          }
        ]
      }
    ]
  }
}
```

### 6.3 ELK 日志

```yaml
# filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/superset/*.log
    fields:
      app: superset
    fields_under_root: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  indices:
    - index: "superset-%{+yyyy.MM.dd}"

setup.kibana:
  host: "kibana:5601"
```

## 7. 备份和恢复

### 7.1 数据库备份

```bash
# 备份 PostgreSQL
pg_dump -h localhost -U superset -d superset > backup_$(date +%Y%m%d).sql

# 恢复 PostgreSQL
psql -h localhost -U superset -d superset < backup_20240101.sql

# 使用 pg_dumpall 备份所有数据库
pg_dumpall -h localhost -U superset > backup_all_$(date +%Y%m%d).sql
```

### 7.2 Redis 备份

```bash
# 备份 Redis
redis-cli BGSAVE

# 复制 RDB 文件
cp /var/lib/redis/dump.rdb /backup/dump_$(date +%Y%m%d).rdb

# 恢复 Redis
cp /backup/dump_20240101.rdb /var/lib/redis/dump.rdb
systemctl restart redis
```

### 7.3 自动备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份 PostgreSQL
pg_dump -h localhost -U superset -d superset > $BACKUP_DIR/superset_$DATE.sql

# 备份 Redis
redis-cli BGSAVE
cp /var/lib/redis/dump.rdb $BACKUP_DIR/redis_$DATE.rdb

# 删除 7 天前的备份
find $BACKUP_DIR -name "superset_*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "redis_*.rdb" -mtime +7 -delete
```

## 8. 下一步

阅读完本文档后，建议继续学习：

1. [缓存机制](./16-缓存机制.md) - 学习缓存策略
2. [调试指南](./17-调试指南.md) - 学习调试方法
3. [性能优化](./18-性能优化.md) - 学习性能优化
