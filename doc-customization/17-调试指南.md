# Apache Superset 调试指南

## 1. 调试概述

### 1.1 调试工具

Apache Superset 提供了多种调试工具：

| 调试工具 | 用途 | 适用场景 |
|---------|------|---------|
| **日志系统** | 记录运行时信息 | 问题排查、性能分析 |
| **Python 调试器** | 断点调试 | 代码调试、逻辑分析 |
| **浏览器开发者工具** | 前端调试 | UI 问题、网络请求 |
| **SQL Lab** | SQL 查询调试 | 数据查询、性能优化 |
| **性能分析** | 性能瓶颈分析 | 性能优化、资源优化 |

### 1.2 调试流程

```
调试流程
├── 问题识别
│   ├── 日志分析
│   ├── 用户反馈
│   └── 监控告警
├── 问题定位
│   ├── 日志查看
│   ├── 断点调试
│   └── 网络分析
├── 问题分析
│   ├── 代码审查
│   ├── 数据分析
│   └── 性能分析
└── 问题解决
    ├── 代码修复
    ├── 配置调整
    └── 优化改进
```

## 2. 日志系统

### 2.1 日志配置

```python
# config.py
import logging
import logging.config

# 日志配置
LOG_LEVEL = 'INFO'
LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
LOG_DATE_FORMAT = '%Y-%m-%d %H:%M:%S'

# 日志文件配置
LOG_FILE = '/var/log/superset/superset.log'
LOG_MAX_BYTES = 10 * 1024 * 1024  # 10MB
LOG_BACKUP_COUNT = 10

# 日志处理器
LOGGING_CONFIG = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'default': {
            'format': LOG_FORMAT,
            'datefmt': LOG_DATE_FORMAT,
        },
        'detailed': {
            'format': '%(asctime)s - %(name)s - %(levelname)s - %(pathname)s:%(lineno)d - %(message)s',
            'datefmt': LOG_DATE_FORMAT,
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'default',
            'level': LOG_LEVEL,
        },
        'file': {
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': LOG_FILE,
            'maxBytes': LOG_MAX_BYTES,
            'backupCount': LOG_BACKUP_COUNT,
            'formatter': 'detailed',
            'level': LOG_LEVEL,
        },
    },
    'loggers': {
        '': {
            'handlers': ['console', 'file'],
            'level': LOG_LEVEL,
            'propagate': False,
        },
        'superset': {
            'handlers': ['console', 'file'],
            'level': LOG_LEVEL,
            'propagate': False,
        },
        'sqlalchemy': {
            'handlers': ['console', 'file'],
            'level': 'WARNING',
            'propagate': False,
        },
    },
}

# 应用日志配置
logging.config.dictConfig(LOGGING_CONFIG)
```

### 2.2 日志使用

```python
import logging

logger = logging.getLogger(__name__)

class ChartService:
    def get_chart_data(self, chart_id: int):
        logger.info(f"获取图表数据: chart_id={chart_id}")

        try:
            chart = Chart.query.get(chart_id)
            if not chart:
                logger.warning(f"图表不存在: chart_id={chart_id}")
                return None

            logger.debug(f"图表信息: {chart.to_dict()}")
            data = chart.get_data()

            logger.info(f"图表数据获取成功: chart_id={chart_id}, rowcount={len(data)}")
            return data

        except Exception as e:
            logger.error(f"获取图表数据失败: chart_id={chart_id}, error={str(e)}", exc_info=True)
            raise

    def create_chart(self, data: dict):
        logger.info(f"创建图表: data={data}")

        try:
            chart = Chart(**data)
            db.session.add(chart)
            db.session.commit()

            logger.info(f"图表创建成功: chart_id={chart.id}")
            return chart

        except Exception as e:
            logger.error(f"创建图表失败: data={data}, error={str(e)}", exc_info=True)
            db.session.rollback()
            raise
```

### 2.3 日志分析

```bash
# 查看实时日志
tail -f /var/log/superset/superset.log

# 查看错误日志
grep ERROR /var/log/superset/superset.log

# 查看特定图表的日志
grep "chart_id=123" /var/log/superset/superset.log

# 查看最近的错误
tail -n 100 /var/log/superset/superset.log | grep ERROR

# 统计错误数量
grep ERROR /var/log/superset/superset.log | wc -l

# 查看特定时间段的日志
awk '/2024-01-01 10:00/,/2024-01-01 11:00/' /var/log/superset/superset.log
```

## 3. Python 调试器

### 3.1 使用 pdb 调试

```python
import pdb

class ChartService:
    def get_chart_data(self, chart_id: int):
        # 设置断点
        pdb.set_trace()

        chart = Chart.query.get(chart_id)
        if not chart:
            return None

        data = chart.get_data()
        return data
```

### 3.2 使用 ipdb 调试

```python
import ipdb

class ChartService:
    def get_chart_data(self, chart_id: int):
        # 设置断点
        ipdb.set_trace()

        chart = Chart.query.get(chart_id)
        if not chart:
            return None

        data = chart.get_data()
        return data
```

### 3.3 使用 VS Code 调试

```json
// .vscode/launch.json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python: Flask",
            "type": "python",
            "request": "launch",
            "module": "flask",
            "env": {
                "FLASK_APP": "superset.app:create_app",
                "FLASK_ENV": "development"
            },
            "args": [
                "run",
                "--no-debugger",
                "--no-reload"
            ],
            "jinja": true,
            "justMyCode": true
        }
    ]
}
```

### 3.4 调试命令

```python
# 常用调试命令

# 查看当前代码
l (list)

# 查看变量
p variable_name

# 查看所有局部变量
locals()

# 查看所有全局变量
globals()

# 单步执行
n (next)

# 进入函数
s (step)

# 继续执行
c (continue)

# 设置断点
b line_number

# 查看所有断点
b (break)

# 删除断点
cl (clear)

# 查看调用栈
where

# 查看函数参数
a (args)
```

## 4. 前端调试

### 4.1 浏览器开发者工具

```typescript
// 使用 console.log 调试
class Chart extends PureComponent<ChartProps> {
  componentDidMount() {
    console.log('Chart mounted', this.props);
    this.fetchChartData();
  }

  fetchChartData = async () => {
    console.log('Fetching chart data', this.props.chartId);

    try {
      const response = await fetchChartData(this.props.chartId);
      console.log('Chart data received', response);

      this.setState({ data: response.data });
    } catch (error) {
      console.error('Failed to fetch chart data', error);
    }
  };

  render() {
    console.log('Rendering chart', this.state);
    return <div>{/* 渲染图表 */}</div>;
  }
}
```

### 4.2 React DevTools

```typescript
// 安装 React DevTools 浏览器扩展
// https://react.dev/tools/

// 使用 React DevTools 调试
class Chart extends PureComponent<ChartProps> {
  render() {
    return (
      <div>
        <h1>Chart</h1>
        {/* 使用 React DevTools 查看组件树和状态 */}
      </div>
    );
  }
}
```

### 4.3 Redux DevTools

```typescript
// 安装 Redux DevTools 浏览器扩展
// https://github.com/reduxjs/redux-devtools

// 配置 Redux DevTools
import { createStore, applyMiddleware, compose } from 'redux';
import thunk from 'redux-thunk';
import rootReducer from './reducers';

const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;

const store = createStore(
  rootReducer,
  composeEnhancers(applyMiddleware(thunk))
);

export default store;
```

### 4.4 网络请求调试

```typescript
// 使用 Fetch API 调试
async function fetchChartData(chartId: number) {
  console.time('fetchChartData');

  try {
    const response = await fetch(`/api/v1/chart/${chartId}/data`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({}),
    });

    console.log('Response status:', response.status);
    console.log('Response headers:', response.headers);

    const data = await response.json();
    console.log('Response data:', data);

    return data;
  } catch (error) {
    console.error('Fetch error:', error);
    throw error;
  } finally {
    console.timeEnd('fetchChartData');
  }
}
```

## 5. SQL Lab 调试

### 5.1 SQL Lab 使用

```sql
-- 在 SQL Lab 中执行查询
SELECT
    date_trunc('day', created_at) as day,
    COUNT(*) as count
FROM users
WHERE created_at >= '2024-01-01'
GROUP BY day
ORDER BY day;

-- 查看查询执行计划
EXPLAIN
SELECT * FROM users WHERE id = 1;

-- 查看详细执行计划
EXPLAIN ANALYZE
SELECT * FROM users WHERE id = 1;
```

### 5.2 查询性能分析

```sql
-- 查看查询执行时间
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;

-- 查看慢查询
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC;
```

### 5.3 查询优化建议

```sql
-- 查看表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 查看索引使用情况
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;

-- 查看缺失的索引
SELECT
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE schemaname = 'public'
AND n_distinct > 100
ORDER BY n_distinct DESC;
```

## 6. 性能分析

### 6.1 Python 性能分析

```python
import cProfile
import pstats
import io

def profile_function(func):
    """性能分析装饰器"""
    def wrapper(*args, **kwargs):
        pr = cProfile.Profile()
        pr.enable()

        result = func(*args, **kwargs)

        pr.disable()

        # 输出性能分析结果
        s = io.StringIO()
        ps = pstats.Stats(pr, stream=s).sort_stats('cumulative')
        ps.print_stats()
        print(s.getvalue())

        return result
    return wrapper

@profile_function
def get_chart_data(chart_id: int):
    chart = Chart.query.get(chart_id)
    data = chart.get_data()
    return data
```

### 6.2 数据库性能分析

```python
from sqlalchemy import event
from sqlalchemy.engine import Engine
import time
import logging

logger = logging.getLogger(__name__)

@event.listens_for(Engine, "before_cursor_execute")
def before_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    context._query_start_time = time.time()

@event.listens_for(Engine, "after_cursor_execute")
def after_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    total = time.time() - context._query_start_time

    if total > 1.0:  # 超过 1 秒的查询
        logger.warning(f"Slow query: {total:.2f}s - {statement[:100]}")
```

### 6.3 前端性能分析

```typescript
// 使用 Performance API
class PerformanceMonitor {
  static measure(name: string, fn: () => void) {
    const start = performance.now();

    fn();

    const end = performance.now();
    const duration = end - start;

    console.log(`${name}: ${duration.toFixed(2)}ms`);

    return duration;
  }

  static async measureAsync(name: string, fn: () => Promise<void>) {
    const start = performance.now();

    await fn();

    const end = performance.now();
    const duration = end - start;

    console.log(`${name}: ${duration.toFixed(2)}ms`);

    return duration;
  }
}

// 使用示例
PerformanceMonitor.measure('renderChart', () => {
  renderChart();
});

PerformanceMonitor.measureAsync('fetchData', async () => {
  await fetchData();
});
```

## 7. 常见问题调试

### 7.1 数据库连接问题

```python
# 测试数据库连接
from superset.models.core import Database

def test_database_connection(database_id: int):
    try:
        database = Database.query.get(database_id)
        engine = database.get_sqla_engine()

        with engine.connect() as connection:
            connection.execute("SELECT 1")

        print("数据库连接成功")
        return True

    except Exception as e:
        print(f"数据库连接失败: {str(e)}")
        return False

# 使用示例
test_database_connection(1)
```

### 7.2 查询超时问题

```python
# 增加查询超时时间
from superset.models.core import Database

def increase_query_timeout(database_id: int, timeout: int = 120):
    database = Database.query.get(database_id)

    # 更新数据库配置
    database.extra = json.dumps({
        'query_timeout': timeout,
    })

    db.session.commit()

    print(f"查询超时时间已更新为 {timeout} 秒")

# 使用示例
increase_query_timeout(1, 180)
```

### 7.3 内存泄漏问题

```python
# 使用内存分析工具
import tracemalloc

def profile_memory(func):
    """内存分析装饰器"""
    def wrapper(*args, **kwargs):
        tracemalloc.start()

        result = func(*args, **kwargs)

        snapshot = tracemalloc.take_snapshot()
        top_stats = snapshot.statistics('lineno')

        print("[Top 10 memory allocations]")
        for stat in top_stats[:10]:
            print(stat)

        tracemalloc.stop()

        return result
    return wrapper

@profile_memory
def process_large_dataset(dataset_id: int):
    # 处理大数据集
    pass
```

## 8. 调试最佳实践

### 8.1 日志记录

1. **日志级别**
   - DEBUG: 详细的调试信息
   - INFO: 一般信息
   - WARNING: 警告信息
   - ERROR: 错误信息
   - CRITICAL: 严重错误

2. **日志内容**
   - 包含足够的上下文信息
   - 记录关键参数和返回值
   - 使用结构化日志格式

3. **日志性能**
   - 避免在高频路径中记录详细日志
   - 使用异步日志记录
   - 定期清理日志文件

### 8.2 断点调试

1. **断点设置**
   - 在关键逻辑处设置断点
   - 使用条件断点
   - 避免在循环中设置断点

2. **调试技巧**
   - 使用变量监视
   - 查看调用栈
   - 使用表达式求值

3. **调试效率**
   - 使用日志快速定位问题
   - 使用断点深入分析问题
   - 结合使用多种调试方法

### 8.3 性能分析

1. **分析工具**
   - 使用 Python Profiler
   - 使用数据库性能分析
   - 使用浏览器性能分析

2. **优化策略**
   - 识别性能瓶颈
   - 优化慢查询
   - 减少不必要的计算

3. **持续监控**
   - 建立性能基线
   - 监控性能指标
   - 及时发现性能问题

## 9. 下一步

阅读完本文档后，建议继续学习：

1. [性能优化](./18-性能优化.md) - 学习性能优化
2. [部署配置](./15-部署配置.md) - 学习部署和配置
3. [缓存机制](./16-缓存机制.md) - 学习缓存策略
