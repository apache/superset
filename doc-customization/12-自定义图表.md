# Apache Superset 自定义图表

## 1. 自定义图表概述

### 1.1 图表类型

Apache Superset 支持多种图表类型，包括：

| 图表类型 | 描述 | 适用场景 |
|---------|------|---------|
| **折线图** | 显示数据随时间的变化趋势 | 时间序列分析 |
| **柱状图** | 比较不同类别的数据 | 分类数据比较 |
| **饼图** | 显示各部分占整体的比例 | 占比分析 |
| **散点图** | 显示两个变量之间的关系 | 相关性分析 |
| **地图** | 在地理空间上显示数据 | 地理数据可视化 |
| **表格** | 以表格形式展示数据 | 详细数据查看 |
| **透视表** | 多维度数据汇总 | 数据透视分析 |
| **词云** | 显示文本数据的词频 | 文本分析 |

### 1.2 自定义图表架构

```
自定义图表架构
├── 图表组件 (Chart Component)
│   ├── React 组件
│   ├── 可视化库集成 (ECharts/D3.js)
│   └── 数据处理
├── 控制面板 (Control Panel)
│   ├── 数据配置
│   ├── 图表选项
│   └── 自定义选项
├── 插件配置 (Plugin Configuration)
│   ├── 图表类型
│   ├── 元数据
│   └── 缩略图
└── 数据转换 (Data Transformation)
    ├── 数据解析
    ├── 数据聚合
    └── 数据格式化
```

## 2. 创建基础图表

### 2.1 项目结构

```
my-custom-chart/
├── MyChart.tsx              # 图表组件
├── MyChartControlPanel.tsx   # 控制面板
├── transformProps.ts         # 属性转换
├── types.ts                 # 类型定义
└── index.ts                 # 插件导出
```

### 2.2 图表组件

```typescript
import React, { PureComponent } from 'react';
import { ChartProps, ChartData } from '@superset-ui/core';

interface MyChartProps extends ChartProps {
  data: ChartData;
  width: number;
  height: number;
  colorScheme: string;
  showLegend: boolean;
  showTooltip: boolean;
}

interface MyChartState {
  hoveredIndex: number | null;
}

class MyChart extends PureComponent<MyChartProps, MyChartState> {
  state: MyChartState = {
    hoveredIndex: null,
  };

  render() {
    const { data, width, height, colorScheme, showLegend, showTooltip } = this.props;
    const { hoveredIndex } = this.state;

    return (
      <div style={{ width, height, position: 'relative' }}>
        <svg width={width} height={height}>
          {this.renderChart()}
        </svg>
        {showLegend && this.renderLegend()}
        {showTooltip && hoveredIndex !== null && this.renderTooltip()}
      </div>
    );
  }

  renderChart() {
    const { data } = this.props;
    const { records } = data;

    return records.map((record, index) => (
      <g key={index}>
        <rect
          x={record.x}
          y={record.y}
          width={record.width}
          height={record.height}
          fill={this.getColor(index)}
          onMouseEnter={() => this.setState({ hoveredIndex: index })}
          onMouseLeave={() => this.setState({ hoveredIndex: null })}
        />
      </g>
    ));
  }

  renderLegend() {
    const { data } = this.props;
    const { records } = data;

    return (
      <div style={{ position: 'absolute', top: 10, right: 10 }}>
        {records.map((record, index) => (
          <div key={index} style={{ display: 'flex', alignItems: 'center', marginBottom: 5 }}>
            <div
              style={{
                width: 20,
                height: 20,
                backgroundColor: this.getColor(index),
                marginRight: 5,
              }}
            />
            <span>{record.label}</span>
          </div>
        ))}
      </div>
    );
  }

  renderTooltip() {
    const { data } = this.props;
    const { hoveredIndex } = this.state;
    const record = data.records[hoveredIndex];

    return (
      <div
        style={{
          position: 'absolute',
          top: record.y,
          left: record.x + record.width + 10,
          backgroundColor: 'white',
          padding: 10,
          border: '1px solid #ccc',
          borderRadius: 4,
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        }}
      >
        <div><strong>{record.label}</strong></div>
        <div>值: {record.value}</div>
      </div>
    );
  }

  getColor(index: number) {
    const { colorScheme } = this.props;
    const colors = {
      supersetColors: ['#5AC189', '#5BA4CF', '#FFA94D', '#F8746B', '#9D5AC9'],
      googleColors: ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#AB47BC'],
      customColors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'],
    };

    const scheme = colors[colorScheme] || colors.supersetColors;
    return scheme[index % scheme.length];
  }
}

export default MyChart;
```

### 2.3 控制面板

```typescript
import { t } from '@superset-ui/core';

export default {
  controlPanelSections: [
    {
      label: t('Data'),
      expanded: true,
      controlSetRows: [
        ['groupby'],
        ['metrics'],
        ['adhoc_metrics'],
      ],
    },
    {
      label: t('Chart Options'),
      expanded: true,
      controlSetRows: [
        ['color_scheme'],
        ['show_legend'],
        ['show_tooltip'],
      ],
    },
    {
      label: t('Custom Options'),
      expanded: true,
      controlSetRows: [
        ['bar_width'],
        ['bar_gap'],
        ['animation_duration'],
      ],
    },
  ],
};
```

### 2.4 属性转换

```typescript
import { ChartProps, ChartData } from '@superset-ui/core';

export default function transformProps(chartProps: ChartProps) {
  const {
    width,
    height,
    formData,
    queriesData,
    ownState,
  } = chartProps;

  const data: ChartData = {
    records: [],
    coltypes: [],
    rowcount: 0,
  };

  if (queriesData && queriesData[0]) {
    const queryData = queriesData[0];
    data.records = queryData.data || [];
    data.coltypes = queryData.coltypes || [];
    data.rowcount = queryData.rowcount || 0;
  }

  return {
    width,
    height,
    data,
    colorScheme: formData.color_scheme || 'supersetColors',
    showLegend: formData.show_legend !== false,
    showTooltip: formData.show_tooltip !== false,
    barWidth: formData.bar_width || 20,
    barGap: formData.bar_gap || 5,
    animationDuration: formData.animation_duration || 300,
  };
}
```

### 2.5 插件注册

```typescript
import { ChartPlugin } from '@superset-ui/core';
import MyChart from './MyChart';
import controlPanel from './MyChartControlPanel';
import transformProps from './transformProps';

export default new ChartPlugin({
  type: 'my_custom_chart',
  name: 'My Custom Chart',
  description: 'A custom chart plugin for Superset',
  thumbnail: 'images/thumbnails/my-chart.png',
  controlPanel: () => Promise.resolve(controlPanel),
  loadChart: () => Promise.resolve(MyChart),
  transformProps,
  metadata: {
    canBeUserSpecific: true,
    showNoResults: true,
    isTimeseries: false,
  },
});
```

## 3. 使用 ECharts 创建图表

### 3.1 ECharts 图表组件

```typescript
import React, { PureComponent } from 'react';
import * as echarts from 'echarts';
import { ChartProps, ChartData } from '@superset-ui/core';

interface EChartsProps extends ChartProps {
  data: ChartData;
  width: number;
  height: number;
  echartOptions: Record<string, unknown>;
}

class EchartsBarChart extends PureComponent<EChartsProps> {
  chartRef: React.RefObject<HTMLDivElement>;
  chartInstance: echarts.ECharts | null = null;

  constructor(props: EChartsProps) {
    super(props);
    this.chartRef = React.createRef();
  }

  componentDidMount() {
    if (this.chartRef.current) {
      this.chartInstance = echarts.init(this.chartRef.current);
      this.updateChart();

      // 响应窗口大小变化
      window.addEventListener('resize', this.handleResize);
    }
  }

  componentDidUpdate(prevProps: EChartsProps) {
    if (
      prevProps.data !== this.props.data ||
      prevProps.echartOptions !== this.props.echartOptions ||
      prevProps.width !== this.props.width ||
      prevProps.height !== this.props.height
    ) {
      this.updateChart();
    }
  }

  componentWillUnmount() {
    if (this.chartInstance) {
      this.chartInstance.dispose();
      window.removeEventListener('resize', this.handleResize);
    }
  }

  handleResize = () => {
    if (this.chartInstance) {
      this.chartInstance.resize();
    }
  };

  updateChart() {
    if (!this.chartInstance) return;

    const { data, echartOptions, width, height } = this.props;
    const option = this.getOption(data, echartOptions);

    this.chartInstance.setOption(option, true);
    this.chartInstance.resize({ width, height });
  }

  getOption(data: ChartData, echartOptions: Record<string, unknown>) {
    const { records } = data;
    const categories = records.map(r => r.category);
    const values = records.map(r => r.value);

    return {
      ...echartOptions,
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'shadow',
        },
      },
      xAxis: {
        type: 'category',
        data: categories,
        axisLabel: {
          rotate: 45,
        },
      },
      yAxis: {
        type: 'value',
      },
      series: [{
        data: values,
        type: 'bar',
        itemStyle: {
          color: (params: any) => {
            const colors = ['#5AC189', '#5BA4CF', '#FFA94D', '#F8746B', '#9D5AC9'];
            return colors[params.dataIndex % colors.length];
          },
        },
      }],
    };
  }

  render() {
    const { width, height } = this.props;

    return (
      <div
        ref={this.chartRef}
        style={{ width, height }}
      />
    );
  }
}

export default EchartsBarChart;
```

### 3.2 ECharts 控制面板

```typescript
import { t } from '@superset-ui/core';

export default {
  controlPanelSections: [
    {
      label: t('Data'),
      expanded: true,
      controlSetRows: [
        ['groupby'],
        ['metrics'],
        ['adhoc_metrics'],
      ],
    },
    {
      label: t('Chart Options'),
      expanded: true,
      controlSetRows: [
        ['color_scheme'],
        ['x_axis_label'],
        ['y_axis_label'],
      ],
    },
    {
      label: t('ECharts Options'),
      expanded: true,
      controlSetRows: [
        ['show_tooltip'],
        ['show_data_zoom'],
        ['show_toolbox'],
      ],
    },
  ],
};
```

## 4. 使用 D3.js 创建图表

### 4.1 D3.js 图表组件

```typescript
import React, { PureComponent } from 'react';
import * as d3 from 'd3';
import { ChartProps, ChartData } from '@superset-ui/core';

interface D3ChartProps extends ChartProps {
  data: ChartData;
  width: number;
  height: number;
  margin: { top: number; right: number; bottom: number; left: number };
}

class D3ScatterPlot extends PureComponent<D3ChartProps> {
  svgRef: React.RefObject<SVGSVGElement>;
  tooltipRef: React.RefObject<HTMLDivElement>;

  constructor(props: D3ChartProps) {
    super(props);
    this.svgRef = React.createRef();
    this.tooltipRef = React.createRef();
  }

  componentDidMount() {
    this.renderChart();
  }

  componentDidUpdate() {
    this.renderChart();
  }

  renderChart() {
    if (!this.svgRef.current) return;

    const { data, width, height, margin } = this.props;
    const { records } = data;

    // 清空 SVG
    d3.select(this.svgRef.current).selectAll('*').remove();

    // 计算绘图区域
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    // 创建比例尺
    const xScale = d3.scaleLinear()
      .domain([0, d3.max(records, (d: any) => d.x) || 0])
      .range([0, innerWidth]);

    const yScale = d3.scaleLinear()
      .domain([0, d3.max(records, (d: any) => d.y) || 0])
      .range([innerHeight, 0]);

    const radiusScale = d3.scaleSqrt()
      .domain([0, d3.max(records, (d: any) => d.r) || 0])
      .range([5, 20]);

    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    // 创建 SVG 元素
    const svg = d3.select(this.svgRef.current)
      .attr('width', width)
      .attr('height', height);

    // 创建绘图区域
    const g = svg.append('g')
      .attr('transform', `translate(${margin.left}, ${margin.top})`);

    // 绘制坐标轴
    g.append('g')
      .attr('transform', `translate(0, ${innerHeight})`)
      .call(d3.axisBottom(xScale));

    g.append('g')
      .call(d3.axisLeft(yScale));

    // 绘制数据点
    g.selectAll('circle')
      .data(records)
      .enter()
      .append('circle')
      .attr('cx', (d: any) => xScale(d.x))
      .attr('cy', (d: any) => yScale(d.y))
      .attr('r', (d: any) => radiusScale(d.r))
      .attr('fill', (d: any, i: number) => colorScale(i.toString()))
      .attr('opacity', 0.7)
      .on('mouseover', (event: any, d: any) => this.showTooltip(event, d))
      .on('mouseout', () => this.hideTooltip());
  }

  showTooltip(event: any, data: any) {
    if (!this.tooltipRef.current) return;

    const tooltip = d3.select(this.tooltipRef.current);
    tooltip
      .style('left', `${event.pageX + 10}px`)
      .style('top', `${event.pageY - 10}px`)
      .style('opacity', 1)
      .html(`
        <div><strong>X:</strong> ${data.x}</div>
        <div><strong>Y:</strong> ${data.y}</div>
        <div><strong>Radius:</strong> ${data.r}</div>
      `);
  }

  hideTooltip() {
    if (!this.tooltipRef.current) return;

    d3.select(this.tooltipRef.current)
      .style('opacity', 0);
  }

  render() {
    const { width, height } = this.props;

    return (
      <div style={{ position: 'relative' }}>
        <svg
          ref={this.svgRef}
          width={width}
          height={height}
        />
        <div
          ref={this.tooltipRef}
          style={{
            position: 'absolute',
            padding: '10px',
            backgroundColor: 'white',
            border: '1px solid #ccc',
            borderRadius: '4px',
            pointerEvents: 'none',
            opacity: 0,
            transition: 'opacity 0.2s',
          }}
        />
      </div>
    );
  }
}

export default D3ScatterPlot;
```

## 5. 高级图表功能

### 5.1 交互功能

```typescript
import React, { PureComponent } from 'react';
import * as echarts from 'echarts';
import { ChartProps, ChartData } from '@superset-ui/core';

class InteractiveChart extends PureComponent<ChartProps> {
  chartRef: React.RefObject<HTMLDivElement>;
  chartInstance: echarts.ECharts | null = null;

  constructor(props: ChartProps) {
    super(props);
    this.chartRef = React.createRef();
  }

  componentDidMount() {
    if (this.chartRef.current) {
      this.chartInstance = echarts.init(this.chartRef.current);
      this.updateChart();
      this.setupInteractions();
    }
  }

  setupInteractions() {
    if (!this.chartInstance) return;

    // 点击事件
    this.chartInstance.on('click', (params: any) => {
      console.log('Clicked:', params);
      this.props.onChartClick?.(params);
    });

    // 双击事件
    this.chartInstance.on('dblclick', (params: any) => {
      console.log('Double clicked:', params);
      this.props.onChartDoubleClick?.(params);
    });

    // 鼠标悬停事件
    this.chartInstance.on('mouseover', (params: any) => {
      console.log('Mouse over:', params);
      this.props.onChartHover?.(params);
    });

    // 图例选择事件
    this.chartInstance.on('legendselectchanged', (params: any) => {
      console.log('Legend changed:', params);
      this.props.onLegendChange?.(params);
    });
  }

  updateChart() {
    if (!this.chartInstance) return;

    const { data } = this.props;
    const option = this.getOption(data);

    this.chartInstance.setOption(option);
  }

  getOption(data: ChartData) {
    return {
      tooltip: {
        trigger: 'axis',
      },
      xAxis: {
        type: 'category',
        data: data.records.map(r => r.x),
      },
      yAxis: {
        type: 'value',
      },
      series: [{
        data: data.records.map(r => r.y),
        type: 'line',
      }],
    };
  }

  render() {
    const { width, height } = this.props;

    return (
      <div
        ref={this.chartRef}
        style={{ width, height }}
      />
    );
  }
}

export default InteractiveChart;
```

### 5.2 动画效果

```typescript
import React, { PureComponent } from 'react';
import * as echarts from 'echarts';
import { ChartProps, ChartData } from '@superset-ui/core';

class AnimatedChart extends PureComponent<ChartProps> {
  chartRef: React.RefObject<HTMLDivElement>;
  chartInstance: echarts.ECharts | null = null;

  componentDidMount() {
    if (this.chartRef.current) {
      this.chartInstance = echarts.init(this.chartRef.current);
      this.updateChart();
    }
  }

  updateChart() {
    if (!this.chartInstance) return;

    const { data } = this.props;
    const option = this.getOption(data);

    this.chartInstance.setOption(option);
  }

  getOption(data: ChartData) {
    return {
      animation: true,
      animationDuration: 1000,
      animationEasing: 'cubicOut',
      animationDelay: (idx: number) => idx * 100,
      tooltip: {
        trigger: 'axis',
      },
      xAxis: {
        type: 'category',
        data: data.records.map(r => r.x),
      },
      yAxis: {
        type: 'value',
      },
      series: [{
        data: data.records.map(r => r.y),
        type: 'bar',
        animationDelay: (idx: number) => idx * 100,
      }],
    };
  }

  render() {
    const { width, height } = this.props;

    return (
      <div
        ref={this.chartRef}
        style={{ width, height }}
      />
    );
  }
}

export default AnimatedChart;
```

### 5.3 数据更新

```typescript
import React, { PureComponent } from 'react';
import * as echarts from 'echarts';
import { ChartProps, ChartData } from '@superset-ui/core';

class DynamicChart extends PureComponent<ChartProps> {
  chartRef: React.RefObject<HTMLDivElement>;
  chartInstance: echarts.ECharts | null = null;
  intervalId: NodeJS.Timeout | null = null;

  componentDidMount() {
    if (this.chartRef.current) {
      this.chartInstance = echarts.init(this.chartRef.current);
      this.updateChart();
      this.startAutoUpdate();
    }
  }

  componentWillUnmount() {
    this.stopAutoUpdate();
    if (this.chartInstance) {
      this.chartInstance.dispose();
    }
  }

  startAutoUpdate() {
    this.intervalId = setInterval(() => {
      this.props.onRefresh?.();
    }, 5000); // 每 5 秒刷新一次
  }

  stopAutoUpdate() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  updateChart() {
    if (!this.chartInstance) return;

    const { data } = this.props;
    const option = this.getOption(data);

    this.chartInstance.setOption(option, true);
  }

  getOption(data: ChartData) {
    return {
      tooltip: {
        trigger: 'axis',
      },
      xAxis: {
        type: 'category',
        data: data.records.map(r => r.x),
      },
      yAxis: {
        type: 'value',
      },
      series: [{
        data: data.records.map(r => r.y),
        type: 'line',
        smooth: true,
      }],
    };
  }

  render() {
    const { width, height } = this.props;

    return (
      <div
        ref={this.chartRef}
        style={{ width, height }}
      />
    );
  }
}

export default DynamicChart;
```

## 6. 图表最佳实践

### 6.1 性能优化

1. **虚拟化渲染**
   - 使用虚拟滚动处理大数据集
   - 实现数据分页和懒加载
   - 使用 Web Workers 处理复杂计算

2. **内存管理**
   - 及时清理不需要的 DOM 元素
   - 避免内存泄漏
   - 使用对象池复用对象

3. **渲染优化**
   - 使用 React.memo 避免不必要的重渲染
   - 使用 useMemo 和 useCallback 缓存计算结果
   - 使用 requestAnimationFrame 优化动画

### 6.2 可访问性

1. **键盘导航**
   - 支持键盘快捷键
   - 实现焦点管理
   - 提供键盘操作提示

2. **屏幕阅读器**
   - 添加 ARIA 属性
   - 提供文本替代
   - 支持屏幕阅读器导航

3. **对比度**
   - 确保足够的颜色对比度
   - 支持高对比度模式
   - 提供颜色主题切换

### 6.3 错误处理

1. **错误边界**
   - 使用 React Error Boundary 捕获错误
   - 提供友好的错误提示
   - 实现错误恢复机制

2. **数据验证**
   - 验证输入数据格式
   - 处理缺失数据
   - 提供默认值

3. **日志记录**
   - 记录错误信息
   - 监控性能指标
   - 收集用户反馈

## 7. 下一步

阅读完本文档后，建议继续学习：

1. [插件系统](./11-插件系统.md) - 学习插件系统架构
2. [自定义数据源](./13-自定义数据源.md) - 学习如何添加自定义数据源
3. [可视化组件](./10-可视化组件.md) - 学习可视化组件
