# Apache Superset 架构概览

## 1. 整体架构

Apache Superset 是一个现代化的企业级商业智能 Web 应用，采用前后端分离的架构设计。

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Client Layer                        │
│              (Browser / Mobile / Embedded)               │
└────────────────────────┬────────────────────────────────┘
                       │ HTTP/HTTPS
┌────────────────────────▼────────────────────────────────┐
│                   Frontend Layer                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │         React Application (SPA)                  │  │
│  │  - Component Library (Ant Design)                │  │
│  │  - State Management (Redux)                     │  │
│  │  - Chart Visualization (D3/ECharts)           │  │
│  │  - Plugin System                               │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────┘
                       │ REST API / WebSocket
┌────────────────────────▼────────────────────────────────┐
│                   Backend Layer                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Flask Application                        │  │
│  │  - REST API Endpoints                         │  │
│  │  - Authentication & Authorization             │  │
│  │  - Security Manager (Flask-AppBuilder)        │  │
│  │  - Celery Task Queue                         │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Business Logic Layer                    │  │
│  │  - Query Engine                              │  │
│  │  - Data Processing                           │  │
│  │  - Cache Manager                             │  │
│  │  - Command Pattern (Commands)                 │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │         Data Access Layer                      │  │
│  │  - SQLAlchemy ORM                           │  │
│  │  - Database Engine Specs                      │  │
│  │  - Connection Pooling                        │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────┘
                       │ SQL / Native Protocols
┌────────────────────────▼────────────────────────────────┐
│                 Data Sources Layer                     │
│  ┌────────┬────────┬────────┬────────┬────────┐    │
│  │Postgres│ MySQL  │Oracle  │ClickHouse│ ... │    │
│  └────────┴────────┴────────┴────────┴────────┘    │
│  ┌────────┬────────┬────────┬────────┬────────┐    │
│  │BigQuery│Snowflake│Redshift│  Druid │ ... │    │
│  └────────┴────────┴────────┴────────┴────────┘    │
└────────────────────────────────────────────────────────────┘
```

### 1.2 架构特点

#### 前后端分离
- **前端**: React + TypeScript 单页应用 (SPA)
- **后端**: Flask REST API 服务
- **通信**: RESTful API + WebSocket (实时更新)

#### 插件化架构
- **图表插件**: 可扩展的图表类型系统
- **数据源插件**: 支持多种数据库连接器
- **认证插件**: 灵活的认证方式集成

#### 云原生设计
- **容器化**: Docker 支持便于部署
- **可扩展**: 水平扩展支持高并发
- **缓存**: 多层缓存提升性能

## 2. 核心组件

### 2.1 前端组件

#### React 应用
- **框架**: React 17 + TypeScript
- **路由**: React Router 5
- **UI 库**: Ant Design 5
- **状态管理**: Redux + Redux Toolkit
- **可视化**: D3.js, ECharts, Mapbox GL

#### 插件系统
```
superset-frontend/
├── plugins/
│   ├── plugin-chart-echarts/      # ECharts 图表插件
│   ├── plugin-chart-table/         # 表格图表插件
│   ├── plugin-chart-pivot-table/   # 透视表插件
│   ├── legacy-preset-chart-nvd3/   # NVD3 图表插件
│   └── legacy-preset-chart-deckgl/# Deck.GL 地图插件
└── packages/
    ├── superset-ui-core/           # 核心 UI 组件
    ├── superset-ui-chart-controls/ # 图表控制组件
    └── superset-ui-switchboard/   # 开关板组件
```

### 2.2 后端组件

#### Flask 应用
- **框架**: Flask + Flask-AppBuilder
- **ORM**: SQLAlchemy
- **认证**: Flask-AppBuilder Security
- **API**: Flask-RESTful + Marshmallow

#### 核心模块
```
superset/
├── app.py                    # Flask 应用入口
├── config.py                 # 配置文件
├── models/                   # 数据库模型
│   ├── core.py              # 核心模型 (Database, Slice, Dashboard)
│   ├── dashboard.py         # 仪表板模型
│   └── slice.py            # 图表模型
├── views/                   # 视图和 API 端点
│   ├── charts/             # 图表 API
│   ├── dashboards/         # 仪表板 API
│   └── explore/           # 探索 API
├── commands/               # 命令模式
│   ├── chart/             # 图表命令
│   ├── dashboard/         # 仪表板命令
│   └── explore/           # 探索命令
├── common/                # 通用模块
│   ├── query_context.py   # 查询上下文
│   └── query_object.py    # 查询对象
└── db_engine_specs/       # 数据库引擎规范
    ├── base.py           # 基础规范
    ├── postgres.py       # PostgreSQL 规范
    └── mysql.py         # MySQL 规范
```

### 2.3 数据存储

#### 元数据数据库
- **默认**: SQLite (开发环境)
- **生产**: PostgreSQL / MySQL
- **存储**: 用户、角色、仪表板、图表配置等

#### 缓存层
- **Redis**: 查询结果缓存、会话存储
- **Memcached**: 可选的缓存后端
- **本地缓存**: Python LRU Cache

## 3. 请求处理流程

### 3.1 图表查询流程

```
用户操作
  │
  ▼
前端 React 组件
  │
  ▼ 1. 构建查询参数
Redux Action
  │
  ▼ 2. 发送 HTTP 请求
API Client (fetch/axios)
  │
  ▼ 3. 路由到后端
Flask Router
  │
  ▼ 4. 权限验证
Security Manager
  │
  ▼ 5. 命令执行
Command Pattern
  │
  ▼ 6. 查询上下文构建
QueryContext
  │
  ▼ 7. SQL 生成
Database Engine Spec
  │
  ▼ 8. 执行查询
Data Source
  │
  ▼ 9. 结果处理
DataFrame / JSON
  │
  ▼ 10. 缓存存储
Cache Manager
  │
  ▼ 11. 返回响应
JSON Response
  │
  ▼ 12. 更新状态
Redux Store
  │
  ▼ 13. 渲染图表
Chart Component
```

### 3.2 仪表板加载流程

```
访问仪表板 URL
  │
  ▼
前端路由
  │
  ▼
加载仪表板元数据
  │
  ├─► 获取仪表板配置
  ├─► 获取所有图表配置
  └─► 获取数据源信息
  │
  ▼
并行加载图表数据
  │
  ├─► 图表 1 查询
  ├─► 图表 2 查询
  └─► 图表 N 查询
  │
  ▼
渲染仪表板
  │
  ├─► 布局组件
  ├─► 图表组件
  └─► 过滤器组件
  │
  ▼
用户交互
  │
  ▼
过滤器联动更新
  │
  ▼
重新查询受影响图表
```

## 4. 扩展点

### 4.1 前端扩展

#### 自定义图表
```typescript
// 注册自定义图表
export default class MyCustomChart extends React.PureComponent {
  static propTypes = {};
  static defaultProps = {};

  constructor(props) {
    super(props);
  }

  render() {
    const { data, width, height } = this.props;
    // 自定义渲染逻辑
    return <div>{/* 图表内容 */}</div>;
  }
}

// 注册到插件系统
new ChartPlugin({
  type: 'my_custom_chart',
  name: 'My Custom Chart',
  description: 'A custom chart type',
  thumbnail: '',
  controlPanel: myControlPanel,
  transformProps: transformProps,
  loadChart: () => MyCustomChart,
});
```

#### 自定义控制面板
```typescript
export default {
  controlPanelSections: [
    {
      label: 'Basic',
      expanded: true,
      controlSetRows: [
        ['metrics'],
        ['groupby'],
        ['time_range'],
      ],
    },
  ],
};
```

### 4.2 后端扩展

#### 自定义数据库引擎
```python
from superset.db_engine_specs.base import BaseEngineSpec

class MyDatabaseEngineSpec(BaseEngineSpec):
    engine = 'mydatabase'
    engine_name = 'My Database'

    @classmethod
    def get_dbapi_uri(cls, connection_params):
        # 构建数据库连接 URI
        return f"mydatabase://..."

    @classmethod
    def get_sqla_column_type(cls, sqla_type):
        # 映射 SQLAlchemy 列类型
        return sqla_type
```

#### 自定义命令
```python
from superset.commands.base import BaseCommand

class MyCustomCommand(BaseCommand):
    def __init__(self, param1, param2):
        self.param1 = param1
        self.param2 = param2

    def run(self):
        # 执行业务逻辑
        result = self.do_something()
        return result

    def validate(self):
        # 验证参数
        if not self.param1:
            raise ValidationError("param1 is required")
```

## 5. 技术栈总结

### 5.1 前端技术栈

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 框架 | React | 17.0.2 | UI 框架 |
| 语言 | TypeScript | 5.4.5 | 类型安全 |
| 路由 | React Router | 5.3.4 | 页面路由 |
| UI 库 | Ant Design | 5.26.0 | UI 组件 |
| 状态管理 | Redux | 4.2.1 | 状态管理 |
| 可视化 | D3.js | 7.x | 数据可视化 |
| 可视化 | ECharts | 5.6.0 | 图表库 |
| 地图 | Mapbox GL | 3.17.0 | 地图可视化 |
| 构建工具 | Webpack | 5.104.1 | 模块打包 |

### 5.2 后端技术栈

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 框架 | Flask | 3.x | Web 框架 |
| ORM | SQLAlchemy | 2.x | 数据库 ORM |
| 认证 | Flask-AppBuilder | 4.x | 认证授权 |
| API | Flask-RESTful | 0.3.x | REST API |
| 序列化 | Marshmallow | 3.x | 数据序列化 |
| 任务队列 | Celery | 5.x | 异步任务 |
| 缓存 | Redis | 7.x | 缓存存储 |
| 数据处理 | Pandas | 2.x | 数据处理 |

## 6. 设计模式

### 6.1 后端设计模式

#### 命令模式 (Command Pattern)
```python
# superset/commands/chart/create.py
class CreateChartCommand(BaseCommand):
    def __init__(self, data):
        self.data = data

    def run(self):
        # 执行创建逻辑
        chart = self._create_chart()
        return chart

    def validate(self):
        # 验证输入
        pass
```

#### 工厂模式 (Factory Pattern)
```python
# superset/common/query_context_factory.py
class QueryContextFactory:
    @staticmethod
    def create(datasource, queries, **kwargs):
        return QueryContext(
            datasource=datasource,
            queries=queries,
            **kwargs
        )
```

#### 策略模式 (Strategy Pattern)
```python
# 不同的数据库引擎规范
class BaseEngineSpec:
    @classmethod
    def get_sqla_column_type(cls, sqla_type):
        raise NotImplementedError

class PostgresEngineSpec(BaseEngineSpec):
    @classmethod
    def get_sqla_column_type(cls, sqla_type):
        # PostgreSQL 特定实现
        pass
```

### 6.2 前端设计模式

#### 容器/展示组件模式
```typescript
// 容器组件：处理逻辑和状态
class ChartContainer extends React.Component {
  componentDidMount() {
    this.props.fetchChartData();
  }

  render() {
    return <ChartDisplay {...this.props} />;
  }
}

// 展示组件：纯 UI 渲染
const ChartDisplay = ({ data, loading }) => {
  if (loading) return <Loading />;
  return <div>{/* 渲染图表 */}</div>;
};
```

#### 高阶组件模式
```typescript
// 高阶组件：增强组件功能
function withChartData(WrappedComponent) {
  return class extends React.Component {
    state = { data: null, loading: false };

    componentDidMount() {
      this.loadData();
    }

    loadData = async () => {
      this.setState({ loading: true });
      const data = await fetchChartData();
      this.setState({ data, loading: false });
    };

    render() {
      return <WrappedComponent {...this.props} {...this.state} />;
    };
  };
}
```

## 7. 性能优化策略

### 7.1 前端优化

#### 代码分割
```typescript
// 路由级别的代码分割
const Dashboard = lazy(() =>
  import(/* webpackChunkName: "Dashboard" */ 'src/pages/Dashboard')
);

const ChartCreation = lazy(() =>
  import(/* webpackChunkName: "ChartCreation" */ 'src/pages/ChartCreation')
);
```

#### 虚拟滚动
```typescript
// 使用 react-window 处理大数据列表
import { FixedSizeList } from 'react-window';

const Row = ({ index, style }) => (
  <div style={style}>Row {index}</div>
);

const List = () => (
  <FixedSizeList
    height={400}
    itemCount={1000}
    itemSize={35}
    width={300}
  >
    {Row}
  </FixedSizeList>
);
```

### 7.2 后端优化

#### 查询缓存
```python
# 使用 Redis 缓存查询结果
from superset.utils.cache import cache_manager

@cache_manager.cache.memoize(timeout=3600)
def get_chart_data(query_context):
    # 执行查询
    result = execute_query(query_context)
    return result
```

#### 异步任务
```python
# 使用 Celery 处理耗时任务
from superset.tasks import celery_app

@celery_app.task
def generate_thumbnail(chart_id):
    # 异步生成缩略图
    chart = Chart.query.get(chart_id)
    thumbnail = create_thumbnail(chart)
    chart.thumbnail = thumbnail
    db.session.commit()
```

## 8. 安全架构

### 8.1 认证机制

- **数据库认证**: 用户名/密码
- **OAuth 2.0**: Google, GitHub, Azure AD 等
- **LDAP/Active Directory**: 企业目录服务
- **OpenID Connect**: 标准 SSO 协议

### 8.2 授权机制

- **基于角色的访问控制 (RBAC)**: Admin, Alpha, Gamma, Public
- **行级安全 (RLS)**: 数据行级别的访问控制
- **列级安全**: 敏感列的访问控制
- **数据源权限**: 数据库连接的访问控制

## 9. 部署架构

### 9.1 单机部署

```
┌─────────────────────────────────┐
│         Nginx                │
│    (Reverse Proxy)           │
└────────────┬────────────────┘
             │
    ┌────────▼────────┐
    │  Superset App  │
    │  (Gunicorn)     │
    └────────┬────────┘
             │
    ┌────────▼────────┐
    │   PostgreSQL   │
    │   (Metadata)   │
    └────────────────┘
    ┌────────▼────────┐
    │     Redis      │
    │    (Cache)     │
    └────────────────┘
```

### 9.2 分布式部署

```
┌─────────────────────────────────┐
│         Load Balancer         │
└────────────┬────────────────┘
             │
    ┌────────▼────────┐
    │  Nginx (x3)    │
    └────────┬────────┘
             │
    ┌────────▼────────┐
    │ Superset (x3)   │
    └────────┬────────┘
             │
    ┌────────▼────────┐
    │   PostgreSQL   │
    │   (Primary)    │
    └────────┬────────┘
             │
    ┌────────▼────────┐
    │ PostgreSQL      │
    │   (Replica)    │
    └────────────────┘
    ┌────────▼────────┐
    │   Redis Cluster │
    └────────────────┘
    ┌────────▼────────┐
    │  Celery Workers │
    │      (x3)       │
    └────────────────┘
```

## 10. 下一步

阅读完本文档后，建议继续学习：

1. [项目结构](./02-项目结构.md) - 了解详细的目录结构
2. [技术栈](./03-技术栈.md) - 深入了解技术选型
3. [后端架构](./04-后端架构.md) - 学习后端实现细节
4. [前端架构](./08-前端架构.md) - 学习前端实现细节
