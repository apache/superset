# Apache Superset 状态管理

## 1. 状态管理概述

### 1.1 状态类型

Apache Superset 前端使用多种状态管理方式：

| 状态类型 | 管理方式 | 适用场景 |
|---------|---------|---------|
| **全局状态** | Redux | 跨组件共享状态 |
| **组件状态** | React State | 组件内部状态 |
| **表单状态** | Form State | 表单数据管理 |
| **路由状态** | React Router | URL 参数状态 |
| **缓存状态** | React Query | 服务器状态 |

### 1.2 状态架构

```
状态管理架构
├── Redux Store
│   ├── Dashboard State
│   ├── Explore State
│   ├── Chart State
│   └── User State
├── Component State
│   ├── Local State
│   ├── Context State
│   └── Ref State
├── Server State
│   ├── React Query
│   ├── SWR
│   └── Fetch API
└── URL State
    ├── Query Params
    ├── Path Params
    └── Hash Params
```

## 2. Redux Store

### 2.1 Store 配置

[views/store.ts](../superset-frontend/src/views/store.ts) 配置了 Redux Store：

```typescript
import { createStore, applyMiddleware, compose, combineReducers } from 'redux';
import thunk from 'redux-thunk';
import { createLogger } from 'redux-logger';
import { persistStore, persistReducer } from 'redux-persist';
import storage from 'redux-persist/lib/storage';

// Reducers
import dashboardInfo from 'src/dashboard/reducers/dashboardInfo';
import charts from 'src/dashboard/reducers/charts';
import dataSources from 'src/dashboard/reducers/dataSources';
import filters from 'src/dashboard/reducers/filters';
import nativeFilters from 'src/dashboard/reducers/nativeFilters';
import layout from 'src/dashboard/reducers/layout';
import explore from 'src/explore/reducers';

// Root Reducer
const rootReducer = combineReducers({
  dashboardInfo,
  charts,
  dataSources,
  filters,
  nativeFilters,
  layout,
  explore,
});

// Persist Config
const persistConfig = {
  key: 'root',
  storage,
  whitelist: ['dashboardInfo', 'explore'],
};

// Persisted Reducer
const persistedReducer = persistReducer(persistConfig, rootReducer);

// Logger Middleware
const logger = createLogger({
  collapsed: true,
  duration: true,
});

// Middleware
const middleware = [thunk];

if (process.env.NODE_ENV === 'development') {
  middleware.push(logger);
}

// Store
const store = createStore(
  persistedReducer,
  compose(applyMiddleware(...middleware))
);

// Persistor
const persistor = persistStore(store);

export { store, persistor };
```

### 2.2 Dashboard Reducer

[dashboard/reducers/dashboardInfo.ts](../superset-frontend/src/dashboard/reducers/dashboardInfo.ts) 定义了 Dashboard 的状态管理：

```typescript
import { Action } from 'redux';

export interface DashboardInfoState {
  id: number | null;
  title: string;
  description: string;
  metadata: Record<string, unknown>;
  css: string;
  owners: number[];
  createdOn: string | null;
  changedOn: string | null;
  lastModifiedBy: number | null;
  status: 'loading' | 'success' | 'error';
  error: string | null;
}

const initialState: DashboardInfoState = {
  id: null,
  title: '',
  description: '',
  metadata: {},
  css: '',
  owners: [],
  createdOn: null,
  changedOn: null,
  lastModifiedBy: null,
  status: 'loading',
  error: null,
};

export default function dashboardInfo(
  state: DashboardInfoState = initialState,
  action: Action,
): DashboardInfoState {
  switch (action.type) {
    case 'FETCH_DASHBOARD_START':
      return {
        ...state,
        status: 'loading',
        error: null,
      };

    case 'FETCH_DASHBOARD_SUCCESS':
      return {
        ...state,
        ...action.payload,
        status: 'success',
      };

    case 'FETCH_DASHBOARD_FAILURE':
      return {
        ...state,
        status: 'error',
        error: action.payload,
      };

    case 'UPDATE_DASHBOARD_SUCCESS':
      return {
        ...state,
        ...action.payload,
      };

    case 'RESET_DASHBOARD':
      return initialState;

    default:
      return state;
  }
}
```

### 2.3 Explore Reducer

[explore/reducers/index.ts](../superset-frontend/src/explore/reducers/index.ts) 定义了 Explore 的状态管理：

```typescript
import { Action } from 'redux';

export interface ExploreState {
  chartId: number | null;
  chartStatus: 'loading' | 'success' | 'error';
  chartData: Record<string, unknown> | null;
  chartError: string | null;
  formData: Record<string, unknown>;
  datasource: Record<string, unknown> | null;
  queries: Record<string, unknown>[];
  forceRefresh: boolean;
  isExploreView: boolean;
}

const initialState: ExploreState = {
  chartId: null,
  chartStatus: 'loading',
  chartData: null,
  chartError: null,
  formData: {},
  datasource: null,
  queries: [],
  forceRefresh: false,
  isExploreView: false,
};

export default function explore(
  state: ExploreState = initialState,
  action: Action,
): ExploreState {
  switch (action.type) {
    case 'INIT_CHART':
      return {
        ...state,
        chartId: action.payload.chartId,
        formData: action.payload.formData,
        datasource: action.payload.datasource,
      };

    case 'FETCH_CHART_DATA_START':
      return {
        ...state,
        chartStatus: 'loading',
        chartError: null,
      };

    case 'FETCH_CHART_DATA_SUCCESS':
      return {
        ...state,
        chartData: action.payload,
        chartStatus: 'success',
      };

    case 'FETCH_CHART_DATA_FAILURE':
      return {
        ...state,
        chartError: action.payload,
        chartStatus: 'error',
      };

    case 'UPDATE_FORM_DATA':
      return {
        ...state,
        formData: {
          ...state.formData,
          ...action.payload,
        },
      };

    case 'SET_FORCE_REFRESH':
      return {
        ...state,
        forceRefresh: action.payload,
      };

    case 'SET_IS_EXPLORE_VIEW':
      return {
        ...state,
        isExploreView: action.payload,
      };

    case 'RESET_CHART':
      return initialState;

    default:
      return state;
  }
}
```

## 3. Redux Actions

### 3.1 Dashboard Actions

[dashboard/actions/dashboardActions.ts](../superset-frontend/src/dashboard/actions/dashboardActions.ts) 定义了 Dashboard 的 Actions：

```typescript
import { ThunkAction } from 'redux-thunk';
import { Action } from 'redux';
import { RootState } from 'src/views/store';
import { getDashboard, updateDashboard } from 'src/utils/api';

export const FETCH_DASHBOARD_START = 'FETCH_DASHBOARD_START';
export const FETCH_DASHBOARD_SUCCESS = 'FETCH_DASHBOARD_SUCCESS';
export const FETCH_DASHBOARD_FAILURE = 'FETCH_DASHBOARD_FAILURE';
export const UPDATE_DASHBOARD_SUCCESS = 'UPDATE_DASHBOARD_SUCCESS';
export const RESET_DASHBOARD = 'RESET_DASHBOARD';

export function fetchDashboard(
  dashboardId: number,
): ThunkAction<void, RootState, unknown, Action<string>> {
  return async (dispatch) => {
    dispatch({ type: FETCH_DASHBOARD_START });

    try {
      const response = await getDashboard(dashboardId);
      dispatch({
        type: FETCH_DASHBOARD_SUCCESS,
        payload: response.data,
      });
    } catch (error) {
      dispatch({
        type: FETCH_DASHBOARD_FAILURE,
        payload: error.message,
      });
    }
  };
}

export function updateDashboardInfo(
  dashboardId: number,
  data: Record<string, unknown>,
): ThunkAction<void, RootState, unknown, Action<string>> {
  return async (dispatch) => {
    try {
      const response = await updateDashboard(dashboardId, data);
      dispatch({
        type: UPDATE_DASHBOARD_SUCCESS,
        payload: response.data,
      });
    } catch (error) {
      dispatch({
        type: FETCH_DASHBOARD_FAILURE,
        payload: error.message,
      });
    }
  };
}

export function resetDashboard() {
  return {
    type: RESET_DASHBOARD,
  };
}
```

### 3.2 Explore Actions

[explore/actions/exploreActions.ts](../superset-frontend/src/explore/actions/exploreActions.ts) 定义了 Explore 的 Actions：

```typescript
import { ThunkAction } from 'redux-thunk';
import { Action } from 'redux';
import { RootState } from 'src/views/store';
import { getChartData } from 'src/utils/api';

export const INIT_CHART = 'INIT_CHART';
export const FETCH_CHART_DATA_START = 'FETCH_CHART_DATA_START';
export const FETCH_CHART_DATA_SUCCESS = 'FETCH_CHART_DATA_SUCCESS';
export const FETCH_CHART_DATA_FAILURE = 'FETCH_CHART_DATA_FAILURE';
export const UPDATE_FORM_DATA = 'UPDATE_FORM_DATA';
export const SET_FORCE_REFRESH = 'SET_FORCE_REFRESH';
export const SET_IS_EXPLORE_VIEW = 'SET_IS_EXPLORE_VIEW';
export const RESET_CHART = 'RESET_CHART';

export function initChart(
  chartId: number,
  formData: Record<string, unknown>,
  datasource: Record<string, unknown>,
) {
  return {
    type: INIT_CHART,
    payload: {
      chartId,
      formData,
      datasource,
    },
  };
}

export function fetchChartData(
  formData: Record<string, unknown>,
): ThunkAction<void, RootState, unknown, Action<string>> {
  return async (dispatch, getState) => {
    dispatch({ type: FETCH_CHART_DATA_START });

    try {
      const response = await getChartData(formData);
      dispatch({
        type: FETCH_CHART_DATA_SUCCESS,
        payload: response.data,
      });
    } catch (error) {
      dispatch({
        type: FETCH_CHART_DATA_FAILURE,
        payload: error.message,
      });
    }
  };
}

export function updateFormData(
  formData: Record<string, unknown>,
) {
  return {
    type: UPDATE_FORM_DATA,
    payload: formData,
  };
}

export function setForceRefresh(forceRefresh: boolean) {
  return {
    type: SET_FORCE_REFRESH,
    payload: forceRefresh,
  };
}

export function setIsExploreView(isExploreView: boolean) {
  return {
    type: SET_IS_EXPLORE_VIEW,
    payload: isExploreView,
  };
}

export function resetChart() {
  return {
    type: RESET_CHART,
  };
}
```

## 4. React Hooks

### 4.1 useSelector Hook

```typescript
import { useSelector } from 'react-redux';
import { RootState } from 'src/views/store';

const DashboardComponent = () => {
  const dashboardInfo = useSelector((state: RootState) => state.dashboardInfo);
  const charts = useSelector((state: RootState) => state.charts);
  const layout = useSelector((state: RootState) => state.layout);

  return (
    <div>
      <h1>{dashboardInfo.title}</h1>
      {/* 渲染仪表板 */}
    </div>
  );
};

export default DashboardComponent;
```

### 4.2 useDispatch Hook

```typescript
import { useDispatch } from 'react-redux';
import { useEffect } from 'react';
import { fetchDashboard } from 'src/dashboard/actions/dashboardActions';

const DashboardComponent = ({ dashboardId }) => {
  const dispatch = useDispatch();

  useEffect(() => {
    dispatch(fetchDashboard(dashboardId));
  }, [dispatch, dashboardId]);

  return <div>{/* 渲染仪表板 */}</div>;
};

export default DashboardComponent;
```

### 4.3 自定义 Hooks

```typescript
import { useSelector, useDispatch } from 'react-redux';
import { useEffect } from 'react';
import { RootState } from 'src/views/store';
import { fetchChartData } from 'src/explore/actions/exploreActions';

export function useChartData(chartId: number) {
  const dispatch = useDispatch();
  const { chartData, chartStatus, chartError } = useSelector(
    (state: RootState) => state.explore,
  );

  useEffect(() => {
    dispatch(fetchChartData({ chartId }));
  }, [dispatch, chartId]);

  return { chartData, chartStatus, chartError };
}

export function useDashboard(dashboardId: number) {
  const dispatch = useDispatch();
  const dashboardInfo = useSelector(
    (state: RootState) => state.dashboardInfo,
  );

  useEffect(() => {
    dispatch(fetchDashboard(dashboardId));
  }, [dispatch, dashboardId]);

  return dashboardInfo;
}
```

## 5. Context API

### 5.1 Dashboard Context

```typescript
import React, { createContext, useContext, useReducer } from 'react';

interface DashboardContextType {
  dashboardId: number;
  dashboardInfo: Record<string, unknown>;
  updateDashboard: (data: Record<string, unknown>) => void;
}

const DashboardContext = createContext<DashboardContextType | null>(null);

interface DashboardProviderProps {
  dashboardId: number;
  children: React.ReactNode;
}

function dashboardReducer(
  state: Record<string, unknown>,
  action: Action,
) {
  switch (action.type) {
    case 'UPDATE_DASHBOARD':
      return {
        ...state,
        ...action.payload,
      };
    default:
      return state;
  }
}

export function DashboardProvider({ dashboardId, children }: DashboardProviderProps) {
  const [dashboardInfo, dispatch] = useReducer(dashboardReducer, {});

  const updateDashboard = (data: Record<string, unknown>) => {
    dispatch({
      type: 'UPDATE_DASHBOARD',
      payload: data,
    });
  };

  return (
    <DashboardContext.Provider value={{ dashboardId, dashboardInfo, updateDashboard }}>
      {children}
    </DashboardContext.Provider>
  );
}

export function useDashboard() {
  const context = useContext(DashboardContext);
  if (!context) {
    throw new Error('useDashboard must be used within a DashboardProvider');
  }
  return context;
}
```

### 5.2 使用 Context

```typescript
import { useDashboard } from './DashboardContext';

const ChartComponent = () => {
  const { dashboardId, dashboardInfo, updateDashboard } = useDashboard();

  const handleUpdate = () => {
    updateDashboard({
      title: 'New Title',
    });
  };

  return (
    <div>
      <h1>{dashboardInfo.title}</h1>
      <button onClick={handleUpdate}>Update</button>
    </div>
  );
};

export default ChartComponent;
```

## 6. React Query

### 6.1 配置 React Query

```typescript
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 分钟
      cacheTime: 10 * 60 * 1000, // 10 分钟
      refetchOnWindowFocus: false,
      retry: 3,
    },
  },
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      {/* 应用组件 */}
    </QueryClientProvider>
  );
}

export default App;
```

### 6.2 使用 React Query

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getDashboard, updateDashboard } from 'src/utils/api';

function DashboardComponent({ dashboardId }) {
  const queryClient = useQueryClient();

  // 查询数据
  const { data, isLoading, error } = useQuery({
    queryKey: ['dashboard', dashboardId],
    queryFn: () => getDashboard(dashboardId),
  });

  // 更新数据
  const mutation = useMutation({
    mutationFn: (data: Record<string, unknown>) => updateDashboard(dashboardId, data),
    onSuccess: () => {
      // 使缓存失效
      queryClient.invalidateQueries({ queryKey: ['dashboard', dashboardId] });
    },
  });

  if (isLoading) return <Loading />;
  if (error) return <Error />;

  return (
    <div>
      <h1>{data.title}</h1>
      <button onClick={() => mutation.mutate({ title: 'New Title' })}>
        Update
      </button>
    </div>
  );
}

export default DashboardComponent;
```

## 7. URL 状态管理

### 7.1 URL 参数管理

```typescript
import { useSearchParams } from 'react-router-dom';

const ExploreComponent = () => {
  const [searchParams, setSearchParams] = useSearchParams();

  const chartId = searchParams.get('chartId');
  const vizType = searchParams.get('vizType');

  const updateParams = (params: Record<string, string>) => {
    setSearchParams((prev) => {
      const newParams = new URLSearchParams(prev);
      Object.entries(params).forEach(([key, value]) => {
        if (value) {
          newParams.set(key, value);
        } else {
          newParams.delete(key);
        }
      });
      return newParams;
    });
  };

  return (
    <div>
      <button onClick={() => updateParams({ vizType: 'line' })}>
        Line Chart
      </button>
      <button onClick={() => updateParams({ vizType: 'bar' })}>
        Bar Chart
      </button>
    </div>
  );
};

export default ExploreComponent;
```

### 7.2 同步 URL 和 Redux

```typescript
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useSearchParams } from 'react-router-dom';
import { updateFormData } from 'src/explore/actions/exploreActions';

const ExploreComponent = () => {
  const dispatch = useDispatch();
  const [searchParams, setSearchParams] = useSearchParams();
  const formData = useSelector((state: RootState) => state.explore.formData);

  // 从 URL 同步到 Redux
  useEffect(() => {
    const urlParams = Object.fromEntries(searchParams.entries());
    dispatch(updateFormData(urlParams));
  }, [dispatch, searchParams]);

  // 从 Redux 同步到 URL
  useEffect(() => {
    const params = new URLSearchParams();
    Object.entries(formData).forEach(([key, value]) => {
      if (value) {
        params.set(key, String(value));
      }
    });
    setSearchParams(params);
  }, [formData, setSearchParams]);

  return <div>{/* 渲染组件 */}</div>;
};

export default ExploreComponent;
```

## 8. 状态管理最佳实践

### 8.1 Redux 最佳实践

1. **状态设计**
   - 保持状态扁平化
   - 避免嵌套过深
   - 使用不可变数据

2. **Action 设计**
   - 使用常量定义 Action 类型
   - 保持 Action 简单
   - 使用 Thunk 处理异步操作

3. **Reducer 设计**
   - 保持 Reducer 纯函数
   - 使用 switch 语句
   - 提供默认状态

### 8.2 React Query 最佳实践

1. **查询设计**
   - 使用唯一的查询键
   - 设置合理的缓存时间
   - 实现自动重新获取

2. **变更设计**
   - 使用乐观更新
   - 实现错误回滚
   - 使相关缓存失效

3. **性能优化**
   - 使用查询缓存
   - 避免不必要的重新获取
   - 使用查询取消

### 8.3 Context API 最佳实践

1. **Context 设计**
   - 避免过度使用 Context
   - 拆分大型 Context
   - 使用自定义 Hooks

2. **性能优化**
   - 使用 memo 优化组件
   - 避免不必要的重新渲染
   - 使用 useCallback 和 useMemo

3. **类型安全**
   - 使用 TypeScript 类型
   - 提供默认值
   - 验证 Context 使用

## 9. 下一步

阅读完本文档后，建议继续学习：

1. [可视化组件](./10-可视化组件.md) - 学习可视化组件
2. [前端架构](./08-前端架构.md) - 学习前端架构
3. [调试指南](./17-调试指南.md) - 学习调试方法
