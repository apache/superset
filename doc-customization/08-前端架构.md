# Apache Superset 前端架构

## 1. 应用入口

### 1.1 主应用组件

[views/App.tsx](../superset-frontend/src/views/App.tsx) 是 React 应用的主入口：

```typescript
import { Suspense, useEffect } from 'react';
import { BrowserRouter as Router, Switch, Route } from 'react-router-dom';
import { bindActionCreators } from 'redux';
import { Layout, Loading } from '@superset-ui/core/components';
import { ErrorBoundary } from 'src/components';
import Menu from 'src/features/home/Menu';
import getBootstrapData, { applicationRoot } from 'src/utils/getBootstrapData';
import ToastContainer from 'src/components/MessageToasts/ToastContainer';
import setupApp from 'src/setup/setupApp';
import setupPlugins from 'src/setup/setupPlugins';
import { routes, isFrontendRoute } from 'src/views/routes';
import { store } from 'src/views/store';
import ExtensionsStartup from 'src/extensions/ExtensionsStartup';

setupApp();
setupPlugins();

const bootstrapData = getBootstrapData();

const App = () => (
  <Router basename={applicationRoot()}>
    <ExtensionsStartup />
    <Menu
      data={bootstrapData.common.menu_data}
      isFrontendRoute={isFrontendRoute}
    />
    <Switch>
      {routes.map(({ path, Component, props = {}, Fallback = Loading }) => (
        <Route path={path} key={path}>
          <Suspense fallback={<Fallback />}>
            <Layout>
              <Layout.Content>
                <ErrorBoundary>
                  <Component user={bootstrapData.user} {...props} />
                </ErrorBoundary>
              </Layout.Content>
            </Layout>
          </Suspense>
        </Route>
      ))}
    </Switch>
    <ToastContainer />
  </Router>
);

export default hot(App);
```

### 1.2 路由配置

[views/routes.tsx](../superset-frontend/src/views/routes.tsx) 定义了应用路由：

```typescript
import { lazy, ComponentType } from 'react';
import { isUserAdmin } from 'src/dashboard/util/permissionUtils';
import getBootstrapData from 'src/utils/getBootstrapData';

const Home = lazy(() => import('src/pages/Home'));
const ChartCreation = lazy(() => import('src/pages/ChartCreation'));
const Dashboard = lazy(() => import('src/pages/Dashboard'));
const ChartList = lazy(() => import('src/pages/ChartList'));
const DashboardList = lazy(() => import('src/pages/DashboardList'));
const DatabaseList = lazy(() => import('src/pages/DatabaseList'));
const DatasetList = lazy(() => import('src/pages/DatasetList'));

export const routes = [
  {
    path: '/',
    Component: Home,
  },
  {
    path: '/chart/edit',
    Component: ChartCreation,
  },
  {
    path: '/chart/:id',
    Component: ChartCreation,
  },
  {
    path: '/dashboard/:id',
    Component: Dashboard,
  },
  {
    path: '/dashboard/list',
    Component: DashboardList,
  },
  {
    path: '/chart/list',
    Component: ChartList,
  },
  {
    path: '/database/list',
    Component: DatabaseList,
  },
  {
    path: '/dataset/list',
    Component: DatasetList,
  },
];

export const isFrontendRoute = (path: string) => {
  return routes.some((route) => path.startsWith(route.path));
};
```

## 2. 状态管理

### 2.1 Redux Store 配置

[views/store.ts](../superset-frontend/src/views/store.ts) 配置了 Redux Store：

```typescript
import { createStore, applyMiddleware, compose } from 'redux';
import thunk from 'redux-thunk';
import { createLogger } from 'redux-logger';
import rootReducer from 'src/dashboard/reducers/rootReducer';

const logger = createLogger({
  collapsed: true,
  duration: true,
});

const middleware = [thunk];

if (process.env.NODE_ENV === 'development') {
  middleware.push(logger);
}

const store = createStore(
  rootReducer,
  compose(applyMiddleware(...middleware))
);

export default store;
```

### 2.2 Dashboard Reducer

[dashboard/reducers/rootReducer.ts](../superset-frontend/src/dashboard/reducers/rootReducer.ts) 定义了 Dashboard 的状态管理：

```typescript
import { combineReducers } from 'redux';
import dashboardInfo from './dashboardInfo';
import charts from './charts';
import dataSources from './dataSources';
import filters from './filters';
import nativeFilters from './nativeFilters';
import layout from './layout';
import directPathToChild from './directPathToChild';
import explore from './explore';

const rootReducer = combineReducers({
  dashboardInfo,
  charts,
  dataSources,
  filters,
  nativeFilters,
  layout,
  directPathToChild,
  explore,
});

export default rootReducer;
```

### 2.3 Explore Reducer

[explore/store.ts](../superset-frontend/src/explore/store.ts) 定义了 Explore 的状态管理：

```typescript
import { createStore, applyMiddleware, compose } from 'redux';
import thunk from 'redux-thunk';
import { createLogger } from 'redux-logger';
import rootReducer from './reducers';

const logger = createLogger({
  collapsed: true,
  duration: true,
});

const middleware = [thunk];

if (process.env.NODE_ENV === 'development') {
  middleware.push(logger);
}

const store = createStore(
  rootReducer,
  compose(applyMiddleware(...middleware))
);

export default store;
```

## 3. 组件架构

### 3.1 组件层次结构

```
App
├── Menu
├── Layout
│   ├── Layout.Sider
│   ├── Layout.Header
│   └── Layout.Content
│       ├── Dashboard
│       │   ├── DashboardHeader
│       │   ├── DashboardComponentTabs
│       │   ├── ChartHolder
│       │   │   ├── Chart
│       │   │   │   ├── ChartRenderer
│       │   │   │   └── ChartContainer
│       │   │   └── Loading
│       │   ├── FilterBox
│       │   └── Markdown
│       ├── Explore
│       │   ├── ExploreChartPanel
│       │   │   ├── ExploreChartHeader
│       │   │   ├── ExploreChart
│       │   │   └── DataTablesPane
│       │   ├── ExploreViewContainer
│       │   └── ControlPanel
│       └── ChartCreation
│           ├── ChartControls
│           └── ChartPreview
└── ToastContainer
```

### 3.2 Chart 组件

[components/Chart/Chart.tsx](../superset-frontend/src/components/Chart/Chart.tsx) 是图表组件：

```typescript
import React, { PureComponent } from 'react';
import PropTypes from 'prop-types';
import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';
import ChartRenderer from './ChartRenderer';
import * as exploreActions from 'src/explore/actions/exploreActions';
import { Logger, LOG_ACTIONS_LOAD_CHART_DATA } from 'src/logger/LogUtils';

class Chart extends PureComponent {
  static propTypes = {
    chartId: PropTypes.number.isRequired,
    formData: PropTypes.object.isRequired,
    datasource: PropTypes.object.isRequired,
    width: PropTypes.number,
    height: PropTypes.number,
  };

  componentDidMount() {
    const { chartId, formData, datasource } = this.props;
    this.props.initAndFetchChartData({
      chartId,
      formData,
      datasource,
    });
  }

  componentDidUpdate(prevProps) {
    const { formData, datasource } = this.props;
    if (
      prevProps.formData !== formData ||
      prevProps.datasource !== datasource
    ) {
      this.props.fetchChartData({
        formData,
        datasource,
      });
    }
  }

  render() {
    const { chartData, chartStatus, width, height } = this.props;

    if (chartStatus === 'loading') {
      return <Loading />;
    }

    if (chartStatus === 'error') {
      return <ErrorMessage />;
    }

    return (
      <ChartRenderer
        chartData={chartData}
        width={width}
        height={height}
      />
    );
  }
}

function mapDispatchToProps(dispatch) {
  return bindActionCreators(exploreActions, dispatch);
}

export default connect(null, mapDispatchToProps)(Chart);
```

### 3.3 Dashboard 组件

[pages/Dashboard/Dashboard.tsx](../superset-frontend/src/pages/Dashboard/Dashboard.tsx) 是仪表板组件：

```typescript
import React, { PureComponent } from 'react';
import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';
import DashboardBuilder from 'src/dashboard/components/DashboardBuilder';
import * as dashboardActions from 'src/dashboard/actions/dashboardActions';

class Dashboard extends PureComponent {
  componentDidMount() {
    const { dashboardId } = this.props;
    this.props.fetchDashboard(dashboardId);
  }

  render() {
    const { dashboardInfo, charts, layout } = this.props;

    if (!dashboardInfo) {
      return <Loading />;
    }

    return (
      <DashboardBuilder
        dashboardInfo={dashboardInfo}
        charts={charts}
        layout={layout}
      />
    );
  }
}

function mapStateToProps({ dashboardInfo, charts, layout }) {
  return { dashboardInfo, charts, layout };
}

function mapDispatchToProps(dispatch) {
  return bindActionCreators(dashboardActions, dispatch);
}

export default connect(mapStateToProps, mapDispatchToProps)(Dashboard);
```

## 4. 插件系统

### 4.1 插件初始化

[setup/setupPlugins.ts](../superset-frontend/src/setup/setupPlugins.ts) 初始化插件：

```typescript
import { ChartPlugin, ChartProps } from '@superset-ui/core';
import { registerChart } from 'src/dashboard/components/nativeFilters/RegisterChart';
import { ensureIsArray } from '@superset-ui/core';

const chartPlugins: ChartPlugin[] = [
  // 注册 ECharts 插件
  require('@superset-ui/plugin-chart-echarts').default,
  // 注册表格插件
  require('@superset-ui/plugin-chart-table').default,
  // 注册透视表插件
  require('@superset-ui/plugin-chart-pivot-table').default,
  // 注册 AG Grid 插件
  require('@superset-ui/plugin-chart-ag-grid-table').default,
  // 注册词云插件
  require('@superset-ui/plugin-chart-word-cloud').default,
  // 注册 Handlebars 插件
  require('@superset-ui/plugin-chart-handlebars').default,
  // 注册地图插件
  require('@superset-ui/plugin-chart-cartodiagram').default,
];

export default function setupPlugins() {
  chartPlugins.forEach((plugin) => {
    registerChart(plugin);
  });
}
```

### 4.2 插件注册

```typescript
import { ChartPlugin, ChartProps } from '@superset-ui/core';

export default new ChartPlugin({
  type: 'echarts_timeseries',
  name: 'Time Series Chart',
  description: 'Time series line chart',
  thumbnail: 'images/thumbnails/time-series-line.png',
  controlPanel: () => import('./controlPanels/Timeseries'),
  loadChart: () => import('./Timeseries/EchartsTimeseries'),
  metadata: {
    canBeUserSpecific: true,
    showNoResults: true,
  },
});
```

## 5. Explore 模块

### 5.1 Explore 组件

[explore/components/ExploreContainer/index.tsx](../superset-frontend/src/explore/components/ExploreContainer/index.tsx) 是探索容器：

```typescript
import React, { PureComponent } from 'react';
import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';
import ExploreViewContainer from './ExploreViewContainer';
import ExploreChartPanel from './ExploreChartPanel';
import * as exploreActions from 'src/explore/actions/exploreActions';

class ExploreContainer extends PureComponent {
  render() {
    const { isExploreView } = this.props;

    if (isExploreView) {
      return <ExploreViewContainer />;
    }

    return <ExploreChartPanel />;
  }
}

function mapStateToProps({ explore }) {
  return { isExploreView: explore.isExploreView };
}

function mapDispatchToProps(dispatch) {
  return bindActionCreators(exploreActions, dispatch);
}

export default connect(mapStateToProps, mapDispatchToProps)(ExploreContainer);
```

### 5.2 控制面板

[explore/controlPanels/sections.tsx](../superset-frontend/src/explore/controlPanels/sections.tsx) 定义了控制面板：

```typescript
export default {
  controlPanelSections: [
    {
      label: 'Time',
      expanded: true,
      controlSetRows: [
        ['granularity_sqla'],
        ['time_range'],
        ['time_column'],
      ],
    },
    {
      label: 'Group by',
      expanded: true,
      controlSetRows: [
        ['groupby'],
        ['columns'],
      ],
    },
    {
      label: 'Metrics',
      expanded: true,
      controlSetRows: [
        ['metrics'],
        ['adhoc_metrics'],
      ],
    },
    {
      label: 'Filters',
      expanded: false,
      controlSetRows: [
        ['filters'],
        ['adhoc_filters'],
      ],
    },
    {
      label: 'Visualization',
      expanded: true,
      controlSetRows: [
        ['viz_type'],
        ['color_scheme'],
        ['rich_tooltip'],
      ],
    },
  ],
};
```

## 6. API 客户端

### 6.1 API 工具

[utils/api.ts](../superset-frontend/src/utils/api.ts) 提供了 API 工具：

```typescript
import { SupersetClient } from '@superset-ui/core';

export const client = new SupersetClient({
  protocol: window.location.protocol,
  host: window.location.hostname,
  port: window.location.port,
});

export function getChart(chartId: number) {
  return client.get({
    endpoint: `/api/v1/chart/${chartId}`,
  });
}

export function getDashboard(dashboardId: number) {
  return client.get({
    endpoint: `/api/v1/dashboard/${dashboardId}`,
  });
}

export function getChartData(formData: Record<string, unknown>) {
  return client.post({
    endpoint: '/api/v1/chart/data',
    body: formData,
  });
}
```

### 6.2 数据获取

```typescript
import { getChartData } from 'src/utils/api';
import { setChartData, setChartStatus } from 'src/explore/actions/exploreActions';

export function fetchChartData(formData: Record<string, unknown>) {
  return async (dispatch) => {
    dispatch(setChartStatus('loading'));

    try {
      const response = await getChartData(formData);
      dispatch(setChartData(response.data));
      dispatch(setChartStatus('success'));
    } catch (error) {
      dispatch(setChartStatus('error'));
      dispatch(setChartError(error.message));
    }
  };
}
```

## 7. 样式和主题

### 7.1 主题配置

[setup/setupColors.ts](../superset-frontend/src/setup/setupColors.ts) 配置了颜色：

```typescript
import { setGlobalTheme } from '@superset-ui/core';

export default function setupColors() {
  setGlobalTheme({
    colors: {
      primary: '#1890ff',
      secondary: '#722ed1',
      success: '#52c41a',
      warning: '#faad14',
      error: '#f5222d',
      info: '#1890ff',
    },
    grayscale: {
      bright: '#ffffff',
      light: '#f5f5f5',
      medium: '#d9d9d9',
      dark: '#8c8c8c',
      darker: '#595959',
      black: '#262626',
    },
  });
}
```

### 7.2 Emotion 样式

```typescript
import { css } from '@emotion/react';

const containerStyle = css`
  display: flex;
  flex-direction: column;
  padding: 16px;
  background-color: #ffffff;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
`;

const Container = ({ children }) => (
  <div css={containerStyle}>{children}</div>
);
```

## 8. 性能优化

### 8.1 代码分割

```typescript
import { lazy, Suspense } from 'react';

const Dashboard = lazy(() =>
  import(/* webpackChunkName: "Dashboard" */ 'src/pages/Dashboard')
);

const ChartCreation = lazy(() =>
  import(/* webpackChunkName: "ChartCreation" */ 'src/pages/ChartCreation')
);

const App = () => (
  <Suspense fallback={<Loading />}>
    <Dashboard />
  </Suspense>
);
```

### 8.2 虚拟滚动

```typescript
import { FixedSizeList } from 'react-window';

const Row = ({ index, style }) => (
  <div style={style}>Row {index}</div>
);

const List = ({ items }) => (
  <FixedSizeList
    height={400}
    itemCount={items.length}
    itemSize={35}
    width={300}
  >
    {Row}
  </FixedSizeList>
);
```

### 8.3 记忆化

```typescript
import { memo } from 'react';

const ExpensiveComponent = memo(({ data }) => {
  const result = expensiveCalculation(data);
  return <div>{result}</div>;
});
```

## 9. 下一步

阅读完本文档后，建议继续学习：

1. [状态管理](./09-状态管理.md) - 学习 Redux 状态管理
2. [可视化组件](./10-可视化组件.md) - 学习图表组件
3. [插件系统](./11-插件系统.md) - 学习插件扩展机制
