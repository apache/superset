# Apache Superset 数据模型

## 1. 数据模型概述

### 1.1 模型架构

Apache Superset 使用 SQLAlchemy ORM 来管理数据库模型。模型分为以下几个主要类别：

```
数据模型层次结构
├── 核心模型 (Core Models)
│   ├── Database - 数据库连接
│   ├── SqlaTable - 数据表
│   ├── Slice - 图表
│   ├── Dashboard - 仪表板
│   └── Log - 操作日志
├── 安全模型 (Security Models)
│   ├── User - 用户
│   ├── Role - 角色
│   └── Permission - 权限
├── 数据分析模型 (Analytics Models)
│   ├── Query - 查询记录
│   ├── Report - 报告
│   └── Alert - 告警
└── 扩展模型 (Extension Models)
    ├── Annotation - 注释
    ├── CssTemplate - CSS 模板
    └── SavedQuery - 保存的查询
```

### 1.2 数据库连接

[models/core.py](../superset/models/core.py) 中的 `Database` 模型：

```python
from sqlalchemy import Column, Integer, String, Text, Boolean, ForeignKey
from sqlalchemy.orm import relationship
from flask_appbuilder import Model

class Database(Model):
    """数据库连接模型"""
    __tablename__ = 'dbs'

    # 基本属性
    id = Column(Integer, primary_key=True)
    database_name = Column(String(250), unique=True, nullable=False)
    sqlalchemy_uri = Column(Text, nullable=False)
    extra = Column(Text, nullable=True)

    # 连接配置
    impersonate_user = Column(String(255), nullable=True)
    exposed_type = Column(String(50), nullable=True)
    configuration_method = Column(String(50), nullable=True)

    # 功能开关
    allow_ctas = Column(Boolean, default=False)
    allow_cvas = Column(Boolean, default=False)
    allow_multi_schema_metadata_fetch = Column(Boolean, default=False)
    force_ctas_schema = Column(String(250), nullable=True)

    # 认证信息
    server_cert = Column(Text, nullable=True)
    ssh_tunnel = Column(Text, nullable=True)

    # 显示名称
    verbose_name = Column(String(250), nullable=True)

    # 关系
    tables = relationship('SqlaTable', backref='database', cascade='all, delete-orphan')
    cached_query = relationship('Query', backref='database')
    schemas = relationship('DatabaseSchema', backref='database')

    def get_sqla_engine(self):
        """获取 SQLAlchemy 引擎"""
        from sqlalchemy import create_engine
        from superset.db_engine_specs.base import BaseEngineSpec

        # 解析 URI
        engine_spec = BaseEngineSpec.get_engine_spec_by_uri(self.sqlalchemy_uri)

        # 创建引擎
        engine = create_engine(
            self.sqlalchemy_uri,
            pool_size=5,
            max_overflow=10,
            pool_pre_ping=True,
        )

        return engine

    def get_dbapi_connection(self):
        """获取 DBAPI 连接"""
        engine = self.get_sqla_engine()
        return engine.connect()

    def get_table_names(self, schema=None):
        """获取表名列表"""
        from superset.db_engine_specs.base import BaseEngineSpec

        engine_spec = BaseEngineSpec.get_engine_spec_by_uri(self.sqlalchemy_uri)
        return engine_spec.get_table_names(self, schema)

    def get_columns(self, table_name, schema=None):
        """获取表的列信息"""
        from superset.db_engine_specs.base import BaseEngineSpec

        engine_spec = BaseEngineSpec.get_engine_spec_by_uri(self.sqlalchemy_uri)
        return engine_spec.get_columns(self, table_name, schema)
```

### 1.3 数据表模型

```python
class SqlaTable(Model):
    """数据表模型"""
    __tablename__ = 'tables'

    # 基本属性
    id = Column(Integer, primary_key=True)
    table_name = Column(String(250), nullable=False)
    schema = Column(String(255), nullable=True)
    main_dttm_col = Column(String(250), nullable=True)
    default_endpoint = Column(String(255), nullable=True)

    # 外键
    database_id = Column(Integer, ForeignKey('dbs.id'), nullable=False)

    # 配置
    offset = Column(Integer, default=0)
    cache_timeout = Column(Integer, default=None)
    is_sqllab_view = Column(Boolean, default=False)
    template_params = Column(Text, nullable=True)

    # 描述
    description = Column(Text, nullable=True)
    description_markeddown = Column(Text, nullable=True)

    # 关系
    database = relationship('Database', backref='tables')
    metrics = relationship('SqlMetric', backref='table', cascade='all, delete-orphan')
    columns = relationship('TableColumn', backref='table', cascade='all, delete-orphan')

    def get_sqla_table(self):
        """获取 SQLAlchemy 表对象"""
        from sqlalchemy import MetaData, Table

        metadata = MetaData()
        engine = self.database.get_sqla_engine()

        table = Table(
            self.table_name,
            metadata,
            autoload=True,
            autoload_with=engine,
            schema=self.schema,
        )

        return table

    def get_metrics(self):
        """获取指标"""
        return self.metrics

    def get_columns(self):
        """获取列"""
        return self.columns

    def get_time_column(self):
        """获取时间列"""
        if self.main_dttm_col:
            return next(
                (col for col in self.columns if col.column_name == self.main_dttm_col),
                None,
            )
        return None
```

### 1.4 表列模型

```python
class TableColumn(Model):
    """表列模型"""
    __tablename__ = 'table_columns'

    # 基本属性
    id = Column(Integer, primary_key=True)
    column_name = Column(String(250), nullable=False)
    is_dttm = Column(Boolean, default=False)
    is_active = Column(Boolean, default=True)

    # 类型
    type = Column(String(50), nullable=True)
    groupby = Column(Boolean, default=True)
    filterable = Column(Boolean, default=True)
    expression = Column(Text, nullable=True)

    # 描述
    description = Column(Text, nullable=True)
    verbose_name = Column(String(250), nullable=True)

    # 外键
    table_id = Column(Integer, ForeignKey('tables.id'), nullable=False)

    # 关系
    table = relationship('SqlaTable', backref='columns')

    def get_metric(self):
        """获取指标"""
        from superset.models.core import SqlMetric

        return SqlMetric(
            metric_name=self.column_name,
            expression_type='SIMPLE',
            expression=self.column_name,
            table=self.table,
        )
```

### 1.5 指标模型

```python
class SqlMetric(Model):
    """指标模型"""
    __tablename__ = 'metrics'

    # 基本属性
    id = Column(Integer, primary_key=True)
    metric_name = Column(String(250), nullable=False)
    verbose_name = Column(String(250), nullable=True)
    metric_type = Column(String(50), nullable=True)

    # 表达式
    expression_type = Column(String(50), nullable=True)
    expression = Column(Text, nullable=True)

    # 描述
    description = Column(Text, nullable=True)
    d3format = Column(String(100), nullable=True)
    currency_format = Column(Boolean, default=False)

    # 外键
    table_id = Column(Integer, ForeignKey('tables.id'), nullable=False)

    # 关系
    table = relationship('SqlaTable', backref='metrics')

    def get_sqla_expression(self):
        """获取 SQLAlchemy 表达式"""
        from sqlalchemy.sql import func

        if self.expression_type == 'SIMPLE':
            return func.sum(self.expression)
        elif self.expression_type == 'AVG':
            return func.avg(self.expression)
        elif self.expression_type == 'COUNT':
            return func.count(self.expression)
        elif self.expression_type == 'MAX':
            return func.max(self.expression)
        elif self.expression_type == 'MIN':
            return func.min(self.expression)
        else:
            return self.expression
```

## 2. 图表模型

### 2.1 图表基础模型

```python
class Slice(Model):
    """图表模型"""
    __tablename__ = 'slices'

    # 基本属性
    id = Column(Integer, primary_key=True)
    slice_name = Column(String(250), unique=True, nullable=False)
    viz_type = Column(String(250), nullable=False)

    # 数据源
    datasource_type = Column(String(50), nullable=False)
    datasource_id = Column(Integer, nullable=False)
    datasource_name = Column(Text, nullable=True)

    # 参数
    params = Column(Text, nullable=True)

    # 描述
    description = Column(Text, nullable=True)
    description_markeddown = Column(Text, nullable=True)

    # 所有者
    owners = relationship('User', secondary=slice_user_table, backref='slices')

    # 创建和修改信息
    created_by = relationship('User', foreign_keys=[created_by_fk])
    changed_by = relationship('User', foreign_keys=[changed_by_fk])
    created_on = Column(DateTime, default=datetime.utcnow)
    changed_on = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # 关系
    dashboards = relationship('Dashboard', secondary=dashboard_slices_table, backref='slices')

    def get_datasource(self):
        """获取数据源"""
        if self.datasource_type == 'table':
            from superset.models.core import SqlaTable
            return db.session.query(SqlaTable).get(self.datasource_id)
        elif self.datasource_type == 'query':
            # 处理查询数据源
            pass

    def get_params(self):
        """获取参数"""
        import json

        if self.params:
            return json.loads(self.params)
        return {}

    def get_query_context(self):
        """获取查询上下文"""
        from superset.common.query_context_factory import QueryContextFactory

        params = self.get_params()
        datasource = self.get_datasource()

        return QueryContextFactory.create(
            datasource=datasource,
            queries=params.get('queries', []),
            form_data=params,
            result_type='full',
            result_format='json',
        )
```

### 2.2 图表数据缓存

```python
class ChartDataCache(Model):
    """图表数据缓存模型"""
    __tablename__ = 'chart_data_cache'

    # 基本属性
    id = Column(Integer, primary_key=True)
    cache_key = Column(String(255), unique=True, nullable=False)
    cache_value = Column(Text, nullable=False)
    cache_timeout = Column(Integer, nullable=False)

    # 时间戳
    created_on = Column(DateTime, default=datetime.utcnow)
    expired_on = Column(DateTime, nullable=False)

    def is_expired(self):
        """检查缓存是否过期"""
        return datetime.utcnow() > self.expired_on

    def get_data(self):
        """获取缓存数据"""
        import json

        if not self.is_expired():
            return json.loads(self.cache_value)
        return None
```

## 3. 仪表板模型

### 3.1 仪表板基础模型

```python
class Dashboard(Model):
    """仪表板模型"""
    __tablename__ = 'dashboards'

    # 基本属性
    id = Column(Integer, primary_key=True)
    dashboard_title = Column(String(500), nullable=False)
    slug = Column(String(255), unique=True, nullable=True)

    # 布局
    position_json = Column(Text, nullable=True)
    json_metadata = Column(Text, nullable=True)
    css = Column(Text, nullable=True)

    # 描述
    description = Column(Text, nullable=True)
    description_markeddown = Column(Text, nullable=True)

    # 所有者
    owners = relationship('User', secondary=dashboard_user_table, backref='dashboards')

    # 创建和修改信息
    created_by = relationship('User', foreign_keys=[created_by_fk])
    changed_by = relationship('User', foreign_keys=[changed_by_fk])
    created_on = Column(DateTime, default=datetime.utcnow)
    changed_on = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # 关系
    slices = relationship('Slice', secondary=dashboard_slices_table, backref='dashboards')

    def get_layout(self):
        """获取布局"""
        import json

        if self.position_json:
            return json.loads(self.position_json)
        return {}

    def get_metadata(self):
        """获取元数据"""
        import json

        if self.json_metadata:
            return json.loads(self.json_metadata)
        return {}

    def get_slices(self):
        """获取图表"""
        return self.slices

    def get_slices_by_position(self):
        """按位置获取图表"""
        layout = self.get_layout()
        slice_ids = []

        for tab in layout.get('DASHBOARD_VERSION_KEY', {}).values():
            for component in tab.get('components', []):
                if component.get('meta', {}).get('chartId'):
                    slice_ids.append(component['meta']['chartId'])

        return [s for s in self.slices if s.id in slice_ids]
```

### 3.2 仪表板过滤器

```python
class DashboardFilter(Model):
    """仪表板过滤器模型"""
    __tablename__ = 'dashboard_filters'

    # 基本属性
    id = Column(Integer, primary_key=True)
    filter_name = Column(String(250), nullable=False)
    filter_type = Column(String(50), nullable=False)

    # 过滤器配置
    targets = Column(Text, nullable=True)
    default_value = Column(Text, nullable=True)
    mandatory = Column(Boolean, default=False)

    # 外键
    dashboard_id = Column(Integer, ForeignKey('dashboards.id'), nullable=False)

    # 关系
    dashboard = relationship('Dashboard', backref='filters')

    def get_targets(self):
        """获取目标"""
        import json

        if self.targets:
            return json.loads(self.targets)
        return []

    def get_default_value(self):
        """获取默认值"""
        import json

        if self.default_value:
            return json.loads(self.default_value)
        return None
```

## 4. 安全模型

### 4.1 用户模型

```python
class User(Model):
    """用户模型"""
    __tablename__ = 'ab_user'

    # 基本属性
    id = Column(Integer, primary_key=True)
    username = Column(String(64), unique=True, nullable=False)
    email = Column(String(255), unique=True, nullable=False)
    first_name = Column(String(64), nullable=True)
    last_name = Column(String(64), nullable=True)

    # 认证
    password = Column(String(255), nullable=False)
    last_login = Column(DateTime, nullable=True)
    login_count = Column(Integer, default=0)

    # 状态
    active = Column(Boolean, default=True)
    is_admin = Column(Boolean, default=False)

    # 关系
    roles = relationship('Role', secondary=ab_user_role_table, backref='users')
    dashboards = relationship('Dashboard', secondary=dashboard_user_table, backref='users')
    slices = relationship('Slice', secondary=slice_user_table, backref='users')

    def has_role(self, role_name):
        """检查是否有角色"""
        return any(role.name == role_name for role in self.roles)

    def has_permission(self, permission_name, view_name):
        """检查是否有权限"""
        for role in self.roles:
            if role.has_permission(permission_name, view_name):
                return True
        return False

    def is_active_user(self):
        """检查是否活跃"""
        return self.active

    def is_admin_user(self):
        """检查是否是管理员"""
        return self.is_admin
```

### 4.2 角色模型

```python
class Role(Model):
    """角色模型"""
    __tablename__ = 'ab_role'

    # 基本属性
    id = Column(Integer, primary_key=True)
    name = Column(String(64), unique=True, nullable=False)

    # 关系
    permissions = relationship('PermissionView', secondary=ab_permission_view_role_table, backref='roles')

    def has_permission(self, permission_name, view_name):
        """检查是否有权限"""
        for pv in self.permissions:
            if pv.permission.name == permission_name and pv.view.name == view_name:
                return True
        return False

    def get_permissions(self):
        """获取权限"""
        return self.permissions
```

### 4.3 权限模型

```python
class Permission(Model):
    """权限模型"""
    __tablename__ = 'ab_permission'

    # 基本属性
    id = Column(Integer, primary_key=True)
    name = Column(String(100), unique=True, nullable=False)

    # 关系
    permission_views = relationship('PermissionView', backref='permission')

class ViewMenu(Model):
    """视图菜单模型"""
    __tablename__ = 'ab_view_menu'

    # 基本属性
    id = Column(Integer, primary_key=True)
    name = Column(String(250), unique=True, nullable=False)

    # 关系
    permission_views = relationship('PermissionView', backref='view')

class PermissionView(Model):
    """权限视图模型"""
    __tablename__ = 'ab_permission_view'

    # 基本属性
    id = Column(Integer, primary_key=True)

    # 外键
    permission_id = Column(Integer, ForeignKey('ab_permission.id'), nullable=False)
    view_id = Column(Integer, ForeignKey('ab_view_menu.id'), nullable=False)

    # 关系
    permission = relationship('Permission')
    view = relationship('ViewMenu')
```

## 5. 查询模型

### 5.1 查询记录模型

```python
class Query(Model):
    """查询记录模型"""
    __tablename__ = 'queries'

    # 基本属性
    id = Column(Integer, primary_key=True)
    client_id = Column(String(11), nullable=False)
    tab_name = Column(String(250), nullable=True)

    # SQL
    sql = Column(Text, nullable=True)
    select_as_cta = Column(Boolean, default=False)
    tmp_table_name = Column(String(250), nullable=True)

    # 数据库
    database_id = Column(Integer, ForeignKey('dbs.id'), nullable=False)
    schema = Column(String(250), nullable=True)

    # 结果
    status = Column(String(16), nullable=True)
    rows = Column(Integer, nullable=True)
    error_message = Column(Text, nullable=True)

    # 时间
    start_time = Column(DateTime, nullable=True)
    end_time = Column(DateTime, nullable=True)
    duration = Column(Float, nullable=True)

    # 用户
    user_id = Column(Integer, ForeignKey('ab_user.id'), nullable=False)

    # 关系
    database = relationship('Database', backref='queries')
    user = relationship('User', backref='queries')

    def get_duration(self):
        """获取执行时长"""
        if self.start_time and self.end_time:
            return (self.end_time - self.start_time).total_seconds()
        return None

    def is_success(self):
        """检查是否成功"""
        return self.status == 'success'

    def is_running(self):
        """检查是否正在运行"""
        return self.status == 'running'
```

## 6. 关系表

### 6.1 多对多关系表

```python
# 用户-角色关系表
ab_user_role_table = Table(
    'ab_user_role',
    Model.metadata,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('ab_user.id')),
    Column('role_id', Integer, ForeignKey('ab_role.id')),
)

# 权限-视图-角色关系表
ab_permission_view_role_table = Table(
    'ab_permission_view_role',
    Model.metadata,
    Column('id', Integer, primary_key=True),
    Column('permission_view_id', Integer, ForeignKey('ab_permission_view.id')),
    Column('role_id', Integer, ForeignKey('ab_role.id')),
)

# 仪表板-用户关系表
dashboard_user_table = Table(
    'dashboard_user',
    Model.metadata,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('ab_user.id')),
    Column('dashboard_id', Integer, ForeignKey('dashboards.id')),
)

# 图表-用户关系表
slice_user_table = Table(
    'slice_user',
    Model.metadata,
    Column('id', Integer, primary_key=True),
    Column('user_id', Integer, ForeignKey('ab_user.id')),
    Column('slice_id', Integer, ForeignKey('slices.id')),
)

# 仪表板-图表关系表
dashboard_slices_table = Table(
    'dashboard_slices',
    Model.metadata,
    Column('id', Integer, primary_key=True),
    Column('dashboard_id', Integer, ForeignKey('dashboards.id')),
    Column('slice_id', Integer, ForeignKey('slices.id')),
)
```

## 7. 模型使用示例

### 7.1 创建数据库连接

```python
from superset.models.core import Database
from superset.extensions import db

# 创建数据库连接
database = Database(
    database_name='My Database',
    sqlalchemy_uri='postgresql://user:password@localhost:5432/mydb',
    verbose_name='我的数据库',
    allow_ctas=True,
    allow_cvas=True,
)

db.session.add(database)
db.session.commit()
```

### 7.2 创建数据表

```python
from superset.models.core import SqlaTable, TableColumn, SqlMetric

# 创建数据表
table = SqlaTable(
    table_name='users',
    schema='public',
    main_dttm_col='created_at',
    database_id=database.id,
    description='用户表',
)

# 创建列
column1 = TableColumn(
    column_name='id',
    type='INTEGER',
    is_dttm=False,
    table=table,
)

column2 = TableColumn(
    column_name='name',
    type='VARCHAR',
    is_dttm=False,
    table=table,
)

column3 = TableColumn(
    column_name='created_at',
    type='TIMESTAMP',
    is_dttm=True,
    table=table,
)

# 创建指标
metric = SqlMetric(
    metric_name='total_users',
    expression_type='COUNT',
    expression='id',
    table=table,
)

db.session.add_all([table, column1, column2, column3, metric])
db.session.commit()
```

### 7.3 创建图表

```python
from superset.models.core import Slice
import json

# 创建图表
chart = Slice(
    slice_name='用户增长趋势',
    viz_type='line',
    datasource_type='table',
    datasource_id=table.id,
    params=json.dumps({
        'metrics': ['total_users'],
        'groupby': ['created_at'],
        'granularity': 'day',
        'time_range': '30 days ago',
    }),
    description='展示用户增长趋势',
)

db.session.add(chart)
db.session.commit()
```

### 7.4 创建仪表板

```python
from superset.models.core import Dashboard
import json

# 创建仪表板
dashboard = Dashboard(
    dashboard_title='用户分析仪表板',
    slug='user-analytics',
    position_json=json.dumps({
        'DASHBOARD_VERSION_KEY': {
            'common': {
                'components': [
                    {
                        'id': 'chart1',
                        'meta': {
                            'chartId': chart.id,
                            'width': 12,
                            'height': 6,
                        },
                    },
                ],
            },
        },
    }),
    description='用户数据分析仪表板',
)

# 添加图表
dashboard.slices.append(chart)

db.session.add(dashboard)
db.session.commit()
```

## 8. 下一步

阅读完本文档后，建议继续学习：

1. [核心模块](./06-核心模块.md) - 学习核心业务模块
2. [查询引擎](./07-查询引擎.md) - 学习查询处理机制
3. [后端架构](./04-后端架构.md) - 学习后端架构设计
