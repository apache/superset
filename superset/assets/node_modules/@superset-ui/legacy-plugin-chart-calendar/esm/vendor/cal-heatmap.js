// [LICENSE TBD]
/* Copied and altered from http://cal-heatmap.com/ , alterations around:
 * - tuning tooltips
 * - supporting multi-colors scales
 * - legend format
 * - UTC handling
 */ /* eslint-disable */import d3tip from"d3-tip";import"./d3tip.css";var d3="function"==typeof require?require("d3"):window.d3,d3="function"==typeof require?require("d3"):window.d3,CalHeatMap=function(){'use strict';function e(){n.verticalDomainLabel="top"===n.options.label.position||"bottom"===n.options.label.position,n.domainVerticalLabelHeight=null===n.options.label.height?Math.max(25,2*n.options.cellSize):n.options.label.height,n.domainHorizontalLabelWidth=0,""===n.options.domainLabelFormat&&null===n.options.label.height&&(n.domainVerticalLabelHeight=0),n.verticalDomainLabel||(n.domainVerticalLabelHeight=0,n.domainHorizontalLabelWidth=n.options.label.width),n.paint(),!1!==n.options.nextSelector&&d3.select(n.options.nextSelector).on("click."+n.options.itemNamespace,function(){return d3.event.preventDefault(),n.loadNextDomain(1)}),!1!==n.options.previousSelector&&d3.select(n.options.previousSelector).on("click."+n.options.itemNamespace,function(){return d3.event.preventDefault(),n.loadPreviousDomain(1)}),n.Legend.redraw(n.graphDim.width-n.options.domainGutter-n.options.cellPadding),n.afterLoad();var e=n.getDomainKeys();// Fill the graph with some datas
n.options.loadOnInit?n.getDatas(n.options.data,new Date(e[0]),n.getSubDomain(e[e.length-1]).pop(),function(){n.fill(),n.onComplete()}):n.onComplete(),n.checkIfMinDomainIsReached(e[0]),n.checkIfMaxDomainIsReached(n.getNextDomain().getTime())}// Return the width of the domain block, without the domain gutter
// @param int d Domain start timestamp
function t(e,t){var o=n.options.cellSize*n._domainType[n.options.subDomain].column(e)+n.options.cellPadding*n._domainType[n.options.subDomain].column(e);return 2===arguments.length&&!0===t?o+=n.domainHorizontalLabelWidth+n.options.domainGutter+n.options.domainMargin[1]+n.options.domainMargin[3]:o}// Return the height of the domain block, without the domain gutter
function o(e,t){var o=n.options.cellSize*n._domainType[n.options.subDomain].row(e)+n.options.cellPadding*n._domainType[n.options.subDomain].row(e);return 2===arguments.length&&!0===t&&(o+=n.options.domainGutter+n.domainVerticalLabelHeight+n.options.domainMargin[0]+n.options.domainMargin[2]),o}/**
   *
   *
   * @param int navigationDir
   */var n=this;for(var i in n.tip=d3tip().attr("class","d3-tip").direction("n").offset([-5,0]).html(function(e){return"\n      "+n.options.timeFormatter(e.t)+": <strong>"+n.options.valueFormatter(e.v)+"</strong>\n    "}),n.legendTip=d3tip().attr("class","d3-tip").direction("n").offset([-5,0]).html(function(e){return n.options.valueFormatter(e)}),this.allowedDataType=["json","csv","tsv","txt"],this.options={// selector string of the container to append the graph to
// Accept any string value accepted by document.querySelector or CSS3
// or an Element object
itemSelector:"#cal-heatmap",// Whether to paint the calendar on init()
// Used by testsuite to reduce testing time
paintOnLoad:!0,// ================================================
// DOMAIN
// ================================================
// Number of domain to display on the graph
range:12,// Size of each cell, in pixel
cellSize:10,// Padding between each cell, in pixel
cellPadding:2,// For rounded subdomain rectangles, in pixels
cellRadius:0,domainGutter:2,domainMargin:[0,0,0,0],valueFormatter:function t(e){return e},timeFormatter:function t(e){return e},domain:"hour",subDomain:"min",// Number of columns to split the subDomains to
// If not null, will takes precedence over rowLimit
colLimit:null,// Number of rows to split the subDomains to
// Will be ignored if colLimit is not null
rowLimit:null,// First day of the week is Monday
// 0 to start the week on Sunday
weekStartOnMonday:!0,// Start date of the graph
// @default now
start:new Date,minDate:null,maxDate:null,// ================================================
// DATA
// ================================================
// Data source
// URL, where to fetch the original datas
data:"",// Data type
// Default: json
dataType:this.allowedDataType[0],// Payload sent when using POST http method
// Leave to null (default) for GET request
// Expect a string, formatted like "a=b;c=d"
dataPostPayload:null,// Additional headers sent when requesting data
// Expect an object formatted like:
// { 'X-CSRF-TOKEN': 'token' }
dataRequestHeaders:null,// Whether to consider missing date:value from the datasource
// as equal to 0, or just leave them as missing
considerMissingDataAsZero:!1,// Load remote data on calendar creation
// When false, the calendar will be left empty
loadOnInit:!0,// Calendar orientation
// false: display domains side by side
// true : display domains one under the other
verticalOrientation:!1,// Domain dynamic width/height
// The width on a domain depends on the number of
domainDynamicDimension:!0,// Domain Label properties
label:{// valid: top, right, bottom, left
position:"bottom",// Valid: left, center, right
// Also valid are the direct svg values: start, middle, end
align:"center",// By default, there is no margin/padding around the label
offset:{x:0,y:0},rotate:null,// Used only on vertical orientation
width:100,// Used only on horizontal orientation
height:null},// ================================================
// LEGEND
// ================================================
// Threshold for the legend
legend:[10,20,30,40],// Whether to display the legend
displayLegend:!0,legendCellSize:10,legendCellPadding:2,legendMargin:[0,0,0,0],// Legend vertical position
// top: place legend above calendar
// bottom: place legend below the calendar
legendVerticalPosition:"bottom",// Legend horizontal position
// accepted values: left, center, right
legendHorizontalPosition:"left",// Legend rotation
// accepted values: horizontal, vertical
legendOrientation:"horizontal",// Objects holding all the heatmap different colors
// null to disable, and use the default css styles
//
// Examples:
// legendColors: {
//    min: "green",
//    max: "red",
//    empty: "#ffffff",
//    base: "grey",
//    overflow: "red",
//    colorScaler: null,
// }
legendColors:null,// ================================================
// HIGHLIGHT
// ================================================
// List of dates to highlight
// Valid values:
// - []: don't highlight anything
// - "now": highlight the current date
// - an array of Date objects: highlight the specified dates
highlight:[],// ================================================
// TEXT FORMATTING / i18n
// ================================================
// Name of the items to represent in the calendar
itemName:["item","items"],// Formatting of the domain label
// @default: null, will use the formatting according to domain type
// Accept a string used as specifier by d3.time.format()
// or a function
//
// Refer to https://github.com/mbostock/d3/wiki/Time-Formatting
// for accepted date formatting used by d3.time.format()
domainLabelFormat:null,// Formatting of the title displayed when hovering a subDomain cell
subDomainTitleFormat:{empty:"{date}",filled:"{count} {name} {connector} {date}"},// Formatting of the {date} used in subDomainTitleFormat
// @default: null, will use the formatting according to subDomain type
// Accept a string used as specifier by d3.time.format()
// or a function
//
// Refer to https://github.com/mbostock/d3/wiki/Time-Formatting
// for accepted date formatting used by d3.time.format()
subDomainDateFormat:null,// Formatting of the text inside each subDomain cell
// @default: null, no text
// Accept a string used as specifier by d3.time.format()
// or a function
//
// Refer to https://github.com/mbostock/d3/wiki/Time-Formatting
// for accepted date formatting used by d3.time.format()
subDomainTextFormat:null,// Formatting of the title displayed when hovering a legend cell
legendTitleFormat:{lower:"less than {min} {name}",inner:"between {down} and {up} {name}",upper:"more than {max} {name}"},// Animation duration, in ms
animationDuration:500,nextSelector:!1,previousSelector:!1,itemNamespace:"cal-heatmap",tooltip:!1,// ================================================
// EVENTS CALLBACK
// ================================================
// Callback when clicking on a time block
onClick:null,// Callback after painting the empty calendar
// Can be used to trigger an API call, once the calendar is ready to be filled
afterLoad:null,// Callback after loading the next domain in the calendar
afterLoadNextDomain:null,// Callback after loading the previous domain in the calendar
afterLoadPreviousDomain:null,// Callback after finishing all actions on the calendar
onComplete:null,// Callback after fetching the datas, but before applying them to the calendar
// Used mainly to convert the datas if they're not formatted like expected
// Takes the fetched "data" object as argument, must return a json object
// formatted like {timestamp:count, timestamp2:count2},
afterLoadData:function t(e){return e},// Callback triggered after calling and completing update().
afterUpdate:null,// Callback triggered after calling next().
// The `status` argument is equal to true if there is no
// more next domain to load
//
// This callback is also executed once, after calling previous(),
// only when the max domain is reached
onMaxDomainReached:null,// Callback triggered after calling previous().
// The `status` argument is equal to true if there is no
// more previous domain to load
//
// This callback is also executed once, after calling next(),
// only when the min domain is reached
onMinDomainReached:null},this._domainType={min:{name:"minute",level:10,maxItemNumber:60,defaultRowNumber:10,defaultColumnNumber:6,row:function t(e){return n.getSubDomainRowNumber(e)},column:function t(e){return n.getSubDomainColumnNumber(e)},position:{x:function t(e){return Math.floor(e.getMinutes()/n._domainType.min.row(e))},y:function t(e){return e.getMinutes()%n._domainType.min.row(e)}},format:{date:"%H:%M, %A %B %-e, %Y",legend:"",connector:"at"},extractUnit:function t(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes()).getTime()}},hour:{name:"hour",level:20,maxItemNumber:function t(e){switch(n.options.domain){case"day":return 24;case"week":return 7*24;case"month":return 24*(n.options.domainDynamicDimension?n.getDayCountInMonth(e):31);}},defaultRowNumber:6,defaultColumnNumber:function t(e){switch(n.options.domain){case"day":return 4;case"week":return 28;case"month":return n.options.domainDynamicDimension?n.getDayCountInMonth(e):31;}},row:function t(e){return n.getSubDomainRowNumber(e)},column:function t(e){return n.getSubDomainColumnNumber(e)},position:{x:function t(e){return"month"===n.options.domain?0<n.options.colLimit||0<n.options.rowLimit?Math.floor((e.getHours()+24*(e.getDate()-1))/n._domainType.hour.row(e)):Math.floor(e.getHours()/n._domainType.hour.row(e))+4*(e.getDate()-1):"week"===n.options.domain?0<n.options.colLimit||0<n.options.rowLimit?Math.floor((e.getHours()+24*n.getWeekDay(e))/n._domainType.hour.row(e)):Math.floor(e.getHours()/n._domainType.hour.row(e))+4*n.getWeekDay(e):Math.floor(e.getHours()/n._domainType.hour.row(e))},y:function o(e){var t=e.getHours();if(0<n.options.colLimit||0<n.options.rowLimit)switch(n.options.domain){case"month":t+=24*(e.getDate()-1);break;case"week":t+=24*n.getWeekDay(e);}return Math.floor(t%n._domainType.hour.row(e))}},format:{date:"%Hh, %A %B %-e, %Y",legend:"%H:00",connector:"at"},extractUnit:function t(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()).getTime()}},day:{name:"day",level:30,maxItemNumber:function t(e){switch(n.options.domain){case"week":return 7;case"month":return n.options.domainDynamicDimension?n.getDayCountInMonth(e):31;case"year":return n.options.domainDynamicDimension?n.getDayCountInYear(e):366;}},defaultColumnNumber:function t(e){switch(e=new Date(e),n.options.domain){case"week":return 1;case"month":return n.options.domainDynamicDimension&&!n.options.verticalOrientation?n.getWeekNumber(new Date(e.getFullYear(),e.getMonth()+1,0))-n.getWeekNumber(e)+1:6;case"year":return n.options.domainDynamicDimension?n.getWeekNumber(new Date(e.getFullYear(),11,31))-n.getWeekNumber(new Date(e.getFullYear(),0))+1:54;}},defaultRowNumber:7,row:function t(e){return n.getSubDomainRowNumber(e)},column:function t(e){return n.getSubDomainColumnNumber(e)},position:{x:function t(e){switch(n.options.domain){case"week":return Math.floor(n.getWeekDay(e)/n._domainType.day.row(e));case"month":return 0<n.options.colLimit||0<n.options.rowLimit?Math.floor((e.getDate()-1)/n._domainType.day.row(e)):n.getWeekNumber(e)-n.getWeekNumber(new Date(e.getFullYear(),e.getMonth()));case"year":return 0<n.options.colLimit||0<n.options.rowLimit?Math.floor((n.getDayOfYear(e)-1)/n._domainType.day.row(e)):n.getWeekNumber(e);}},y:function o(e){var t=n.getWeekDay(e);if(0<n.options.colLimit||0<n.options.rowLimit)switch(n.options.domain){case"year":t=n.getDayOfYear(e)-1;break;case"week":t=n.getWeekDay(e);break;case"month":t=e.getDate()-1;}return Math.floor(t%n._domainType.day.row(e))}},format:{date:"%A %B %-e, %Y",legend:"%e %b",connector:"on"},extractUnit:function t(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime()}},week:{name:"week",level:40,maxItemNumber:54,defaultColumnNumber:function t(e){switch(e=new Date(e),n.options.domain){case"year":return n._domainType.week.maxItemNumber;case"month":return n.options.domainDynamicDimension?n.getWeekNumber(new Date(e.getFullYear(),e.getMonth()+1,0))-n.getWeekNumber(e):5;}},defaultRowNumber:1,row:function t(e){return n.getSubDomainRowNumber(e)},column:function t(e){return n.getSubDomainColumnNumber(e)},position:{x:function t(e){switch(n.options.domain){case"year":return Math.floor(n.getWeekNumber(e)/n._domainType.week.row(e));case"month":return Math.floor(n.getMonthWeekNumber(e)/n._domainType.week.row(e));}},y:function t(e){return n.getWeekNumber(e)%n._domainType.week.row(e)}},format:{date:"%B Week #%W",legend:"%B Week #%W",connector:"in"},extractUnit:function i(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),o=t.getDay()-(n.options.weekStartOnMonday?1:0);// According to ISO-8601, week number computation are based on week starting on Monday
return 0>o&&(o=6),t.setDate(t.getDate()-o),t.getTime()}},month:{name:"month",level:50,maxItemNumber:12,defaultColumnNumber:12,defaultRowNumber:1,row:function e(){return n.getSubDomainRowNumber()},column:function e(){return n.getSubDomainColumnNumber()},position:{x:function t(e){return Math.floor(e.getMonth()/n._domainType.month.row(e))},y:function t(e){return e.getMonth()%n._domainType.month.row(e)}},format:{date:"%B %Y",legend:"%B",connector:"in"},extractUnit:function t(e){return new Date(e.getFullYear(),e.getMonth()).getTime()}},year:{name:"year",level:60,row:function e(){return n.options.rowLimit||1},column:function e(){return n.options.colLimit||1},position:{x:function e(){return 1},y:function e(){return 1}},format:{date:"%Y",legend:"%Y",connector:"in"},extractUnit:function t(e){return new Date(e.getFullYear()).getTime()}}},this._domainType)if(this._domainType.hasOwnProperty(i)){var a=this._domainType[i];this._domainType["x_"+i]={name:"x_"+i,level:a.type,maxItemNumber:a.maxItemNumber,defaultRowNumber:a.defaultRowNumber,defaultColumnNumber:a.defaultColumnNumber,row:a.column,column:a.row,position:{x:a.position.y,y:a.position.x},format:a.format,extractUnit:a.extractUnit}}// Record the address of the last inserted domain when browsing
this.lastInsertedSvg=null,this._completed=!1,this._domains=d3.map(),this.graphDim={width:0,height:0},this.legendDim={width:0,height:0},this.NAVIGATE_LEFT=1,this.NAVIGATE_RIGHT=2,this.RESET_ALL_ON_UPDATE=0,this.RESET_SINGLE_ON_UPDATE=1,this.APPEND_ON_UPDATE=2,this.DEFAULT_LEGEND_MARGIN=10,this.root=null,this.tooltip=null,this._maxDomainReached=!1,this._minDomainReached=!1,this.domainPosition=new DomainPosition,this.Legend=null,this.legendScale=null,this.DSTDomain=[],this._init=function(){return n.getDomain(n.options.start).map(function(e){return e.getTime()}).map(function(e){n._domains.set(e,n.getSubDomain(e).map(function(e){return{t:n._domainType[n.options.subDomain].extractUnit(e),v:null}}))}),n.root=d3.select(n.options.itemSelector).append("svg").attr("class","cal-heatmap-container"),n.root.attr("x",0).attr("y",0).append("svg").attr("class","graph"),n.Legend=new Legend(n),n.options.paintOnLoad&&e(),n.root.call(n.tip),n.root.call(n.legendTip),!0},this.paint=function(e){function i(t,o,i,a){var r=0;return!1===e?(r=o[i],o[i]+=a,n.domainPosition.setPosition(t,r),r):e===n.NAVIGATE_RIGHT?(n.domainPosition.setPosition(t,o[i]),d=a,m=n.domainPosition.getPositionFromIndex(1),n.domainPosition.shiftRightBy(m),o[i]):e===n.NAVIGATE_LEFT?(r=-a,d=-r,m=o[i]-n.domainPosition.getLast(),n.domainPosition.setPosition(t,r),n.domainPosition.shiftLeftBy(d),r):void 0}var r=n.options;0===arguments.length&&(e=!1);// Painting all the domains
var l=n.root.select(".graph").selectAll(".graph-domain").data(function(){var t=n.getDomainKeys();return e===n.NAVIGATE_LEFT?t.reverse():t},function(e){return e}),d=0,m=0,s=l.enter().append("svg").attr("width",function(e){return t(e,!0)}).attr("height",function(e){return o(e,!0)}).attr("x",function(e){return r.verticalOrientation?(n.graphDim.width=Math.max(n.graphDim.width,t(e,!0)),0):i(e,n.graphDim,"width",t(e,!0))}).attr("y",function(e){return r.verticalOrientation?i(e,n.graphDim,"height",o(e,!0)):(n.graphDim.height=Math.max(n.graphDim.height,o(e,!0)),0)}).attr("class",function(e){var t="graph-domain",o=new Date(e);switch(r.domain){case"hour":t+=" h_"+o.getHours();/* falls through */case"day":t+=" d_"+o.getDate()+" dy_"+o.getDay();/* falls through */case"week":t+=" w_"+n.getWeekNumber(o);/* falls through */case"month":t+=" m_"+(o.getMonth()+1);/* falls through */case"year":t+=" y_"+o.getFullYear();}return t});n.lastInsertedSvg=s,s.append("rect").attr("width",function(e){return t(e,!0)-r.domainGutter-r.cellPadding}).attr("height",function(e){return o(e,!0)-r.domainGutter-r.cellPadding}).attr("class","domain-background");// =========================================================================//
// PAINTING SUBDOMAINS                            //
// =========================================================================//
var g=s.append("svg").attr("x",function(){return"left"===r.label.position?n.domainHorizontalLabelWidth+r.domainMargin[3]:r.domainMargin[3]}).attr("y",function(){return"top"===r.label.position?n.domainVerticalLabelHeight+r.domainMargin[0]:r.domainMargin[0]}).attr("class","graph-subdomain-group"),p=g.selectAll("g").data(function(e){return n._domains.get(e)}).enter().append("g");p.append("rect").attr("class",function(e){return"graph-rect"+n.getHighlightClassName(e.t)+(null===r.onClick?"":" hover_cursor")}).attr("width",r.cellSize).attr("height",r.cellSize).attr("x",function(e){return n.positionSubDomainX(e.t)}).attr("y",function(e){return n.positionSubDomainY(e.t)}).on("click",function(e){if(null!==r.onClick)return n.onClick(new Date(e.t),e.v)}).call(function(e){0<r.cellRadius&&e.attr("rx",r.cellRadius).attr("ry",r.cellRadius),null!==n.legendScale&&null!==r.legendColors&&r.legendColors.hasOwnProperty("base")&&e.attr("fill",r.legendColors.base),r.tooltip&&e.on("mouseover",function(e){n.tip.show(e,this)}).on("mouseout",function(){n.tip.hide(a)})}),r.tooltip||p.append("title").text(function(e){return n.formatDate(new Date(e.t),r.subDomainDateFormat)}),""!==r.domainLabelFormat&&s.append("text").attr("class","graph-label").attr("y",function(e){var t=r.domainMargin[0];switch(r.label.position){case"top":t+=n.domainVerticalLabelHeight/2;break;case"bottom":t+=o(e)+n.domainVerticalLabelHeight/2;}return t+r.label.offset.y*("right"===r.label.rotate&&"right"===r.label.position||"left"===r.label.rotate&&"left"===r.label.position?-1:1)}).attr("x",function(e){var o=r.domainMargin[3];switch(r.label.position){case"right":o+=t(e);break;case"bottom":case"top":o+=t(e)/2;}return"right"===r.label.align?o+n.domainHorizontalLabelWidth-r.label.offset.x*("right"===r.label.rotate?-1:1):o+r.label.offset.x}).attr("text-anchor",function(){switch(r.label.align){case"start":case"left":return"start";case"end":case"right":return"end";default:return"middle";}}).attr("dominant-baseline",function(){return n.verticalDomainLabel?"middle":"top"}).text(function(e){return n.formatDate(new Date(e),r.domainLabelFormat)}).call(function(e){switch(r.label.rotate){case"right":e.attr("transform",function(e){var o="rotate(90), ";switch(r.label.position){case"right":o+="translate(-"+t(e)+" , -"+t(e)+")";break;case"left":o+="translate(0, -"+n.domainHorizontalLabelWidth+")";}return o});break;case"left":e.attr("transform",function(e){var o="rotate(270), ";switch(r.label.position){case"right":o+="translate(-"+(t(e)+n.domainHorizontalLabelWidth)+" , "+t(e)+")";break;case"left":o+="translate(-"+n.domainHorizontalLabelWidth+" , "+n.domainHorizontalLabelWidth+")";}return o});}}// =========================================================================//
// PAINTING DOMAIN SUBDOMAIN CONTENT                    //
// =========================================================================//
),null!==r.subDomainTextFormat&&p.append("text").attr("class",function(e){return"subdomain-text"+n.getHighlightClassName(e.t)}).attr("x",function(e){return n.positionSubDomainX(e.t)+r.cellSize/2}).attr("y",function(e){return n.positionSubDomainY(e.t)+r.cellSize/2}).attr("text-anchor","middle").attr("dominant-baseline","central").text(function(e){return n.formatDate(new Date(e.t),r.subDomainTextFormat)}),!1!==e&&l.transition().duration(r.animationDuration).attr("x",function(e){return r.verticalOrientation?0:n.domainPosition.getPosition(e)}).attr("y",function(e){return r.verticalOrientation?n.domainPosition.getPosition(e):0});var u=n.graphDim.width,h=n.graphDim.height;r.verticalOrientation?n.graphDim.height+=d-m:n.graphDim.width+=d-m,l.exit().transition().duration(r.animationDuration).attr("x",function(o){return r.verticalOrientation?0:e===n.NAVIGATE_LEFT?Math.min(n.graphDim.width,u):e===n.NAVIGATE_RIGHT?-t(o,!0):void 0}).attr("y",function(t){if(r.verticalOrientation)switch(e){case n.NAVIGATE_LEFT:return Math.min(n.graphDim.height,h);case n.NAVIGATE_RIGHT:return-o(t,!0);}else return 0}).remove(),n.resize()}};CalHeatMap.prototype={/**
   * Validate and merge user settings with default settings
   *
   * @param  {object} settings User settings
   * @return {bool} False if settings contains error
   */ /* jshint maxstatements:false */init:function l(e){'use strict';/**
     * Validate that a queryString is valid
     *
     * @param  {Element|string|bool} selector   The queryString to test
     * @param  {bool}  canBeFalse  Whether false is an accepted and valid value
     * @param  {string} name    Name of the tested selector
     * @throws {Error}        If the selector is not valid
     * @return {bool}        True if the selector is a valid queryString
     */function t(e,t,o){if((t&&!1===e||e instanceof Element||"string"==typeof e)&&""!==e)return!0;throw new Error("The "+o+" is not valid")}/**
     * Return the optimal subDomain for the specified domain
     *
     * @param  {string} domain a domain name
     * @return {string}        the subDomain name
     */ /**
     * Expand a number of an array of numbers to an usable 4 values array
     *
     * @param  {integer|array} value
     * @return {array}        array
     */function o(e){switch("number"==typeof e&&(e=[e]),Array.isArray(e)||(console.log("Margin only takes an integer or an array of integers"),e=[0]),e.length){case 1:return[e[0],e[0],e[0],e[0]];case 2:return[e[0],e[1],e[0],e[1]];case 3:return[e[0],e[1],e[2],e[1]];case 4:return e;default:return e.slice(0,4);}}/**
     * Convert a string to an array like [singular-form, plural-form]
     *
     * @param  {string|array} value Date to convert
     * @return {array}       An array like [singular-form, plural-form]
     */var n=this,i=n.options=mergeRecursive(n.options,e);if(/**
     * Ensure that the domain and subdomain are valid
     *
     * @throw {Error} when domain or subdomain are not valid
     * @return {bool} True if domain and subdomain are valid and compatible
     */function(){if(!n._domainType.hasOwnProperty(i.domain)||"min"===i.domain||"x_"===i.domain.substring(0,2))throw new Error("The domain '"+i.domain+"' is not valid");if(!n._domainType.hasOwnProperty(i.subDomain)||"year"===i.subDomain)throw new Error("The subDomain '"+i.subDomain+"' is not valid");if(n._domainType[i.domain].level<=n._domainType[i.subDomain].level)throw new Error("'"+i.subDomain+"' is not a valid subDomain to '"+i.domain+"'");return!0}/**
     * Fine-tune the label alignement depending on its position
     *
     * @return void
     */(),t(i.itemSelector,!1,"itemSelector"),-1===n.allowedDataType.indexOf(i.dataType))throw new Error("The data type '"+i.dataType+"' is not valid data type");if(null===d3.select(i.itemSelector)[0][0])throw new Error("The node '"+i.itemSelector+"' specified in itemSelector does not exists");try{t(i.nextSelector,!0,"nextSelector"),t(i.previousSelector,!0,"previousSelector")}catch(e){return console.log(e.message),!1}// If other settings contains error, will fallback to default
e.hasOwnProperty("subDomain")||(this.options.subDomain=function(e){return"year"===e?"month":"month"===e?"day":"week"===e?"day":"day"===e?"hour":"min"}(e.domain)),("string"!=typeof i.itemNamespace||""===i.itemNamespace)&&(console.log("itemNamespace can not be empty, falling back to cal-heatmap"),i.itemNamespace="cal-heatmap");// Don't touch these settings
var a=["data","onComplete","onClick","afterLoad","afterLoadData","afterLoadPreviousDomain","afterLoadNextDomain","afterUpdate"];for(var r in a)e.hasOwnProperty(a[r])&&(i[a[r]]=e[a[r]]);return i.subDomainDateFormat="string"==typeof i.subDomainDateFormat||"function"==typeof i.subDomainDateFormat?i.subDomainDateFormat:this._domainType[i.subDomain].format.date,i.domainLabelFormat="string"==typeof i.domainLabelFormat||"function"==typeof i.domainLabelFormat?i.domainLabelFormat:this._domainType[i.domain].format.legend,i.subDomainTextFormat="string"==typeof i.subDomainTextFormat&&""!==i.subDomainTextFormat||"function"==typeof i.subDomainTextFormat?i.subDomainTextFormat:null,i.domainMargin=o(i.domainMargin),i.legendMargin=o(i.legendMargin),i.highlight=n.expandDateSetting(i.highlight),i.itemName=function(e){return"string"==typeof e?[e,e+(""===e?"":"s")]:Array.isArray(e)?1===e.length?[e[0],e[0]+"s"]:2<e.length?e.slice(0,2):e:["item","items"]}(i.itemName),i.colLimit=function(e){return 0<e?e:null}(i.colLimit),i.rowLimit=function(e){return 0<e&&0<i.colLimit?(console.log("colLimit and rowLimit are mutually exclusive, rowLimit will be ignored"),null):0<e?e:null}(i.rowLimit),e.hasOwnProperty("legendMargin")||/**
     * If not specified, add some margin around the legend depending on its position
     *
     * @return void
     */function(){switch(i.legendVerticalPosition){case"top":i.legendMargin[2]=n.DEFAULT_LEGEND_MARGIN;break;case"bottom":i.legendMargin[0]=n.DEFAULT_LEGEND_MARGIN;break;case"middle":case"center":i.legendMargin["right"===i.legendHorizontalPosition?3:1]=n.DEFAULT_LEGEND_MARGIN;}}(),function(){// Auto-align label, depending on it's position
if(!e.hasOwnProperty("label")||e.hasOwnProperty("label")&&!e.label.hasOwnProperty("align")){switch(i.label.position){case"left":i.label.align="right";break;case"right":i.label.align="left";break;default:i.label.align="center";}"left"===i.label.rotate?i.label.align="right":"right"===i.label.rotate&&(i.label.align="left")}e.hasOwnProperty("label")&&(!e.hasOwnProperty("label")||e.label.hasOwnProperty("offset"))||"left"!==i.label.position&&"right"!==i.label.position||(i.label.offset={x:10,y:15})}(),this._init()},/**
   * Convert a keyword or an array of keyword/date to an array of date objects
   *
   * @param  {string|array|Date} value Data to convert
   * @return {array}       An array of Dates
   */expandDateSetting:function t(e){'use strict';return Array.isArray(e)||(e=[e]),e.map(function(e){return"now"===e?new Date:!!(e instanceof Date)&&e}).filter(function(e){return!1!==e})},/**
   * Fill the calendar by coloring the cells
   *
   * @param array svg An array of html node to apply the transformation to (optional)
   *                  It's used to limit the painting to only a subset of the calendar
   * @return void
   */fill:function i(e){'use strict';/**
     * Colorize the cell via a style attribute if enabled
     */var t=this,o=t.options;0===arguments.length&&(e=t.root.selectAll(".graph-domain"));var n=e.selectAll("svg").selectAll("g").data(function(e){return t._domains.get(e)});/**
     * Change the subDomainText class if necessary
     * Also change the text, e.g when text is representing the value
     * instead of the date
     */n.transition().duration(o.animationDuration).select("rect").attr("class",function(e){var n=t.getHighlightClassName(e.t).trim().split(" "),i=t.dateIsLessThan(e.t,new Date),a=t.dateIsEqual(e.t,new Date);return null!==t.legendScale&&(null!==e.v||!o.hasOwnProperty("considerMissingDataAsZero")||o.considerMissingDataAsZero||o.legendColors.hasOwnProperty("base"))||n.push("graph-rect"),a?n.push("now"):!i&&n.push("future"),null===e.v?o.considerMissingDataAsZero&&i&&n.push(t.Legend.getClass(0,null===t.legendScale)):n.push(t.Legend.getClass(e.v,null===t.legendScale)),null!==o.onClick&&n.push("hover_cursor"),n.join(" ")}).call(function(e){return null!==t.legendScale&&void e.attr("fill",function(e){return null===e.v&&o.hasOwnProperty("considerMissingDataAsZero")&&!o.considerMissingDataAsZero&&o.legendColors.hasOwnProperty("base")?o.legendColors.base:null!==o.legendColors&&o.legendColors.hasOwnProperty("empty")&&(0===e.v||null===e.v&&o.hasOwnProperty("considerMissingDataAsZero")&&o.considerMissingDataAsZero)?o.legendColors.empty:0>e.v&&0<o.legend[0]&&null!==o.legendColors&&o.legendColors.hasOwnProperty("overflow")?o.legendColors.overflow:t.legendScale(Math.min(e.v,o.legend[o.legend.length-1]))})}),n.transition().duration(o.animationDuration).select("title").text(function(e){return t.getSubDomainTitle(e)}),n.transition().duration(o.animationDuration).select("text").attr("class",function(e){return"subdomain-text"+t.getHighlightClassName(e.t)}).call(function(e){"function"==typeof o.subDomainTextFormat&&e.text(function(e){return o.subDomainTextFormat(e.t,e.v)})})},/**
   * Sprintf like function.
   * Replaces placeholders {0} in string with values from provided object.
   *
   * @param string formatted String containing placeholders.
   * @param object args Object with properties to replace placeholders in string.
   *
   * @return String
   */formatStringWithObject:function i(e,t){'use strict';for(var o in t)if(t.hasOwnProperty(o)){var n=new RegExp("\\{"+o+"\\}","gi");e=e.replace(n,t[o])}return e},// =========================================================================//
// EVENTS CALLBACK                              //
// =========================================================================//
/**
   * Helper method for triggering event callback
   *
   * @param  string  eventName       Name of the event to trigger
   * @param  array  successArgs     List of argument to pass to the callback
   * @param  boolean  skip      Whether to skip the event triggering
   * @return mixed  True when the triggering was skipped, false on error, else the callback function
   */triggerEvent:function n(e,t,o){'use strict';return!!(3===arguments.length&&o||null===this.options[e])||("function"==typeof this.options[e]?("function"==typeof t&&(t=t()),this.options[e].apply(this,t)):(console.log("Provided callback for "+e+" is not a function."),!1))},/**
   * Event triggered on a mouse click on a subDomain cell
   *
   * @param  Date    d    Date of the subdomain block
   * @param  int    itemNb  Number of items in that date
   */onClick:function o(e,t){'use strict';return this.triggerEvent("onClick",[e,t])},/**
   * Event triggered after drawing the calendar, byt before filling it with data
   */afterLoad:function e(){'use strict';return this.triggerEvent("afterLoad")},/**
   * Event triggered after completing drawing and filling the calendar
   */onComplete:function t(){'use strict';var e=this.triggerEvent("onComplete",[],this._completed);return this._completed=!0,e},/**
   * Event triggered after shifting the calendar one domain back
   *
   * @param  Date    start  Domain start date
   * @param  Date    end    Domain end date
   */afterLoadPreviousDomain:function o(e){'use strict';var t=this;return this.triggerEvent("afterLoadPreviousDomain",function(){var o=t.getSubDomain(e);return[o.shift(),o.pop()]})},/**
   * Event triggered after shifting the calendar one domain above
   *
   * @param  Date    start  Domain start date
   * @param  Date    end    Domain end date
   */afterLoadNextDomain:function o(e){'use strict';var t=this;return this.triggerEvent("afterLoadNextDomain",function(){var o=t.getSubDomain(e);return[o.shift(),o.pop()]})},/**
   * Event triggered after loading the leftmost domain allowed by minDate
   *
   * @param  boolean  reached True if the leftmost domain was reached
   */onMinDomainReached:function t(e){'use strict';return this._minDomainReached=e,this.triggerEvent("onMinDomainReached",[e])},/**
   * Event triggered after loading the rightmost domain allowed by maxDate
   *
   * @param  boolean  reached True if the rightmost domain was reached
   */onMaxDomainReached:function t(e){'use strict';return this._maxDomainReached=e,this.triggerEvent("onMaxDomainReached",[e])},checkIfMinDomainIsReached:function o(e,t){'use strict';this.minDomainIsReached(e)&&this.onMinDomainReached(!0),2===arguments.length&&this._maxDomainReached&&!this.maxDomainIsReached(t)&&this.onMaxDomainReached(!1)},checkIfMaxDomainIsReached:function o(e,t){'use strict';this.maxDomainIsReached(e)&&this.onMaxDomainReached(!0),2===arguments.length&&this._minDomainReached&&!this.minDomainIsReached(t)&&this.onMinDomainReached(!1)},afterUpdate:function e(){'use strict';return this.triggerEvent("afterUpdate")},// =========================================================================//
// FORMATTER                                //
// =========================================================================//
formatNumber:d3.format(",g"),formatDate:function n(e,t){'use strict';if(2>arguments.length&&(t="title"),"function"==typeof t)return t(e);var o=d3.time.format(t);return o(e)},getSubDomainTitle:function o(e){'use strict';if(null===e.v&&!this.options.considerMissingDataAsZero)return this.formatStringWithObject(this.options.subDomainTitleFormat.empty,{date:this.formatDate(new Date(e.t),this.options.subDomainDateFormat)});var t=e.v;// Consider null as 0
return null===t&&this.options.considerMissingDataAsZero&&(t=0),this.formatStringWithObject(this.options.subDomainTitleFormat.filled,{count:this.formatNumber(t),name:this.options.itemName[1===t?0:1],connector:this._domainType[this.options.subDomain].format.connector,date:this.formatDate(new Date(e.t),this.options.subDomainDateFormat)})},// =========================================================================//
// DOMAIN NAVIGATION                            //
// =========================================================================//
/**
   * Shift the calendar one domain forward
   *
   * The new domain is loaded only if it's not beyond maxDate
   *
   * @param int n Number of domains to load
   * @return bool True if the next domain was loaded, else false
   */loadNextDomain:function o(e){'use strict';if(this._maxDomainReached||0===e)return!1;var t=this.loadNewDomains(this.NAVIGATE_RIGHT,this.getDomain(this.getNextDomain(),e));return this.afterLoadNextDomain(t.end),this.checkIfMaxDomainIsReached(this.getNextDomain().getTime(),t.start),!0},/**
   * Shift the calendar one domain backward
   *
   * The previous domain is loaded only if it's not beyond the minDate
   *
   * @param int n Number of domains to load
   * @return bool True if the previous domain was loaded, else false
   */loadPreviousDomain:function o(e){'use strict';if(this._minDomainReached||0===e)return!1;var t=this.loadNewDomains(this.NAVIGATE_LEFT,this.getDomain(this.getDomainKeys()[0],-e).reverse());return this.afterLoadPreviousDomain(t.start),this.checkIfMinDomainIsReached(t.start,t.end),!0},loadNewDomains:function m(e,t){'use strict';function o(e){return{t:n._domainType[n.options.subDomain].extractUnit(e),v:null}}// Remove out of bound domains from list of new domains to prepend
for(var n=this,a=e===this.NAVIGATE_LEFT,r=-1,l=t.length,d=this.getDomainKeys();++r<l;){if(a&&this.minDomainIsReached(t[r])){t=t.slice(0,r+1);break}if(!a&&this.maxDomainIsReached(t[r])){t=t.slice(0,r);break}}for(t=t.slice(-this.options.range),r=0,l=t.length;r<l;r++)this._domains.set(t[r].getTime(),this.getSubDomain(t[r]).map(o)),this._domains.remove(a?d.pop():d.shift());return d=this.getDomainKeys(),a&&(t=t.reverse()),this.paint(e),this.getDatas(this.options.data,t[0],this.getSubDomain(t[t.length-1]).pop(),function(){n.fill(n.lastInsertedSvg)}),{start:t[a?0:1],end:d[d.length-1]}},/**
   * Return whether a date is inside the scope determined by maxDate
   *
   * @param int datetimestamp The timestamp in ms to test
   * @return bool True if the specified date correspond to the calendar upper bound
   */maxDomainIsReached:function t(e){'use strict';return null!==this.options.maxDate&&this.options.maxDate.getTime()<e},/**
   * Return whether a date is inside the scope determined by minDate
   *
   * @param int datetimestamp The timestamp in ms to test
   * @return bool True if the specified date correspond to the calendar lower bound
   */minDomainIsReached:function t(e){'use strict';return null!==this.options.minDate&&this.options.minDate.getTime()>=e},/**
   * Return the list of the calendar's domain timestamp
   *
   * @return Array a sorted array of timestamp
   */getDomainKeys:function e(){'use strict';return this._domains.keys().map(function(e){return parseInt(e,10)}).sort(function(e,t){return e-t})},// =========================================================================//
// POSITIONNING                                //
// =========================================================================//
positionSubDomainX:function o(e){'use strict';var t=this._domainType[this.options.subDomain].position.x(new Date(e));return t*this.options.cellSize+t*this.options.cellPadding},positionSubDomainY:function o(e){'use strict';var t=this._domainType[this.options.subDomain].position.y(new Date(e));return t*this.options.cellSize+t*this.options.cellPadding},getSubDomainColumnNumber:function n(e){'use strict';if(0<this.options.rowLimit){var t=this._domainType[this.options.subDomain].maxItemNumber;return"function"==typeof t&&(t=t(e)),Math.ceil(t/this.options.rowLimit)}var o=this._domainType[this.options.subDomain].defaultColumnNumber;return"function"==typeof o&&(o=o(e)),this.options.colLimit||o},getSubDomainRowNumber:function n(e){'use strict';if(0<this.options.colLimit){var t=this._domainType[this.options.subDomain].maxItemNumber;return"function"==typeof t&&(t=t(e)),Math.ceil(t/this.options.colLimit)}var o=this._domainType[this.options.subDomain].defaultRowNumber;return"function"==typeof o&&(o=o(e)),this.options.rowLimit||o},/**
   * Return a classname if the specified date should be highlighted
   *
   * @param  timestamp date Date of the current subDomain
   * @return String the highlight class
   */getHighlightClassName:function o(e){'use strict';if(e=new Date(e),0<this.options.highlight.length)for(var t in this.options.highlight)if(this.dateIsEqual(this.options.highlight[t],e))return this.isNow(this.options.highlight[t])?" highlight-now":" highlight";return""},/**
   * Return whether the specified date is now,
   * according to the type of subdomain
   *
   * @param  Date d The date to compare
   * @return bool True if the date correspond to a subdomain cell
   */isNow:function t(e){'use strict';return this.dateIsEqual(e,new Date)},/**
   * Return whether 2 dates are equals
   * This function is subdomain-aware,
   * and dates comparison are dependent of the subdomain
   *
   * @param  Date dateA First date to compare
   * @param  Date dateB Secon date to compare
   * @return bool true if the 2 dates are equals
   */ /* jshint maxcomplexity: false */dateIsEqual:function o(e,t){'use strict';switch(e instanceof Date||(e=new Date(e)),t instanceof Date||(t=new Date(t)),this.options.subDomain){case"x_min":case"min":return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()&&e.getHours()===t.getHours()&&e.getMinutes()===t.getMinutes();case"x_hour":case"hour":return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()&&e.getHours()===t.getHours();case"x_day":case"day":return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate();case"x_week":case"week":return e.getFullYear()===t.getFullYear()&&this.getWeekNumber(e)===this.getWeekNumber(t);case"x_month":case"month":return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth();default:return!1;}},/**
   * Returns wether or not dateA is less than or equal to dateB. This function is subdomain aware.
   * Performs automatic conversion of values.
   * @param dateA may be a number or a Date
   * @param dateB may be a number or a Date
   * @returns {boolean}
   */dateIsLessThan:function n(e,t){'use strict';function o(e,t){return"x_min"===t||"min"===t?new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes()).getTime():"x_hour"===t||"hour"===t?new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()).getTime():"x_day"===t||"day"===t?new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime():"x_week"===t||"week"===t||"x_month"===t||"month"===t?new Date(e.getFullYear(),e.getMonth()).getTime():e.getTime()}return e instanceof Date||(e=new Date(e)),t instanceof Date||(t=new Date(t)),o(e,this.options.subDomain)<o(t,this.options.subDomain)},// =========================================================================//
// DATE COMPUTATION                              //
// =========================================================================//
/**
   * Return the day of the year for the date
   * @param  Date
   * @return  int Day of the year [1,366]
   */getDayOfYear:d3.time.format("%j"),/**
   * Return the week number of the year
   * Monday as the first day of the week
   * @return int  Week number [0-53]
   */getWeekNumber:function o(e){'use strict';var t=!0===this.options.weekStartOnMonday?d3.time.format("%W"):d3.time.format("%U");return t(e)},/**
   * Return the week number, relative to its month
   *
   * @param  int|Date d Date or timestamp in milliseconds
   * @return int Week number, relative to the month [0-5]
   */getMonthWeekNumber:function o(e){'use strict';"number"==typeof e&&(e=new Date(e));var t=this.getWeekNumber(new Date(e.getFullYear(),e.getMonth()));return this.getWeekNumber(e)-t-1},/**
   * Return the number of weeks in the dates' year
   *
   * @param  int|Date d Date or timestamp in milliseconds
   * @return int Number of weeks in the date's year
   */getWeekNumberInYear:function t(e){'use strict';"number"==typeof e&&(e=new Date(e))},/**
   * Return the number of days in the date's month
   *
   * @param  int|Date d Date or timestamp in milliseconds
   * @return int Number of days in the date's month
   */getDayCountInMonth:function t(e){'use strict';return this.getEndOfMonth(e).getDate()},/**
   * Return the number of days in the date's year
   *
   * @param  int|Date d Date or timestamp in milliseconds
   * @return int Number of days in the date's year
   */getDayCountInYear:function t(e){'use strict';return"number"==typeof e&&(e=new Date(e)),1===new Date(e.getFullYear(),1,29).getMonth()?366:365},/**
   * Get the weekday from a date
   *
   * Return the week day number (0-6) of a date,
   * depending on whether the week start on monday or sunday
   *
   * @param  Date d
   * @return int The week day number (0-6)
   */getWeekDay:function t(e){'use strict';return!1===this.options.weekStartOnMonday?e.getDay():0===e.getDay()?6:e.getDay()-1},/**
   * Get the last day of the month
   * @param  Date|int  d  Date or timestamp in milliseconds
   * @return Date      Last day of the month
   */getEndOfMonth:function t(e){'use strict';return"number"==typeof e&&(e=new Date(e)),new Date(e.getFullYear(),e.getMonth()+1,0)},/**
   *
   * @param  Date date
   * @param  int count
   * @param  string step
   * @return Date
   */jumpDate:function i(e,t,o){'use strict';var n=new Date(e);return"hour"===o?n.setHours(n.getHours()+t):"day"===o?n.setHours(n.getHours()+24*t):"week"===o?n.setHours(n.getHours()+7*(24*t)):"month"===o?n.setMonth(n.getMonth()+t):"year"===o?n.setFullYear(n.getFullYear()+t):void 0,new Date(n)},// =========================================================================//
// DOMAIN COMPUTATION                            //
// =========================================================================//
/**
   * Return all the minutes between 2 dates
   *
   * @param  Date  d  date  A date
   * @param  int|date  range  Number of minutes in the range, or a stop date
   * @return array  An array of minutes
   */getMinuteDomain:function i(e,t){'use strict';var o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),n=null;return n=t instanceof Date?new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()):new Date(+o+60*(1e3*t)),d3.time.minutes(Math.min(o,n),Math.max(o,n))},/**
   * Return all the hours between 2 dates
   *
   * @param  Date  d  A date
   * @param  int|date  range  Number of hours in the range, or a stop date
   * @return array  An array of hours
   */getHourDomain:function d(e,t){'use strict';var o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),n=null;t instanceof Date?n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()):(n=new Date(o),n.setHours(n.getHours()+t));var a=d3.time.hours(Math.min(o,n),Math.max(o,n)),r=0,l=a.length;// Passing from DST to standard time
// If there are 25 hours, let's compress the duplicate hours
for(r=0;r<l;r++)if(0<r&&a[r].getHours()===a[r-1].getHours()){this.DSTDomain.push(a[r].getTime()),a.splice(r,1);break}// d3.time.hours is returning more hours than needed when changing
// from DST to standard time, because there is really 2 hours between
// 1am and 2am!
return"number"==typeof t&&a.length>Math.abs(t)&&a.splice(a.length-1,1),a},/**
   * Return all the days between 2 dates
   *
   * @param  Date    d    A date
   * @param  int|date  range  Number of days in the range, or a stop date
   * @return array  An array of weeks
   */getDayDomain:function i(e,t){'use strict';var o=new Date(e.getFullYear(),e.getMonth(),e.getDate()),n=null;return t instanceof Date?n=new Date(t.getFullYear(),t.getMonth(),t.getDate()):(n=new Date(o),n=new Date(n.setDate(n.getDate()+parseInt(t,10)))),d3.time.days(Math.min(o,n),Math.max(o,n))},/**
   * Return all the weeks between 2 dates
   *
   * @param  Date  d  A date
   * @param  int|date  range  Number of minutes in the range, or a stop date
   * @return array  An array of weeks
   */getWeekDomain:function a(e,t){'use strict';var o;!1===this.options.weekStartOnMonday?o=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()):1===e.getDay()?o=new Date(e.getFullYear(),e.getMonth(),e.getDate()):0===e.getDay()?(o=new Date(e.getFullYear(),e.getMonth(),e.getDate()),o.setDate(o.getDate()-6)):o=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()+1);var n=new Date(o),i=t;return"object"!=typeof t&&(i=new Date(n.setDate(n.getDate()+7*t))),!0===this.options.weekStartOnMonday?d3.time.mondays(Math.min(o,i),Math.max(o,i)):d3.time.sundays(Math.min(o,i),Math.max(o,i))},/**
   * Return all the months between 2 dates
   *
   * @param  Date    d    A date
   * @param  int|date  range  Number of months in the range, or a stop date
   * @return array  An array of months
   */getMonthDomain:function i(e,t){'use strict';var o=new Date(e.getFullYear(),e.getMonth()),n=null;return t instanceof Date?n=new Date(t.getFullYear(),t.getMonth()):(n=new Date(o),n=n.setMonth(n.getMonth()+t)),d3.time.months(Math.min(o,n),Math.max(o,n))},/**
   * Return all the years between 2 dates
   *
   * @param  Date  d  date  A date
   * @param  int|date  range  Number of minutes in the range, or a stop date
   * @return array  An array of hours
   */getYearDomain:function i(e,t){'use strict';var o=new Date(e.getFullYear(),0),n=null;return n=t instanceof Date?new Date(t.getFullYear(),0):new Date(e.getFullYear()+t,0),d3.time.years(Math.min(o,n),Math.max(o,n))},/**
   * Get an array of domain start dates
   *
   * @param  int|Date date A random date included in the wanted domain
   * @param  int|Date range Number of dates to get, or a stop date
   * @return Array of dates
   */getDomain:function n(e,t){'use strict';switch("number"==typeof e&&(e=new Date(e)),2>arguments.length&&(t=this.options.range),this.options.domain){case"hour":var o=this.getHourDomain(e,t);// Case where an hour is missing, when passing from standard time to DST
// Missing hour is perfectly acceptabl in subDomain, but not in domains
return"number"==typeof t&&o.length<t&&(0<t?o.push(this.getHourDomain(o[o.length-1],2)[1]):o.shift(this.getHourDomain(o[0],-2)[0])),o;case"day":return this.getDayDomain(e,t);case"week":return this.getWeekDomain(e,t);case"month":return this.getMonthDomain(e,t);case"year":return this.getYearDomain(e,t);}},/* jshint maxcomplexity: false */getSubDomain:function r(e){'use strict';"number"==typeof e&&(e=new Date(e));var t=this,o=function(e,o){return"year"===o?t.getDayCountInYear(e):"month"===o?t.getDayCountInMonth(e):"week"===o?7:void 0},n=function(e,t){return"hour"===t?60:"day"===t?60*24:"week"===t?7*(60*24):void 0},i=function(e,o){return"day"===o?24:"week"===o?168:"month"===o?24*t.getDayCountInMonth(e):void 0},a=function(e,o){if("month"===o){var n=new Date(e.getFullYear(),e.getMonth()+1,0),i=t.getWeekNumber(n),a=t.getWeekNumber(new Date(e.getFullYear(),e.getMonth()));return a>i&&(a=0,i++),i-a+1}return"year"===o?t.getWeekNumber(new Date(e.getFullYear(),11,31)):void 0};/**
     * @return int
     */switch(this.options.subDomain){case"x_min":case"min":return this.getMinuteDomain(e,n(e,this.options.domain));case"x_hour":case"hour":return this.getHourDomain(e,i(e,this.options.domain));case"x_day":case"day":return this.getDayDomain(e,o(e,this.options.domain));case"x_week":case"week":return this.getWeekDomain(e,a(e,this.options.domain));case"x_month":case"month":return this.getMonthDomain(e,12);}},/**
   * Get the n-th next domain after the calendar newest (rightmost) domain
   * @param  int n
   * @return Date The start date of the wanted domain
   */getNextDomain:function t(e){'use strict';return 0===arguments.length&&(e=1),this.getDomain(this.jumpDate(this.getDomainKeys().pop(),e,this.options.domain),1)[0]},/**
   * Get the n-th domain before the calendar oldest (leftmost) domain
   * @param  int n
   * @return Date The start date of the wanted domain
   */getPreviousDomain:function t(e){'use strict';return 0===arguments.length&&(e=1),this.getDomain(this.jumpDate(this.getDomainKeys().shift(),-e,this.options.domain),1)[0]},// =========================================================================//
// DATAS                                  //
// =========================================================================//
/**
   * Fetch and interpret data from the datasource
   *
   * @param string|object source
   * @param Date startDate
   * @param Date endDate
   * @param function callback
   * @param function|boolean afterLoad function used to convert the data into a json object. Use true to use the afterLoad callback
   * @param updateMode
   *
   * @return mixed
   * - True if there are no data to load
   * - False if data are loaded asynchronously
   */getDatas:function u(e,t,o,n,i,a){'use strict';var r=this;5>arguments.length&&(i=!0),6>arguments.length&&(a=this.APPEND_ON_UPDATE);var l=function(e,l){!1===i?("csv"===r.options.dataType||"tsv"===r.options.dataType)&&(l=this.interpretCSV(l)):"function"==typeof i?l=i(l):"function"==typeof r.options.afterLoadData?l=r.options.afterLoadData(l):console.log("Provided callback for afterLoadData is not a function."),r.parseDatas(l,a,t,o),"function"==typeof n&&n()};switch(typeof e){case"string":if(""===e)return l(null,{}),!0;var d=this.parseURI(e,t,o),m="GET";null!==r.options.dataPostPayload&&(m="POST");var s=null;null!==r.options.dataPostPayload&&(s=this.parseURI(r.options.dataPostPayload,t,o));var g=null;switch(this.options.dataType){case"json":g=d3.json(d);break;case"csv":g=d3.csv(d);break;case"tsv":g=d3.tsv(d);break;case"txt":g=d3.text(d,"text/plain");}// jshint maxdepth:5
if(null!==r.options.dataRequestHeaders)for(var p in r.options.dataRequestHeaders)r.options.dataRequestHeaders.hasOwnProperty(p)&&g.header(p,r.options.dataRequestHeaders[p]);return g.send(m,s,l),!1;case"object":if(e===Object(e))return l(null,e),!1;/* falls through */default:return l(null,{}),!0;}},/**
   * Populate the calendar internal data
   *
   * @param object data
   * @param constant updateMode
   * @param Date startDate
   * @param Date endDate
   *
   * @return void
   */parseDatas:function g(e,t,o,n){'use strict';t===this.RESET_ALL_ON_UPDATE&&this._domains.forEach(function(e,t){t.forEach(function(e,t,o){o[t].v=null})});var i={},a=function(e){return e.t};/*jshint forin:false */for(var r in e){var l=new Date(1e3*r),d=this.getDomain(l)[0].getTime();// Skip if data is not relevant to current domain
if(0<=this.DSTDomain.indexOf(d)&&this._domains.has(d-1e3*3600)&&(d-=1e3*3600),!isNaN(r)&&e.hasOwnProperty(r)&&this._domains.has(d)&&d>=+o&&d<+n){var m=this._domains.get(d);i.hasOwnProperty(d)||(i[d]=m.map(a));var s=i[d].indexOf(this._domainType[this.options.subDomain].extractUnit(l));t===this.RESET_SINGLE_ON_UPDATE?m[s].v=e[r]:isNaN(m[s].v)?m[s].v=e[r]:m[s].v+=e[r]}}},parseURI:function n(e,t,o){'use strict';// Use a timestamp in seconds
return e=e.replace(/\{\{t:start\}\}/g,t.getTime()/1e3),e=e.replace(/\{\{t:end\}\}/g,o.getTime()/1e3),e=e.replace(/\{\{d:start\}\}/g,t.toISOString()),e=e.replace(/\{\{d:end\}\}/g,o.toISOString()),e},interpretCSV:function r(e){'use strict';var t,o,n={},a=Object.keys(e[0]);for(t=0,o=e.length;t<o;t++)n[e[t][a[0]]]=+e[t][a[1]];return n},/**
   * Handle the calendar layout and dimension
   *
   * Expand and shrink the container depending on its children dimension
   * Also rearrange the children position depending on their dimension,
   * and the legend position
   *
   * @return void
   */resize:function r(){'use strict';var e=this,t=e.options,o=t.displayLegend?e.Legend.getDim("width")+t.legendMargin[1]+t.legendMargin[3]:0,n=t.displayLegend?e.Legend.getDim("height")+t.legendMargin[0]+t.legendMargin[2]:0,i=e.graphDim.width-t.domainGutter-t.cellPadding,a=e.graphDim.height-t.domainGutter-t.cellPadding;this.root.transition().duration(t.animationDuration).attr("width",function(){return"middle"===t.legendVerticalPosition||"center"===t.legendVerticalPosition?i+o:Math.max(i,o)}).attr("height",function(){return"middle"===t.legendVerticalPosition||"center"===t.legendVerticalPosition?Math.max(a,n):a+n}),this.root.select(".graph").transition().duration(t.animationDuration).attr("y",function(){return"top"===t.legendVerticalPosition?n:0}).attr("x",function(){return("middle"===t.legendVerticalPosition||"center"===t.legendVerticalPosition)&&"left"===t.legendHorizontalPosition?o:0})},// =========================================================================//
// PUBLIC API                                //
// =========================================================================//
/**
   * Shift the calendar forward
   */next:function t(e){'use strict';return 0===arguments.length&&(e=1),this.loadNextDomain(e)},/**
   * Shift the calendar backward
   */previous:function t(e){'use strict';return 0===arguments.length&&(e=1),this.loadPreviousDomain(e)},/**
   * Jump directly to a specific date
   *
   * JumpTo will scroll the calendar until the wanted domain with the specified
   * date is visible. Unless you set reset to true, the wanted domain
   * will not necessarily be the first (leftmost) domain of the calendar.
   *
   * @param Date date Jump to the domain containing that date
   * @param bool reset Whether the wanted domain should be the first domain of the calendar
   * @param bool True of the calendar was scrolled
   */jumpTo:function a(e,t){'use strict';2>arguments.length&&(t=!1);var o=this.getDomainKeys(),n=o[0],i=o[o.length-1];if(e<n)return this.loadPreviousDomain(this.getDomain(n,e).length);return t?this.loadNextDomain(this.getDomain(n,e).length):!!(e>i)&&this.loadNextDomain(this.getDomain(i,e).length)},/**
   * Navigate back to the start date
   *
   * @since  3.3.8
   * @return void
   */rewind:function e(){'use strict';this.jumpTo(this.options.start,!0)},/**
   * Update the calendar with new data
   *
   * @param  object|string    dataSource    The calendar's datasource, same type as this.options.data
   * @param  boolean|function    afterLoad    Whether to execute afterLoad() on the data. Pass directly a function
   * if you don't want to use the afterLoad() callback
   */update:function a(e,t,o){'use strict';0===arguments.length&&(e=this.options.data),2>arguments.length&&(t=!0),3>arguments.length&&(o=this.RESET_ALL_ON_UPDATE);var n=this.getDomainKeys(),i=this;this.getDatas(e,new Date(n[0]),this.getSubDomain(n[n.length-1]).pop(),function(){i.fill(),i.afterUpdate()},t,o)},/**
   * Set the legend
   *
   * @param array legend an array of integer, representing the different threshold value
   * @param array colorRange an array of 2 hex colors, for the minimum and maximum colors
   */setLegend:function t(){'use strict';var e=this.options.legend.slice(0);1<=arguments.length&&Array.isArray(arguments[0])&&(this.options.legend=arguments[0]),2<=arguments.length&&(Array.isArray(arguments[1])&&2<=arguments[1].length?this.options.legendColors=[arguments[1][0],arguments[1][1]]:this.options.legendColors=arguments[1]),(0<arguments.length&&!arrayEquals(e,this.options.legend)||2<=arguments.length)&&(this.Legend.buildColors(),this.fill()),this.Legend.redraw(this.graphDim.width-this.options.domainGutter-this.options.cellPadding)},/**
   * Remove the legend
   *
   * @return bool False if there is no legend to remove
   */removeLegend:function e(){'use strict';return!!this.options.displayLegend&&(this.options.displayLegend=!1,this.Legend.remove(),!0)},/**
   * Display the legend
   *
   * @return bool False if the legend was already displayed
   */showLegend:function e(){'use strict';return!this.options.displayLegend&&(this.options.displayLegend=!0,this.Legend.redraw(this.graphDim.width-this.options.domainGutter-this.options.cellPadding),!0)},/**
   * Highlight dates
   *
   * Add a highlight class to a set of dates
   *
   * @since  3.3.5
   * @param  array Array of dates to highlight
   * @return bool True if dates were highlighted
   */highlight:function t(e){'use strict';return!!(0<(this.options.highlight=this.expandDateSetting(e)).length)&&(this.fill(),!0)},/**
   * Destroy the calendar
   *
   * Usage: cal = cal.destroy();
   *
   * @since  3.3.6
   * @param function A callback function to trigger after destroying the calendar
   * @return null
   */destroy:function t(e){'use strict';return this.root.transition().duration(this.options.animationDuration).attr("width",0).attr("height",0).remove().each("end",function(){"function"==typeof e?e():"undefined"!=typeof e&&console.log("Provided callback for destroy() is not a function.")}),null},getSVG:function l(){'use strict';for(var e={".cal-heatmap-container":{},".graph":{},".graph-rect":{},"rect.highlight":{},"rect.now":{},"rect.highlight-now":{},"text.highlight":{},"text.now":{},"text.highlight-now":{},".domain-background":{},".graph-label":{},".subdomain-text":{},".q0":{},".qi":{}},t=1,o=this.options.legend.length+1;t<=o;t++)e[".q"+t]={};var n=this.root,a=[// SVG specific properties
"stroke","stroke-width","stroke-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-miterlimit","fill","fill-opacity","fill-rule","marker","marker-start","marker-mid","marker-end","alignement-baseline","baseline-shift","dominant-baseline","glyph-orientation-horizontal","glyph-orientation-vertical","kerning","text-anchor","shape-rendering",// Text Specific properties
"text-transform","font-family","font","font-size","font-weight"],r=function(t,o,n){-1!==a.indexOf(o)&&(e[t][o]=n)},d=function(t){return n.select(t)[0][0]};/* jshint forin:false */for(var m in e)if(e.hasOwnProperty(m)){var s=d(m);if(null!==s)// The DOM Level 2 CSS way
/* jshint maxdepth: false */if("getComputedStyle"in window){var g=getComputedStyle(s,null);if(0!==g.length)for(var u=0;u<g.length;u++)r(m,g.item(u),g.getPropertyValue(g.item(u)));// Opera workaround. Opera doesn"t support `item`/`length`
// on CSSStyleDeclaration.
else for(var h in g)g.hasOwnProperty(h)&&r(m,h,g[h]);// The IE way
}else if("currentStyle"in s){var c=s.currentStyle;for(var D in c)r(m,D,c[D])}}var p="<svg xmlns=\"http://www.w3.org/2000/svg\" "+"xmlns:xlink=\"http://www.w3.org/1999/xlink\"><style type=\"text/css\"><![CDATA[ ";for(var f in e){for(var y in p+=f+" {\n",e[f])p+="\t"+y+":"+e[f][y]+";\n";p+="}\n"}return p+="]]></style>",p+=new XMLSerializer().serializeToString(this.root[0][0]),p+="</svg>",p}};// =========================================================================//
// DOMAIN POSITION COMPUTATION                        //
// =========================================================================//
/**
 * Compute the position of a domain, relative to the calendar
 */var DomainPosition=function(){'use strict';this.positions=d3.map()};DomainPosition.prototype.getPosition=function(e){'use strict';return this.positions.get(e)},DomainPosition.prototype.getPositionFromIndex=function(e){'use strict';var t=this.getKeys();return this.positions.get(t[e])},DomainPosition.prototype.getLast=function(){'use strict';var e=this.getKeys();return this.positions.get(e[e.length-1])},DomainPosition.prototype.setPosition=function(e,t){'use strict';this.positions.set(e,t)},DomainPosition.prototype.shiftRightBy=function(e){'use strict';this.positions.forEach(function(t,o){this.set(t,o-e)});var t=this.getKeys();this.positions.remove(t[0])},DomainPosition.prototype.shiftLeftBy=function(e){'use strict';this.positions.forEach(function(t,o){this.set(t,o+e)});var t=this.getKeys();this.positions.remove(t[t.length-1])},DomainPosition.prototype.getKeys=function(){'use strict';return this.positions.keys().sort(function(e,t){return parseInt(e,10)-parseInt(t,10)})};// =========================================================================//
// LEGEND                                  //
// =========================================================================//
var Legend=function(e){'use strict';this.calendar=e,this.computeDim(),null!==e.options.legendColors&&this.buildColors()};Legend.prototype.computeDim=function(){'use strict';var e=this.calendar.options;// Shorter accessor for variable name mangling when minifying
this.dim={width:e.legendCellSize*(e.legend.length+1)+e.legendCellPadding*e.legend.length,height:e.legendCellSize}},Legend.prototype.remove=function(){'use strict';this.calendar.root.select(".graph-legend").remove(),this.calendar.resize()},Legend.prototype.redraw=function(e){'use strict';function t(e){e.attr("width",m.legendCellSize).attr("height",m.legendCellSize).attr("rx",m.legendCellRadius).attr("ry",m.legendCellRadius).attr("x",function(e,t){return t*(m.legendCellSize+m.legendCellPadding)})}function o(){switch(m.legendHorizontalPosition){case"right":return"center"===m.legendVerticalPosition||"middle"===m.legendVerticalPosition?e+m.legendMargin[3]:e-a.getDim("width")-m.legendMargin[1];case"middle":case"center":return Math.round(e/2-a.getDim("width")/2);default:return m.legendMargin[3];}}function n(){return"bottom"===m.legendVerticalPosition?r.graphDim.height+m.legendMargin[0]-m.domainGutter-m.cellPadding:m.legendMargin[0]}if(!this.calendar.options.displayLegend)return!1;var i,a=this,r=this.calendar,l=r.root,m=r.options;this.computeDim();var s=m.legend.slice(0);s.push(s[s.length-1]+1);var g=r.root.select(".graph-legend");null===g[0][0]?(l="top"===m.legendVerticalPosition?l.insert("svg",".graph"):l.append("svg"),l.attr("x",o()).attr("y",n()),i=l.attr("class","graph-legend").attr("height",a.getDim("height")).attr("width",a.getDim("width")).append("g").selectAll().data(s)):(l=g,i=l.select("g").selectAll("rect").data(s)),i.enter().append("rect").call(t).attr("class",function(e){return r.Legend.getClass(e,null===r.legendScale)}).attr("fill-opacity",0).call(function(e){null!==r.legendScale&&null!==m.legendColors&&m.legendColors.hasOwnProperty("base")&&e.attr("fill",m.legendColors.base)}).append("title"),i.exit().transition().duration(m.animationDuration).attr("fill-opacity",0).remove(),i.transition().delay(function(e,t){return m.animationDuration*t/10}).call(t).attr("fill-opacity",1).call(function(e){e.attr("fill",function(e,t){return null===r.legendScale?"":0===t?r.legendScale(e-1):r.legendScale(m.legend[t-1])}),e.attr("class",function(e){return r.Legend.getClass(e,null===r.legendScale)})}),i.select("title").text(function(e,t){return 0===t?r.formatStringWithObject(m.legendTitleFormat.lower,{min:m.legend[t],name:m.itemName[1]}):t===s.length-1?r.formatStringWithObject(m.legendTitleFormat.upper,{max:m.legend[t-1],name:m.itemName[1]}):r.formatStringWithObject(m.legendTitleFormat.inner,{down:m.legend[t-1],up:m.legend[t],name:m.itemName[1]})}),i.on("mouseover",function(e){r.legendTip.show(e,this)}).on("mouseout",function(){r.legendTip.hide()}),l.transition().duration(m.animationDuration).attr("x",o()).attr("y",n()).attr("width",a.getDim("width")).attr("height",a.getDim("height")),l.select("g").transition().duration(m.animationDuration).attr("transform",function(){return"vertical"===m.legendOrientation?"rotate(90 "+m.legendCellSize/2+" "+m.legendCellSize/2+")":""}),r.resize()},Legend.prototype.getDim=function(e){'use strict';var t="horizontal"===this.calendar.options.legendOrientation;return"width"===e?this.dim[t?"width":"height"]:"height"===e?this.dim[t?"height":"width"]:void 0},Legend.prototype.buildColors=function(){'use strict';var e=this.calendar.options;// Shorter accessor for variable name mangling when minifying
if(null===e.legendColors)return this.calendar.legendScale=null,!1;var t=[];if(Array.isArray(e.legendColors))t=e.legendColors;else if(e.legendColors.hasOwnProperty("min")&&e.legendColors.hasOwnProperty("max"))t=[e.legendColors.min,e.legendColors.max];else return e.legendColors=null,!1;var o=e.legend.slice(0);0<o[0]?o.unshift(0):0>=o[0]&&o.unshift(o[0]-(o[o.length-1]-o[0])/o.length);var n=e.legendColors.hasOwnProperty("colorScale")?e.legendColors.colorScale:d3.scale.linear().range(t).interpolate(d3.interpolateHcl).domain([d3.min(o),d3.max(o)]);var i=o.map(function(e){return n(e)});return this.calendar.legendScale=d3.scale.threshold().domain(e.legend).range(i),!0},Legend.prototype.getClass=function(e,t){'use strict';if(null===e||isNaN(e))return"";for(var o=[this.calendar.options.legend.length+1],n=0,a=this.calendar.options.legend.length-1;n<=a;n++){if(0<this.calendar.options.legend[0]&&0>e){o=["1","i"];break}if(e<=this.calendar.options.legend[n]){o=[n+1];break}}return 0===e&&o.push(0),o.unshift(""),(o.join(" r")+(t?o.join(" q"):"")).trim()};/**
 * #source http://stackoverflow.com/a/383245/805649
 */function mergeRecursive(t,o){'use strict';/*jshint forin:false */for(var n in o)try{t[n]=o[n].constructor===Object?mergeRecursive(t[n],o[n]):o[n]}catch(i){// Property in destination object not set; create it and set its value.
t[n]=o[n]}return t}/**
 * Check if 2 arrays are equals
 *
 * @link http://stackoverflow.com/a/14853974/805649
 * @param  array array the array to compare to
 * @return bool true of the 2 arrays are equals
 */function arrayEquals(e,t){'use strict';// if the other array is a falsy value, return
if(!t||!e)return!1;// compare lengths - can save a lot of time
if(e.length!==t.length)return!1;for(var o=0;o<e.length;o++)// Check if we have nested arrays
if(e[o]instanceof Array&&t[o]instanceof Array){// recurse into the nested arrays
if(!arrayEquals(e[o],t[o]))return!1;}else if(e[o]!==t[o])// Warning - two different object instances will never be equal: {x:20} != {x:20}
return!1;return!0}export default CalHeatMap;