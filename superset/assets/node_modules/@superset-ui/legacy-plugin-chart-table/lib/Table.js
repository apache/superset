"use strict";exports.__esModule=!0,exports.default=void 0;var _d=_interopRequireDefault(require("d3")),_propTypes=_interopRequireDefault(require("prop-types")),_dataTables=_interopRequireDefault(require("datatables.net-bs/js/dataTables.bootstrap")),_dompurify=_interopRequireDefault(require("dompurify")),_numberFormat=require("@superset-ui/number-format"),_timeFormat=require("@superset-ui/time-format"),_fixTableHeight=_interopRequireDefault(require("./utils/fixTableHeight"));require("datatables.net-bs/css/dataTables.bootstrap.css"),require("./Table.css");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}window.$&&(0,_dataTables.default)(window,window.$);var $=window.$||_dataTables.default.$,propTypes={// Each object is { field1: value1, field2: value2 }
data:_propTypes.default.arrayOf(_propTypes.default.object),height:_propTypes.default.number,alignPositiveNegative:_propTypes.default.bool,colorPositiveNegative:_propTypes.default.bool,columns:_propTypes.default.arrayOf(_propTypes.default.shape({key:_propTypes.default.string,label:_propTypes.default.string,format:_propTypes.default.string})),filters:_propTypes.default.object,includeSearch:_propTypes.default.bool,metrics:_propTypes.default.arrayOf(_propTypes.default.oneOfType([_propTypes.default.string,_propTypes.default.object])),onAddFilter:_propTypes.default.func,onRemoveFilter:_propTypes.default.func,orderDesc:_propTypes.default.bool,pageLength:_propTypes.default.oneOfType([_propTypes.default.number,_propTypes.default.string]),percentMetrics:_propTypes.default.arrayOf(_propTypes.default.oneOfType([_propTypes.default.string,_propTypes.default.object])),tableFilter:_propTypes.default.bool,tableTimestampFormat:_propTypes.default.string,timeseriesLimitMetric:_propTypes.default.oneOfType([_propTypes.default.string,_propTypes.default.object])},formatValue=(0,_numberFormat.getNumberFormatter)(_numberFormat.NumberFormats.INTEGER),formatPercent=(0,_numberFormat.getNumberFormatter)(_numberFormat.NumberFormats.PERCENT_3_POINT);function NOOP(){}function TableVis(a,b){function c(a){for(var b=[],c=0;c<d.length;c+=1)b.push(d[c][a]);return b}var d=b.data,e=b.height,f=b.alignPositiveNegative,g=void 0!==f&&f,h=b.colorPositiveNegative,j=b.columns,k=b.filters,l=void 0===k?{}:k,m=b.includeSearch,n=b.metrics,o=b.onAddFilter,p=void 0===o?NOOP:o,q=b.onRemoveFilter,r=void 0===q?NOOP:q,s=b.orderDesc,t=b.pageLength,u=b.percentMetrics,v=b.tableFilter,w=b.tableTimestampFormat,x=b.timeseriesLimitMetric,y=$(a);y.addClass("superset-legacy-chart-table");for(var z=(n||[]).map(function(a){return a.label||a})// Add percent metrics
.concat((u||[]).map(function(a){return"%"+a}))// Removing metrics (aggregates) that are strings
.filter(function(a){return"number"==typeof d[0][a]}),A={},B={},C=0;C<z.length;C+=1)g?A[z[C]]=_d.default.max(c(z[C]).map(Math.abs)):(A[z[C]]=_d.default.max(c(z[C])),B[z[C]]=_d.default.min(c(z[C])));var D=(0,_timeFormat.getTimeFormatter)(w),E=_d.default.select(a);E.html("");var F=E.append("table").classed("dataframe dataframe table table-striped "+"table-condensed table-hover dataTable no-footer",!0).attr("width","100%");F.append("thead").append("tr").selectAll("th").data(j.map(function(a){return a.label})).enter().append("th").text(function(a){return a}),F.append("tbody").selectAll("tr").data(d).enter().append("tr").selectAll("td").data(function(a){return j.map(function(b){var c,d=b.key,e=b.format,f=a[d],g=0<=z.indexOf(d);return"__timestamp"===d&&(c=D(f)),"string"==typeof f&&(c="<span class=\"like-pre\">"+_dompurify.default.sanitize(f)+"</span>"),g&&(c=(0,_numberFormat.getNumberFormatter)(e)(f)),"%"===d[0]&&(c=formatPercent(f)),{col:d,val:f,html:c,isMetric:g}})}).enter().append("td").style("background-image",function(a){if(a.isMetric){var i=void 0!==h&&h&&0>a.val?150:0;if(g){var j=Math.abs(Math.round(100*(a.val/A[a.col])));// The 0.01 to 0.001 is a workaround for what appears to be a
// CSS rendering bug on flat, transparent colors
return"linear-gradient(to right, rgba("+i+",0,0,0.2), rgba("+i+",0,0,0.2) "+j+"%, "+("rgba(0,0,0,0.01) "+j+"%, rgba(0,0,0,0.001) 100%)")}var b=Math.abs(Math.max(A[a.col],0)),c=Math.abs(Math.min(B[a.col],0)),d=b+c,e=Math.round(100*(Math.min(c+a.val,c)/d)),f=Math.round(100*(Math.abs(a.val)/d));// The 0.01 to 0.001 is a workaround for what appears to be a
return"linear-gradient(to right, rgba(0,0,0,0.01), rgba(0,0,0,0.001) "+e+"%, "+("rgba("+i+",0,0,0.2) "+e+"%, rgba("+i+",0,0,0.2) "+(e+f)+"%, ")+("rgba(0,0,0,0.01) "+(e+f)+"%, rgba(0,0,0,0.001) 100%)")}return null}).classed("text-right",function(a){return a.isMetric}).attr("title",function(a){return"string"==typeof a.val?a.val:Number.isNaN(a.val)?null:formatValue(a.val)}).attr("data-sort",function(a){return a.isMetric?a.val:null})// Check if the dashboard currently has a filter for each row
.classed("filtered",function(a){return l&&l[a.col]&&0<=l[a.col].indexOf(a.val)}).on("click",function(a){if(!a.isMetric&&v){var b=_d.default.select(this);b.classed("filtered")?(r(a.col,[a.val]),_d.default.select(this).classed("filtered",!1)):(_d.default.select(this).classed("filtered",!0),p(a.col,[a.val]))}}).style("cursor",function(a){return a.isMetric?"":"pointer"}).html(function(a){return a.html?a.html:a.val});var G=y.find(".dataTable").DataTable({paging:t&&0<t,pageLength:t,aaSorting:[],searching:void 0!==m&&m,bInfo:!1,scrollY:e+"px",scrollCollapse:!0,scrollX:!0});(0,_fixTableHeight.default)(y.find(".dataTables_wrapper"),e);// Sorting table by main column
var H,I=Array.isArray(x)?x[0]:x;if(I?H=I.label||I:0<z.length&&(H=z[0]),H){var J=j.map(function(a){return a.key}),K=J.indexOf(H);G.column(K).order(s?"desc":"asc"),0>z.indexOf(H)&&G.column(K).visible(!1)}G.draw()}TableVis.displayName="TableVis",TableVis.propTypes=propTypes;var _default=TableVis;exports.default=_default;