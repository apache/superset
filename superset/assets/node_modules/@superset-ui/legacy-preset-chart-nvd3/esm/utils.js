/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */ /* eslint-disable babel/no-invalid-this, no-magic-numbers */import d3 from"d3";import d3tip from"d3-tip";import dompurify from"dompurify";import{getNumberFormatter}from"@superset-ui/number-format";import{smartDateFormatter}from"@superset-ui/time-format";// Regexp for the label added to time shifted series
// (1 hour offset, 2 days offset, etc.)
var TIME_SHIFT_PATTERN=/\d+ \w+ offset/,ANIMATION_TIME=1e3;export function cleanColorInput(a){// for superset series that should have the same color
return(a+"").trim().replace(" (right axis)","").split(", ").filter(function(a){return!TIME_SHIFT_PATTERN.test(a)}).join(", ")}/**
 * If format is smart_date, format date
 * Otherwise, format number with the given format name
 * @param {*} format
 */export function getTimeOrNumberFormatter(a){return"smart_date"===a?smartDateFormatter:getNumberFormatter(a)}export function drawBarValues(a,b,c,d){var e=getNumberFormatter(d),f=b.length,g=c&&0!==b.length?b[0].values.map(function(a,c){var d=b.map(function(a){return a.values[c]});return d3.sum(d,function(a){return a.y})}):[];a.selectAll(".bar-chart-label-group").remove(),setTimeout(function(){var b=a.select("g.nv-barsWrap").append("g").attr("class","bar-chart-label-group");a.selectAll("g.nv-group").filter(function(a,b){return!c||b===f-1}).selectAll("rect").each(function(a,d){var f=d3.select(this),h=f.attr("transform"),i=parseFloat(f.attr("x")),j=parseFloat(f.attr("y")),k=parseFloat(f.attr("width")),l=parseFloat(f.attr("height")),m=b.append("text").text(e(c?g[d]:a.y)).attr("transform",h).attr("class","bar-chart-label"),n=m.node().getBBox(),o=n.width,p=n.height;m.attr("x",i+k/2-o/2),f.attr("class").includes("positive")?m.attr("y",j-5):m.attr("y",j+l+p)})},ANIMATION_TIME)}// Formats the series key to account for a possible NULL value
function getFormattedKey(a,b){return"<NULL>"===a?"&lt;"+a.slice(1,-1)+"&gt;":b?dompurify.sanitize(a):a}// Custom sorted tooltip
// use a verbose formatter for times
export function generateRichLineTooltipContent(a,b,c){var d="";return d+="<table><thead><tr><td colspan='3'>"+("<strong class='x-value'>"+b(a.value)+"</strong>")+"</td></tr></thead><tbody>",a.series.sort(function(c,a){return c.value>=a.value?-1:1}),a.series.forEach(function(a){var b=getFormattedKey(a.key,!0);d+="<tr class=\""+(a.highlight?"emph":"")+"\">"+("<td class='legend-color-guide' style=\"opacity: "+(a.highlight?"1":"0.75")+";\"\">")+"<div "+("style=\"border: 2px solid "+(a.highlight?"black":"transparent")+"; background-color: "+a.color+";\"")+"></div>"+"</td>"+("<td>"+b+"</td>")+("<td>"+c(a.value)+"</td>")+"</tr>"}),d+="</tbody></table>",d}export function generateMultiLineTooltipContent(a,b,c){var d=b(a.value),e="";return e+="<table><thead><tr><td colspan='3'>"+("<strong class='x-value'>"+d+"</strong>")+"</td></tr></thead><tbody>",a.series.forEach(function(a,b){var d=c[b],f=getFormattedKey(a.key,!1);e+="<tr><td class='legend-color-guide'>"+("<div style=\"background-color: "+a.color+";\"></div></td>")+("<td class='key'>"+f+"</td>")+("<td class='value'>"+d(a.value)+"</td></tr>")}),e+="</tbody></table>",e}function getLabel(a){return a.label||a}function createHTMLRow(a,b){return"<tr><td>"+a+"</td><td>"+b+"</td></tr>"}export function generateBubbleTooltipContent(a){var b=a.point,c=a.entity,d=a.xField,e=a.yField,f=a.sizeField,g=a.xFormatter,h=a.yFormatter,i=a.sizeFormatter,j="<table>";return j+="<tr><td style=\"color: "+b.color+";\">"+("<strong>"+b[c]+"</strong> ("+b.group+")")+"</td></tr>",j+=createHTMLRow(getLabel(d),g(b.x)),j+=createHTMLRow(getLabel(e),h(b.y)),j+=createHTMLRow(getLabel(f),i(b.size)),j+="</table>",j}// shouldRemove indicates whether the nvtooltips should be removed from the DOM
export function hideTooltips(a){var b=document.querySelectorAll(".nvtooltip");0<b.length&&b.forEach(function(b){a?b.remove():b.style.opacity=0})}export function wrapTooltip(a,b){var c=a.useInteractiveGuideline&&a.useInteractiveGuideline()?a.interactiveLayer:a,e=c.tooltip.contentGenerator();c.tooltip.contentGenerator(function(a){var c="<div style=\"max-width: "+.5*b+"px\">";return c+=e(a),c+="</div>",c})}export function tipFactory(a){return d3tip().attr("class","d3-tip").direction("n").offset([-5,0]).html(function(b){if(!b)return"";var c=b[a.titleColumn]&&b[a.titleColumn].length?b[a.titleColumn]+" - "+a.name:a.name,d=Array.isArray(a.descriptionColumns)?a.descriptionColumns.map(function(a){return b[a]}):/* eslint-disable-next-line compat/compat */Object.values(b);return"<div><strong>"+c+"</strong></div><br/><div>"+d.join(", ")+"</div>"})}export function getMaxLabelSize(a,b){// axis class = .nv-y2  // second y axis on dual line chart
// axis class = .nv-x  // x axis on time series line chart
var c=a.selectAll("."+b+" g.tick text");if(0<c.length){var d=c[0].map(function(a){return a.getComputedTextLength()});return Math.ceil(Math.max.apply(Math,[0].concat(d)))}return 0}export function formatLabel(a,b){void 0===b&&(b={});// The input for label may be a string or an array of string
// When using the time shift feature, the label contains a '---' in the array
var c=function(a){return b[a]||a};return Array.isArray(a)&&a.length?a.map(function(a){return TIME_SHIFT_PATTERN.test(a)?a:c(a)}).join(", "):c(a)}var MIN_BAR_WIDTH=18;export function computeBarChartWidth(a,b,c){var d=b?d3.max(a,function(a){return a.values.length}):d3.sum(a,function(a){return a.values.length});return Math.max(d*MIN_BAR_WIDTH,c)}export function tryNumify(a){// Attempts casting to Number, returns string when failing
var b=+a;return Number.isNaN(b)?a:b}export function stringifyTimeRange(a){return a.some(function(a){return void 0===a.toISOString})?null:a.map(function(a){return a.toISOString().slice(0,-1)}).join(" : ")}export function setAxisShowMaxMin(a,b){a&&a.showMaxMin&&b!==void 0&&a.showMaxMin(b)}export function computeYDomain(a){if(Array.isArray(a)&&0<a.length&&Array.isArray(a[0].values)){var b=a.map(function(a){return d3.extent(a.values,function(a){return a.y})}),c=d3.min(b,function(a){var b=a[0];return b}),d=d3.max(b,function(a){var b=a[1];return b});return[c,d]}return[0,1]}