"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[357],{10357:(e,t,i)=>{i.r(t),i.d(t,{default:()=>$,getLayer:()=>j});var a=i(78580),o=i.n(a),s=i(67294),r=i(55867),l=i(45697),n=i.n(l),d=i(78918),h=i(80744),c=i(38550),g=i(71435),p=i(62112),u=i(99890),m=i(98452);const f=[0,0,0,255],y={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:e=>e.polygon},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:f},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class _ extends d.Z{initializeState(){this.state={paths:[]},this.props.getLineDashArray&&h.Z.removed("getLineDashArray","PathStyleExtension")()}updateState({oldProps:e,props:t,changeFlags:i}){const a=i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon);if(a&&Array.isArray(i.dataChanged)){const e=this.state.paths.slice(),t=i.dataChanged.map((t=>(0,m.b)({data:e,getIndex:e=>e.__source.index,dataRange:t,replace:this._getPaths(t)})));this.setState({paths:e,pathsDiff:t})}else a&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:t,getPolygon:i,positionFormat:a,_normalize:o}=this.props,s=[],r="XY"===a?2:3,{startRow:l,endRow:n}=e,{iterable:d,objectInfo:h}=(0,c.jB)(t,l,n);for(const e of d){h.index++;let t=i(e,h);o&&(t=u.F(t,r));const{holeIndices:a}=t,l=t.positions||t;if(a)for(let t=0;t<=a.length;t++){const i=l.slice(a[t-1]||0,a[t]||l.length);s.push(this.getSubLayerRow({path:i},e,h.index))}else s.push(this.getSubLayerRow({path:l},e,h.index))}return s}renderLayers(){const{data:e,_dataDiff:t,stroked:i,filled:a,extruded:o,wireframe:s,_normalize:r,_windingOrder:l,elevationScale:n,transitions:d,positionFormat:h}=this.props,{lineWidthUnits:c,lineWidthScale:u,lineWidthMinPixels:m,lineWidthMaxPixels:y,lineJointRounded:_,lineMiterLimit:b,lineDashJustified:v}=this.props,{getFillColor:C,getLineColor:L,getLineWidth:S,getLineDashArray:w,getElevation:x,getPolygon:P,updateTriggers:F,material:k}=this.props,{paths:A,pathsDiff:D}=this.state,R=this.getSubLayerClass("fill",g.Z),Z=this.getSubLayerClass("stroke",p.Z),W=this.shouldRenderSubLayer("fill",A)&&new R({_dataDiff:t,extruded:o,elevationScale:n,filled:a,wireframe:s,_normalize:r,_windingOrder:l,getElevation:x,getFillColor:C,getLineColor:o&&s?L:f,material:k,transitions:d},this.getSubLayerProps({id:"fill",updateTriggers:{getPolygon:F.getPolygon,getElevation:F.getElevation,getFillColor:F.getFillColor,lineColors:o&&s,getLineColor:F.getLineColor}}),{data:e,positionFormat:h,getPolygon:P});return[!o&&W,!o&&i&&this.shouldRenderSubLayer("stroke",A)&&new Z({_dataDiff:D&&(()=>D),widthUnits:c,widthScale:u,widthMinPixels:m,widthMaxPixels:y,jointRounded:_,miterLimit:b,dashJustified:v,_pathType:"loop",transitions:d&&{getWidth:d.getLineWidth,getColor:d.getLineColor,getPath:d.getPolygon},getColor:this.getSubLayerAccessor(L),getWidth:this.getSubLayerAccessor(S),getDashArray:this.getSubLayerAccessor(w)},this.getSubLayerProps({id:"stroke",updateTriggers:{getWidth:F.getLineWidth,getColor:F.getLineColor,getDashArray:F.getLineDashArray}}),{data:A,positionFormat:h,getPath:e=>e.path}),o&&W]}}_.layerName="PolygonLayer",_.defaultProps=y;var b=i(85531),v=i(36665),C=i(1740),L=i(4065),S=i(39828),w=i(2995),x=i(45511),P=i(64106);function F(e,t,i){let{break_points:a,num_buckets:o}=e;if(!t)return[];if(void 0===a||0===a.length){const e=o?parseInt(o,10):10,[a,s]=(0,L.extent)(t,i);if(void 0===a)return[];const r=(s-a)/e,l=0===r?0:Math.max(0,Math.ceil(Math.log10(1/r))),n=s>s.toFixed(l)?1:0,d=a<a.toFixed(l)?a-1:a;return new Array(e+1+n).fill().map(((e,t)=>(d+t*r).toFixed(l)))}return a.sort(((e,t)=>parseFloat(e)-parseFloat(t)))}function k(e,t,i){let{break_points:a,num_buckets:o,linear_color_scheme:s,opacity:r}=e;const l=a||o?F({break_points:a,num_buckets:o},t,i):null,n=Array.isArray(s)?new w.Z({colors:s,id:"custom"}):(0,x.Z)().get(s);let d,h;if(null!==l){const e=l.length-1,t=e>1?n.getColors(e):[n.colors[n.colors.length-1]],i=t[0],a=t[t.length-1];t.unshift(i),t.push(a);const o=l.map((e=>parseFloat(e)));d=(0,S.Z)().domain(o).range(t),h=t=>t>l[e]||t<l[0]}else d=n.createLinearScale((0,L.extent)(t,i)),h=()=>!1;return e=>{const t=i(e),a=(0,P.hexToRGB)(d(t));return h(t)?a[3]=0:a[3]=r/100*255,a}}var A=i(52154),D=i(66911),R=i(21207);function Z(e){return"geometry"in e.polygon?e.polygon.geometry.coordinates[0]:e.polygon}var W=i(40461),T=i(11965);function j(e,t,i,a,s,l,n){var d;const h=e,c=h.fill_color_picker,g=h.stroke_color_picker;let p=[...t.data.features];if(null!=n&&n.forEach((e=>{p=p.filter((t=>e(t)))})),h.js_data_mutator){const e=(0,R.Z)(h.js_data_mutator);p=e(p)}const u=h.metric?h.metric.label||h.metric:null,m=null===h.metric?()=>[c.r,c.g,c.b,255*c.a]:k(h,p,(e=>e[u])),f=e=>{const t=m(e);return s.length>0&&!o()(s).call(s,e[h.line_column])&&(t[3]/=2),t},y=h.line_column&&h.metric&&o()(d=["json","geohash","zipcode"]).call(d,h.line_type)?function(e){return t=>{const i=e.metric.label||e.metric;return(0,T.tZ)("div",{className:"deckgl-tooltip"},t.object.name&&(0,T.tZ)(C.Z,{label:(0,r.t)("name")+": ",value:`${t.object.name}`}),t.object[e.line_column]&&(0,T.tZ)(C.Z,{label:`${e.line_column}: `,value:`${t.object[e.line_column]}`}),e.metric&&(0,T.tZ)(C.Z,{label:`${i}: `,value:`${t.object[i]}`}))}}(h):void 0;return new _({id:`path-layer-${h.slice_id}`,data:p,pickable:!0,filled:h.filled,stroked:h.stroked,getPolygon:Z,getFillColor:f,getLineColor:[g.r,g.g,g.b,255*g.a],getLineWidth:h.line_width,extruded:h.extruded,getElevation:e=>function(e,t){return 0===t(e)[3]?0:e.elevation}(e,f),elevationScale:h.multiplier,fp64:!0,...(0,A.N)(h,a,y,l)})}const M={formData:n().object.isRequired,payload:n().object.isRequired,setControlValue:n().func.isRequired,viewport:n().object.isRequired,onAddFilter:n().func,width:n().number.isRequired,height:n().number.isRequired},E={onAddFilter(){}};class V extends s.Component{constructor(e){super(e),this.containerRef=s.createRef(),this.setTooltip=e=>{const{current:t}=this.containerRef;t&&t.setTooltip(e)},this.state=V.getDerivedStateFromProps(e),this.getLayers=this.getLayers.bind(this),this.onSelect=this.onSelect.bind(this),this.onValuesChange=this.onValuesChange.bind(this)}static getDerivedStateFromProps(e,t){const{width:i,height:a,formData:o,payload:s}=e;if(t&&s.form_data===t.formData)return null;const r=s.data.features||[],l=r.map((e=>e.__timestamp)),n=s.form_data.time_grain_sqla||s.form_data.granularity||"P1D",{start:d,end:h,getStep:c,values:g,disabled:p}=(0,D.g)(l,n);let{viewport:u}=e;return o.autozoom&&(u=(0,W.Z)(u,{width:i,height:a,points:r.flatMap(Z)})),{start:d,end:h,getStep:c,values:g,disabled:p,viewport:u,selected:[],lastClick:0,formData:s.form_data}}onSelect(e){const{formData:t,onAddFilter:i}=this.props,a=new Date,o=a-this.state.lastClick<=250,s=[...this.state.selected];if(o)s.splice(0,s.length,e);else if(t.toggle_polygons){const t=s.indexOf(e);-1===t?s.push(e):s.splice(t,1)}else s.splice(0,1,e);this.setState({selected:s,lastClick:a}),t.table_filter&&i(t.line_column,s,!1,!0)}onValuesChange(e){this.setState({values:Array.isArray(e)?e:[e,e+this.state.getStep(e)]})}getLayers(e){if(void 0===this.props.payload.data.features)return[];const t=[];return e[0]===e[1]||e[1]===this.end?t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<=e[1])):t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<e[1])),[j(this.props.formData,this.props.payload,this.props.onAddFilter,this.setTooltip,this.state.selected,this.onSelect,t)]}render(){const{payload:e,formData:t,setControlValue:i}=this.props,{start:a,end:o,getStep:s,values:r,disabled:l,viewport:n}=this.state,d=t,h=d.metric?d.metric.label||d.metric:null,c=function(e,t,i){const a=F(e,t,i),o=k(e,t,i),s={};return a.slice(1).forEach(((t,i)=>{const r=`${a[i]} - ${a[i+1]}`,l=.5*(parseFloat(a[i])+parseFloat(a[i+1])),n=e.metric?e.metric.label||e.metric:null;s[r]={color:o({[n||e.metric]:l}),enabled:!0}})),s}(t,e.data.features,(e=>e[h]));return(0,T.tZ)("div",{style:{position:"relative"}},(0,T.tZ)(b.Z,{ref:this.containerRef,aggregation:!0,getLayers:this.getLayers,start:a,end:o,getStep:s,values:r,disabled:l,viewport:n,width:this.props.width,height:this.props.height,mapboxApiAccessToken:e.data.mapboxApiKey,mapStyle:t.mapbox_style,setControlValue:i,onValuesChange:this.onValuesChange,onViewportChange:this.onViewportChange},null!==t.metric&&(0,T.tZ)(v.Z,{categories:c,position:t.legend_position,format:t.legend_format})))}}V.propTypes=M,V.defaultProps=E;const $=V}}]);
//# sourceMappingURL=9c6ff5d06296e26f681e.chunk.js.map
