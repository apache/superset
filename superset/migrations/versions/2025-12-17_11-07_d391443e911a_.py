# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
"""empty message

Revision ID: d391443e911a
Revises: 9be1da3aa048
Create Date: 2025-12-17 11:07:19.157747

"""

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "d391443e911a"
down_revision = "9be1da3aa048"


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column(
        "ab_view_menu",
        "name",
        existing_type=sa.VARCHAR(length=255),
        type_=sa.String(length=250),
        existing_nullable=False,
    )
    op.alter_column(
        "analyzed_column", "uuid", existing_type=postgresql.UUID(), nullable=True
    )
    op.drop_index("ix_analyzed_column_data_type", table_name="analyzed_column")
    op.drop_index("ix_analyzed_column_table_id", table_name="analyzed_column")
    op.drop_index("ix_analyzed_column_table_position", table_name="analyzed_column")
    op.alter_column(
        "analyzed_table", "uuid", existing_type=postgresql.UUID(), nullable=True
    )
    op.alter_column(
        "analyzed_table",
        "table_type",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum("TABLE", "VIEW", "MATERIALIZED_VIEW", name="tabletype"),
        existing_nullable=False,
    )
    op.drop_index("ix_analyzed_table_report_id", table_name="analyzed_table")
    op.drop_index("ix_analyzed_table_report_type", table_name="analyzed_table")
    op.drop_index("ix_analyzed_table_table_type", table_name="analyzed_table")
    op.alter_column(
        "annotation", "layer_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.create_unique_constraint(None, "css_templates", ["uuid"])
    op.alter_column(
        "dashboard_roles", "dashboard_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.alter_column(
        "database_schema_report", "uuid", existing_type=postgresql.UUID(), nullable=True
    )
    op.alter_column(
        "database_schema_report",
        "status",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "RESERVED", "RUNNING", "COMPLETED", "FAILED", name="analysisstatus"
        ),
        existing_nullable=False,
        existing_server_default=sa.text("'reserved'::character varying"),
    )
    op.drop_index(
        "ix_database_schema_report_celery_task_id", table_name="database_schema_report"
    )
    op.drop_index(
        "ix_database_schema_report_database_id", table_name="database_schema_report"
    )
    op.drop_index(
        "ix_database_schema_report_database_schema", table_name="database_schema_report"
    )
    op.drop_index(
        "ix_database_schema_report_status", table_name="database_schema_report"
    )
    op.alter_column(
        "dbs",
        "allow_file_upload",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "dynamic_plugin",
        "name",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Text(),
        existing_nullable=False,
    )
    op.alter_column(
        "dynamic_plugin",
        "key",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Text(),
        existing_nullable=False,
    )
    op.alter_column(
        "dynamic_plugin",
        "bundle_url",
        existing_type=sa.VARCHAR(length=1000),
        type_=sa.Text(),
        existing_nullable=False,
    )
    op.create_unique_constraint(None, "dynamic_plugin", ["bundle_url"])
    op.alter_column(
        "embedded_dashboards", "uuid", existing_type=postgresql.UUID(), nullable=False
    )
    op.create_foreign_key(
        None, "embedded_dashboards", "ab_user", ["changed_by_fk"], ["id"]
    )
    op.create_foreign_key(
        None, "embedded_dashboards", "ab_user", ["created_by_fk"], ["id"]
    )
    op.create_unique_constraint(None, "favstar", ["uuid"])
    op.alter_column(
        "inferred_join", "uuid", existing_type=postgresql.UUID(), nullable=True
    )
    op.alter_column(
        "inferred_join",
        "join_type",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum("INNER", "LEFT", "RIGHT", "FULL", "CROSS", name="jointype"),
        existing_nullable=False,
        existing_server_default=sa.text("'inner'::character varying"),
    )
    op.alter_column(
        "inferred_join",
        "cardinality",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.Enum(
            "ONE_TO_ONE",
            "ONE_TO_MANY",
            "MANY_TO_ONE",
            "MANY_TO_MANY",
            name="cardinality",
        ),
        existing_nullable=False,
    )
    op.drop_index("ix_inferred_join_join_type", table_name="inferred_join")
    op.drop_index("ix_inferred_join_report_id", table_name="inferred_join")
    op.drop_index("ix_inferred_join_source_table_id", table_name="inferred_join")
    op.drop_index("ix_inferred_join_source_target", table_name="inferred_join")
    op.drop_index("ix_inferred_join_target_table_id", table_name="inferred_join")
    op.drop_index("ix_key_value_expires_on", table_name="key_value")
    op.drop_index("ix_key_value_uuid", table_name="key_value")
    op.create_unique_constraint(None, "key_value", ["uuid"])
    op.drop_index("ix_logs_user_id_dttm", table_name="logs")
    op.alter_column(
        "query",
        "limiting_factor",
        existing_type=sa.VARCHAR(length=255),
        type_=sa.Enum(
            "QUERY",
            "DROPDOWN",
            "QUERY_AND_DROPDOWN",
            "NOT_LIMITED",
            "UNKNOWN",
            name="limitingfactor",
        ),
        existing_nullable=True,
        existing_server_default=sa.text("'UNKNOWN'::character varying"),
    )
    op.drop_index("ix_sql_editor_id", table_name="query")
    op.create_index(
        op.f("ix_query_sql_editor_id"), "query", ["sql_editor_id"], unique=False
    )
    op.alter_column(
        "report_schedule", "extra_json", existing_type=sa.TEXT(), nullable=True
    )
    op.drop_index("ix_creation_method", table_name="report_schedule")
    op.create_unique_constraint(
        None, "report_schedule_user", ["user_id", "report_schedule_id"]
    )
    op.alter_column(
        "row_level_security_filters",
        "filter_type",
        existing_type=sa.VARCHAR(length=255),
        type_=sa.Enum("Regular", "Base", name="filter_type_enum"),
        existing_nullable=True,
    )
    op.drop_index(
        "ix_row_level_security_filters_filter_type",
        table_name="row_level_security_filters",
    )
    op.alter_column(
        "slices",
        "perm",
        existing_type=sa.VARCHAR(length=2000),
        type_=sa.String(length=1000),
        existing_nullable=True,
    )
    op.drop_constraint("slices_table_id_fkey", "slices", type_="foreignkey")
    op.drop_column("slices", "druid_datasource_id")
    op.drop_column("slices", "table_id")
    op.alter_column(
        "sql_metrics",
        "currency",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
    )
    op.alter_column(
        "ssh_tunnels", "database_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.alter_column(
        "ssh_tunnels",
        "server_address",
        existing_type=sa.VARCHAR(length=256),
        type_=sa.Text(),
        existing_nullable=True,
    )
    op.drop_index("ix_ssh_tunnels_database_id", table_name="ssh_tunnels")
    op.drop_index("ix_ssh_tunnels_uuid", table_name="ssh_tunnels")
    op.create_unique_constraint(None, "ssh_tunnels", ["database_id"])
    op.create_unique_constraint(None, "ssh_tunnels", ["uuid"])
    op.create_foreign_key(None, "ssh_tunnels", "ab_user", ["created_by_fk"], ["id"])
    op.create_foreign_key(None, "ssh_tunnels", "ab_user", ["changed_by_fk"], ["id"])
    op.alter_column(
        "tab_state",
        "latest_query_id",
        existing_type=sa.VARCHAR(length=11),
        type_=sa.Integer(),
        existing_nullable=True,
    )
    op.alter_column("tab_state", "autorun", existing_type=sa.BOOLEAN(), nullable=True)
    op.alter_column(
        "tab_state",
        "hide_left_bar",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.drop_index("ix_tab_state_id", table_name="tab_state")
    op.drop_index("ix_table_schema_id", table_name="table_schema")
    op.alter_column(
        "tables",
        "params",
        existing_type=sa.TEXT(),
        type_=sa.String(length=1000),
        existing_nullable=True,
    )
    op.drop_constraint("_customer_location_uc", "tables", type_="unique")
    op.create_unique_constraint(
        None, "tables", ["database_id", "catalog", "schema", "table_name"]
    )
    op.alter_column(
        "tag",
        "type",
        existing_type=sa.VARCHAR(),
        type_=sa.Enum("custom", "type", "owner", "favorited_by", name="tagtype"),
        existing_nullable=True,
    )
    op.alter_column(
        "tagged_object",
        "object_type",
        existing_type=sa.VARCHAR(),
        type_=sa.Enum("query", "chart", "dashboard", "dataset", name="objecttype"),
        existing_nullable=True,
    )
    op.drop_index("ix_tagged_object_object_id", table_name="tagged_object")
    op.create_foreign_key(None, "tagged_object", "dashboards", ["object_id"], ["id"])
    op.create_foreign_key(None, "tagged_object", "slices", ["object_id"], ["id"])
    op.create_foreign_key(None, "tagged_object", "saved_query", ["object_id"], ["id"])
    op.alter_column(
        "user_favorite_tag", "user_id", existing_type=sa.INTEGER(), nullable=True
    )
    op.alter_column(
        "user_favorite_tag", "tag_id", existing_type=sa.INTEGER(), nullable=True
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column(
        "user_favorite_tag", "tag_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.alter_column(
        "user_favorite_tag", "user_id", existing_type=sa.INTEGER(), nullable=False
    )
    op.drop_constraint(None, "tagged_object", type_="foreignkey")
    op.drop_constraint(None, "tagged_object", type_="foreignkey")
    op.drop_constraint(None, "tagged_object", type_="foreignkey")
    op.create_index(
        "ix_tagged_object_object_id", "tagged_object", ["object_id"], unique=False
    )
    op.alter_column(
        "tagged_object",
        "object_type",
        existing_type=sa.Enum(
            "query", "chart", "dashboard", "dataset", name="objecttype"
        ),
        type_=sa.VARCHAR(),
        existing_nullable=True,
    )
    op.alter_column(
        "tag",
        "type",
        existing_type=sa.Enum(
            "custom", "type", "owner", "favorited_by", name="tagtype"
        ),
        type_=sa.VARCHAR(),
        existing_nullable=True,
    )
    op.drop_constraint(None, "tables", type_="unique")
    op.create_unique_constraint(
        "_customer_location_uc", "tables", ["database_id", "schema", "table_name"]
    )
    op.alter_column(
        "tables",
        "params",
        existing_type=sa.String(length=1000),
        type_=sa.TEXT(),
        existing_nullable=True,
    )
    op.create_index("ix_table_schema_id", "table_schema", ["id"], unique=True)
    op.create_index("ix_tab_state_id", "tab_state", ["id"], unique=True)
    op.alter_column(
        "tab_state",
        "hide_left_bar",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.alter_column("tab_state", "autorun", existing_type=sa.BOOLEAN(), nullable=False)
    op.alter_column(
        "tab_state",
        "latest_query_id",
        existing_type=sa.Integer(),
        type_=sa.VARCHAR(length=11),
        existing_nullable=True,
    )
    op.drop_constraint(None, "ssh_tunnels", type_="foreignkey")
    op.drop_constraint(None, "ssh_tunnels", type_="foreignkey")
    op.drop_constraint(None, "ssh_tunnels", type_="unique")
    op.drop_constraint(None, "ssh_tunnels", type_="unique")
    op.create_index("ix_ssh_tunnels_uuid", "ssh_tunnels", ["uuid"], unique=True)
    op.create_index(
        "ix_ssh_tunnels_database_id", "ssh_tunnels", ["database_id"], unique=True
    )
    op.alter_column(
        "ssh_tunnels",
        "server_address",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(length=256),
        existing_nullable=True,
    )
    op.alter_column(
        "ssh_tunnels", "database_id", existing_type=sa.INTEGER(), nullable=True
    )
    op.alter_column(
        "sql_metrics",
        "currency",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
    )
    op.add_column(
        "slices",
        sa.Column("table_id", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "slices",
        sa.Column(
            "druid_datasource_id", sa.INTEGER(), autoincrement=False, nullable=True
        ),
    )
    op.create_foreign_key(
        "slices_table_id_fkey", "slices", "tables", ["table_id"], ["id"]
    )
    op.alter_column(
        "slices",
        "perm",
        existing_type=sa.String(length=1000),
        type_=sa.VARCHAR(length=2000),
        existing_nullable=True,
    )
    op.create_index(
        "ix_row_level_security_filters_filter_type",
        "row_level_security_filters",
        ["filter_type"],
        unique=False,
    )
    op.alter_column(
        "row_level_security_filters",
        "filter_type",
        existing_type=sa.Enum("Regular", "Base", name="filter_type_enum"),
        type_=sa.VARCHAR(length=255),
        existing_nullable=True,
    )
    op.drop_constraint(None, "report_schedule_user", type_="unique")
    op.create_index(
        "ix_creation_method", "report_schedule", ["creation_method"], unique=False
    )
    op.alter_column(
        "report_schedule", "extra_json", existing_type=sa.TEXT(), nullable=False
    )
    op.drop_index(op.f("ix_query_sql_editor_id"), table_name="query")
    op.create_index("ix_sql_editor_id", "query", ["sql_editor_id"], unique=False)
    op.alter_column(
        "query",
        "limiting_factor",
        existing_type=sa.Enum(
            "QUERY",
            "DROPDOWN",
            "QUERY_AND_DROPDOWN",
            "NOT_LIMITED",
            "UNKNOWN",
            name="limitingfactor",
        ),
        type_=sa.VARCHAR(length=255),
        existing_nullable=True,
        existing_server_default=sa.text("'UNKNOWN'::character varying"),
    )
    op.create_index("ix_logs_user_id_dttm", "logs", ["user_id", "dttm"], unique=False)
    op.drop_constraint(None, "key_value", type_="unique")
    op.create_index("ix_key_value_uuid", "key_value", ["uuid"], unique=True)
    op.create_index(
        "ix_key_value_expires_on", "key_value", ["expires_on"], unique=False
    )
    op.create_index(
        "ix_inferred_join_target_table_id",
        "inferred_join",
        ["target_table_id"],
        unique=False,
    )
    op.create_index(
        "ix_inferred_join_source_target",
        "inferred_join",
        ["source_table_id", "target_table_id"],
        unique=False,
    )
    op.create_index(
        "ix_inferred_join_source_table_id",
        "inferred_join",
        ["source_table_id"],
        unique=False,
    )
    op.create_index(
        "ix_inferred_join_report_id", "inferred_join", ["report_id"], unique=False
    )
    op.create_index(
        "ix_inferred_join_join_type", "inferred_join", ["join_type"], unique=False
    )
    op.alter_column(
        "inferred_join",
        "cardinality",
        existing_type=sa.Enum(
            "ONE_TO_ONE",
            "ONE_TO_MANY",
            "MANY_TO_ONE",
            "MANY_TO_MANY",
            name="cardinality",
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "inferred_join",
        "join_type",
        existing_type=sa.Enum(
            "INNER", "LEFT", "RIGHT", "FULL", "CROSS", name="jointype"
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
        existing_server_default=sa.text("'inner'::character varying"),
    )
    op.alter_column(
        "inferred_join", "uuid", existing_type=postgresql.UUID(), nullable=False
    )
    op.drop_constraint(None, "favstar", type_="unique")
    op.drop_constraint(None, "embedded_dashboards", type_="foreignkey")
    op.drop_constraint(None, "embedded_dashboards", type_="foreignkey")
    op.alter_column(
        "embedded_dashboards", "uuid", existing_type=postgresql.UUID(), nullable=True
    )
    op.drop_constraint(None, "dynamic_plugin", type_="unique")
    op.alter_column(
        "dynamic_plugin",
        "bundle_url",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(length=1000),
        existing_nullable=False,
    )
    op.alter_column(
        "dynamic_plugin",
        "key",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "dynamic_plugin",
        "name",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "dbs",
        "allow_file_upload",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("true"),
    )
    op.create_index(
        "ix_database_schema_report_status",
        "database_schema_report",
        ["status"],
        unique=False,
    )
    op.create_index(
        "ix_database_schema_report_database_schema",
        "database_schema_report",
        ["database_id", "schema_name"],
        unique=False,
    )
    op.create_index(
        "ix_database_schema_report_database_id",
        "database_schema_report",
        ["database_id"],
        unique=False,
    )
    op.create_index(
        "ix_database_schema_report_celery_task_id",
        "database_schema_report",
        ["celery_task_id"],
        unique=False,
    )
    op.alter_column(
        "database_schema_report",
        "status",
        existing_type=sa.Enum(
            "RESERVED", "RUNNING", "COMPLETED", "FAILED", name="analysisstatus"
        ),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
        existing_server_default=sa.text("'reserved'::character varying"),
    )
    op.alter_column(
        "database_schema_report",
        "uuid",
        existing_type=postgresql.UUID(),
        nullable=False,
    )
    op.alter_column(
        "dashboard_roles", "dashboard_id", existing_type=sa.INTEGER(), nullable=True
    )
    op.drop_constraint(None, "css_templates", type_="unique")
    op.alter_column("annotation", "layer_id", existing_type=sa.INTEGER(), nullable=True)
    op.create_index(
        "ix_analyzed_table_table_type", "analyzed_table", ["table_type"], unique=False
    )
    op.create_index(
        "ix_analyzed_table_report_type",
        "analyzed_table",
        ["report_id", "table_type"],
        unique=False,
    )
    op.create_index(
        "ix_analyzed_table_report_id", "analyzed_table", ["report_id"], unique=False
    )
    op.alter_column(
        "analyzed_table",
        "table_type",
        existing_type=sa.Enum("TABLE", "VIEW", "MATERIALIZED_VIEW", name="tabletype"),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.alter_column(
        "analyzed_table", "uuid", existing_type=postgresql.UUID(), nullable=False
    )
    op.create_index(
        "ix_analyzed_column_table_position",
        "analyzed_column",
        ["table_id", "ordinal_position"],
        unique=False,
    )
    op.create_index(
        "ix_analyzed_column_table_id", "analyzed_column", ["table_id"], unique=False
    )
    op.create_index(
        "ix_analyzed_column_data_type", "analyzed_column", ["data_type"], unique=False
    )
    op.alter_column(
        "analyzed_column", "uuid", existing_type=postgresql.UUID(), nullable=False
    )
    op.alter_column(
        "ab_view_menu",
        "name",
        existing_type=sa.String(length=250),
        type_=sa.VARCHAR(length=255),
        existing_nullable=False,
    )
    # ### end Alembic commands ###
