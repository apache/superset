{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _reverseInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/reverse\";import _Object$assign from \"@babel/runtime-corejs3/core-js-stable/object/assign\";import _sortInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/sort\";import _reduceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/reduce\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _parseInt from \"@babel/runtime-corejs3/core-js-stable/parse-int\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";var _jsxFileName = \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Mustache from 'mustache';\nimport { scaleLinear } from 'd3-scale';\nimport { Table, Thead, Th, Tr, Td } from 'reactable-arc';\nimport { formatNumber } from '@superset-ui/number-format';\nimport { formatTime } from '@superset-ui/time-format';\nimport moment from 'moment';\nimport {\nInfoTooltipWithTrigger,\nMetricOption } from\n'@superset-ui/chart-controls';\n\nimport FormattedNumber from './FormattedNumber';\nimport SparklineCell from './SparklineCell';\nimport './TimeTable.less';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst ACCESSIBLE_COLOR_BOUNDS = ['#ca0020', '#0571b0'];\n\nfunction colorFromBounds(value, bounds, colorBounds = ACCESSIBLE_COLOR_BOUNDS) {\n  if (bounds) {\n    const [min, max] = bounds;\n    const [minColor, maxColor] = colorBounds;\n    if (min !== null && max !== null) {\n      const colorScale = scaleLinear().\n      domain([min, (max + min) / 2, max]).\n      range([minColor, 'grey', maxColor]);\n      return colorScale(value);\n    } else if (min !== null) {\n      return value >= min ? maxColor : minColor;\n    } else if (max !== null) {\n      return value < max ? maxColor : minColor;\n    }\n  }\n  return null;\n}\n\nconst propTypes = {\n  className: PropTypes.string,\n  height: PropTypes.number,\n  // Example\n  // {'2018-04-14 00:00:00': { 'SUM(metric_value)': 80031779.40047 }}\n  data: PropTypes.objectOf(PropTypes.objectOf(PropTypes.number)).isRequired,\n  columnConfigs: PropTypes.arrayOf(\n  PropTypes.shape({\n    colType: PropTypes.string,\n    comparisonType: PropTypes.string,\n    d3format: PropTypes.string,\n    key: PropTypes.string,\n    label: PropTypes.string,\n    timeLag: PropTypes.number })).\n\n  isRequired,\n  rows: PropTypes.arrayOf(\n  PropTypes.oneOfType([\n  PropTypes.shape({\n    label: PropTypes.string }),\n\n  PropTypes.shape({\n    metric_name: PropTypes.string })])).\n\n\n  isRequired,\n  rowType: PropTypes.oneOf(['column', 'metric']).isRequired,\n  url: PropTypes.string };\n\nconst defaultProps = {\n  className: '',\n  height: undefined,\n  url: '' };\n\n\nclass TimeTable extends React.PureComponent {\n  renderLeftCell(row) {\n    const { rowType, url } = this.props;\n    const context = { metric: row };\n    const fullUrl = url ? Mustache.render(url, context) : null;\n\n    if (rowType === 'column') {\n      const column = row;\n      if (fullUrl) {\n        return (\n          ___EmotionJSX(\"a\", { href: fullUrl, rel: \"noopener noreferrer\", target: \"_blank\", __source: { fileName: _jsxFileName, lineNumber: 101 }, __self: this },\n          column.label));\n\n\n      }\n      return column.label;\n    }\n\n    const metric = row;\n    return (\n      ___EmotionJSX(MetricOption, {\n        metric: metric,\n        url: fullUrl,\n        showFormula: false,\n        openInNewWindow: true, __source: { fileName: _jsxFileName, lineNumber: 111 }, __self: this }));\n\n\n  }\n\n  renderSparklineCell(valueField, column, entries) {\n    let sparkData;\n    if (column.timeRatio) {\n      // Period ratio sparkline\n      sparkData = [];\n      for (let i = column.timeRatio; i < entries.length; i++) {\n        const prevData = entries[i - column.timeRatio][valueField];\n        if (prevData && prevData !== 0) {\n          sparkData.push(entries[i][valueField] / prevData);\n        } else {\n          sparkData.push(null);\n        }\n      }\n    } else {\n      sparkData = _mapInstanceProperty(entries).call(entries, d => d[valueField]);\n    }\n\n    return (\n      ___EmotionJSX(Td, {\n        column: column.key,\n        key: column.key,\n        value: sparkData[sparkData.length - 1], __source: { fileName: _jsxFileName, lineNumber: 138 }, __self: this },\n\n      ___EmotionJSX(SparklineCell, {\n        width: _parseInt(column.width, 10) || 300,\n        height: _parseInt(column.height, 10) || 50,\n        data: sparkData,\n        ariaLabel: \"spark-\" + valueField,\n        numberFormat: column.d3format,\n        yAxisBounds: column.yAxisBounds,\n        showYAxis: column.showYAxis,\n        renderTooltip: ({ index }) =>\n        ___EmotionJSX(\"div\", { __source: { fileName: _jsxFileName, lineNumber: 152 }, __self: this },\n        ___EmotionJSX(\"strong\", { __source: { fileName: _jsxFileName, lineNumber: 153 }, __self: this }, formatNumber(column.d3format, sparkData[index])),\n        ___EmotionJSX(\"div\", { __source: { fileName: _jsxFileName, lineNumber: 154 }, __self: this },\n        formatTime(\n        column.dateFormat,\n        moment.utc(entries[index].time).toDate()))), __source: { fileName: _jsxFileName, lineNumber: 143 }, __self: this })));\n\n\n\n\n\n\n\n  }\n\n  renderValueCell(valueField, column, reversedEntries) {\n    const recent = reversedEntries[0][valueField];\n    let v;\n    let errorMsg;\n    if (column.colType === 'time') {\n      // Time lag ratio\n      const timeLag = column.timeLag || 0;\n      const totalLag = _Object$keys(reversedEntries).length;\n      if (timeLag >= totalLag) {\n        errorMsg = \"The time lag set at \" + timeLag + \" is too large for the length of data at \" + reversedEntries.length + \". No data available.\";\n      } else {\n        v = reversedEntries[timeLag][valueField];\n      }\n      if (column.comparisonType === 'diff') {\n        v = recent - v;\n      } else if (column.comparisonType === 'perc') {\n        v = recent / v;\n      } else if (column.comparisonType === 'perc_change') {\n        v = recent / v - 1;\n      }\n      v = v || 0;\n    } else if (column.colType === 'contrib') {var _context, _context2;\n      // contribution to column total\n      v =\n      recent /\n      _reduceInstanceProperty(_context = _mapInstanceProperty(_context2 = _Object$keys(reversedEntries[0])).call(_context2,\n      k => k !== 'time' ? reversedEntries[0][k] : null)).call(_context,\n      (a, b) => a + b);\n    } else if (column.colType === 'avg') {var _context3;\n      // Average over the last {timeLag}\n      v =\n      _reduceInstanceProperty(_context3 = _mapInstanceProperty(reversedEntries).call(reversedEntries,\n      (k, i) => i < column.timeLag ? k[valueField] : 0)).call(_context3,\n      (a, b) => a + b) / column.timeLag;\n    }\n\n    const color = colorFromBounds(v, column.bounds);\n\n    return (\n      ___EmotionJSX(Td, {\n        column: column.key,\n        key: column.key,\n        value: v,\n        style:\n        color && {\n          boxShadow: \"inset 0px -2.5px 0px 0px \" + color,\n          borderRight: '2px solid #fff' }, __source: { fileName: _jsxFileName, lineNumber: 206 }, __self: this },\n\n\n\n      errorMsg ?\n      ___EmotionJSX(\"div\", { __source: { fileName: _jsxFileName, lineNumber: 218 }, __self: this }, errorMsg) :\n\n      ___EmotionJSX(\"div\", { style: { color }, __source: { fileName: _jsxFileName, lineNumber: 220 }, __self: this },\n      ___EmotionJSX(FormattedNumber, { num: v, format: column.d3format, __source: { fileName: _jsxFileName, lineNumber: 221 }, __self: this }))));\n\n\n\n\n  }\n\n  renderRow(row, entries, reversedEntries) {\n    const { columnConfigs } = this.props;\n    const valueField = row.label || row.metric_name;\n    const leftCell = this.renderLeftCell(row);\n\n    return (\n      ___EmotionJSX(Tr, { key: leftCell, __source: { fileName: _jsxFileName, lineNumber: 234 }, __self: this },\n      ___EmotionJSX(Td, { column: \"metric\", data: leftCell, __source: { fileName: _jsxFileName, lineNumber: 235 }, __self: this },\n      leftCell),\n\n      _mapInstanceProperty(columnConfigs).call(columnConfigs, (c) =>\n      c.colType === 'spark' ?\n      this.renderSparklineCell(valueField, c, entries) :\n      this.renderValueCell(valueField, c, reversedEntries))));\n\n\n\n  }\n\n  render() {var _context4, _context5, _context6;\n    const {\n      className,\n      height,\n      data,\n      columnConfigs,\n      rowType,\n      rows } =\n    this.props;\n\n    const entries = _mapInstanceProperty(_context4 = _sortInstanceProperty(_context5 = _Object$keys(data)).call(_context5)).call(_context4,\n\n    time => _Object$assign({}, data[time], { time }));\n    const reversedEntries = _reverseInstanceProperty(_context6 = _concatInstanceProperty(entries).call(entries)).call(_context6);\n\n    const defaultSort =\n    rowType === 'column' && columnConfigs.length ?\n    {\n      column: columnConfigs[0].key,\n      direction: 'desc' } :\n\n    false;\n\n    return (\n      ___EmotionJSX(\"div\", { className: \"time-table \" + className, style: { height }, __source: { fileName: _jsxFileName, lineNumber: 271 }, __self: this },\n      ___EmotionJSX(Table, {\n        className: \"table table-no-hover\",\n        defaultSort: defaultSort,\n        sortBy: defaultSort,\n        sortable: _mapInstanceProperty(columnConfigs).call(columnConfigs, c => c.key), __source: { fileName: _jsxFileName, lineNumber: 272 }, __self: this },\n\n      ___EmotionJSX(Thead, { __source: { fileName: _jsxFileName, lineNumber: 278 }, __self: this },\n      ___EmotionJSX(Th, { column: \"metric\", __source: { fileName: _jsxFileName, lineNumber: 279 }, __self: this }, \"Metric\"),\n      _mapInstanceProperty(columnConfigs).call(columnConfigs, (c, i) =>\n      ___EmotionJSX(Th, {\n        key: c.key,\n        column: c.key,\n        width: c.colType === 'spark' ? '1%' : null, __source: { fileName: _jsxFileName, lineNumber: 281 }, __self: this },\n\n      c.label, ' ',\n      c.tooltip &&\n      ___EmotionJSX(InfoTooltipWithTrigger, {\n        tooltip: c.tooltip,\n        label: \"tt-col-\" + i,\n        placement: \"top\", __source: { fileName: _jsxFileName, lineNumber: 288 }, __self: this })))),\n\n\n\n\n\n      _mapInstanceProperty(rows).call(rows, row => this.renderRow(row, entries, reversedEntries)))));\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nTimeTable.propTypes = propTypes;\nTimeTable.defaultProps = defaultProps;const _default =\n\nTimeTable;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(ACCESSIBLE_COLOR_BOUNDS, \"ACCESSIBLE_COLOR_BOUNDS\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\");reactHotLoader.register(colorFromBounds, \"colorFromBounds\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\");reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\");reactHotLoader.register(TimeTable, \"TimeTable\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/visualizations/TimeTable/TimeTable.jsx"],"names":["React","PropTypes","Mustache","scaleLinear","Table","Thead","Th","Tr","Td","formatNumber","formatTime","moment","InfoTooltipWithTrigger","MetricOption","FormattedNumber","SparklineCell","ACCESSIBLE_COLOR_BOUNDS","colorFromBounds","value","bounds","colorBounds","min","max","minColor","maxColor","colorScale","domain","range","propTypes","className","string","height","number","data","objectOf","isRequired","columnConfigs","arrayOf","shape","colType","comparisonType","d3format","key","label","timeLag","rows","oneOfType","metric_name","rowType","oneOf","url","defaultProps","undefined","TimeTable","PureComponent","renderLeftCell","row","props","context","metric","fullUrl","render","column","renderSparklineCell","valueField","entries","sparkData","timeRatio","i","length","prevData","push","d","width","yAxisBounds","showYAxis","index","dateFormat","utc","time","toDate","renderValueCell","reversedEntries","recent","v","errorMsg","totalLag","k","a","b","color","boxShadow","borderRight","renderRow","leftCell","c","defaultSort","direction","tooltip"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Mustache from 'mustache';\nimport { scaleLinear } from 'd3-scale';\nimport { Table, Thead, Th, Tr, Td } from 'reactable-arc';\nimport { formatNumber } from '@superset-ui/number-format';\nimport { formatTime } from '@superset-ui/time-format';\nimport moment from 'moment';\nimport {\n  InfoTooltipWithTrigger,\n  MetricOption,\n} from '@superset-ui/chart-controls';\n\nimport FormattedNumber from './FormattedNumber';\nimport SparklineCell from './SparklineCell';\nimport './TimeTable.less';\n\nconst ACCESSIBLE_COLOR_BOUNDS = ['#ca0020', '#0571b0'];\n\nfunction colorFromBounds(value, bounds, colorBounds = ACCESSIBLE_COLOR_BOUNDS) {\n  if (bounds) {\n    const [min, max] = bounds;\n    const [minColor, maxColor] = colorBounds;\n    if (min !== null && max !== null) {\n      const colorScale = scaleLinear()\n        .domain([min, (max + min) / 2, max])\n        .range([minColor, 'grey', maxColor]);\n      return colorScale(value);\n    } else if (min !== null) {\n      return value >= min ? maxColor : minColor;\n    } else if (max !== null) {\n      return value < max ? maxColor : minColor;\n    }\n  }\n  return null;\n}\n\nconst propTypes = {\n  className: PropTypes.string,\n  height: PropTypes.number,\n  // Example\n  // {'2018-04-14 00:00:00': { 'SUM(metric_value)': 80031779.40047 }}\n  data: PropTypes.objectOf(PropTypes.objectOf(PropTypes.number)).isRequired,\n  columnConfigs: PropTypes.arrayOf(\n    PropTypes.shape({\n      colType: PropTypes.string,\n      comparisonType: PropTypes.string,\n      d3format: PropTypes.string,\n      key: PropTypes.string,\n      label: PropTypes.string,\n      timeLag: PropTypes.number,\n    }),\n  ).isRequired,\n  rows: PropTypes.arrayOf(\n    PropTypes.oneOfType([\n      PropTypes.shape({\n        label: PropTypes.string,\n      }),\n      PropTypes.shape({\n        metric_name: PropTypes.string,\n      }),\n    ]),\n  ).isRequired,\n  rowType: PropTypes.oneOf(['column', 'metric']).isRequired,\n  url: PropTypes.string,\n};\nconst defaultProps = {\n  className: '',\n  height: undefined,\n  url: '',\n};\n\nclass TimeTable extends React.PureComponent {\n  renderLeftCell(row) {\n    const { rowType, url } = this.props;\n    const context = { metric: row };\n    const fullUrl = url ? Mustache.render(url, context) : null;\n\n    if (rowType === 'column') {\n      const column = row;\n      if (fullUrl) {\n        return (\n          <a href={fullUrl} rel=\"noopener noreferrer\" target=\"_blank\">\n            {column.label}\n          </a>\n        );\n      }\n      return column.label;\n    }\n\n    const metric = row;\n    return (\n      <MetricOption\n        metric={metric}\n        url={fullUrl}\n        showFormula={false}\n        openInNewWindow\n      />\n    );\n  }\n\n  renderSparklineCell(valueField, column, entries) {\n    let sparkData;\n    if (column.timeRatio) {\n      // Period ratio sparkline\n      sparkData = [];\n      for (let i = column.timeRatio; i < entries.length; i++) {\n        const prevData = entries[i - column.timeRatio][valueField];\n        if (prevData && prevData !== 0) {\n          sparkData.push(entries[i][valueField] / prevData);\n        } else {\n          sparkData.push(null);\n        }\n      }\n    } else {\n      sparkData = entries.map(d => d[valueField]);\n    }\n\n    return (\n      <Td\n        column={column.key}\n        key={column.key}\n        value={sparkData[sparkData.length - 1]}\n      >\n        <SparklineCell\n          width={parseInt(column.width, 10) || 300}\n          height={parseInt(column.height, 10) || 50}\n          data={sparkData}\n          ariaLabel={`spark-${valueField}`}\n          numberFormat={column.d3format}\n          yAxisBounds={column.yAxisBounds}\n          showYAxis={column.showYAxis}\n          renderTooltip={({ index }) => (\n            <div>\n              <strong>{formatNumber(column.d3format, sparkData[index])}</strong>\n              <div>\n                {formatTime(\n                  column.dateFormat,\n                  moment.utc(entries[index].time).toDate(),\n                )}\n              </div>\n            </div>\n          )}\n        />\n      </Td>\n    );\n  }\n\n  renderValueCell(valueField, column, reversedEntries) {\n    const recent = reversedEntries[0][valueField];\n    let v;\n    let errorMsg;\n    if (column.colType === 'time') {\n      // Time lag ratio\n      const timeLag = column.timeLag || 0;\n      const totalLag = Object.keys(reversedEntries).length;\n      if (timeLag >= totalLag) {\n        errorMsg = `The time lag set at ${timeLag} is too large for the length of data at ${reversedEntries.length}. No data available.`;\n      } else {\n        v = reversedEntries[timeLag][valueField];\n      }\n      if (column.comparisonType === 'diff') {\n        v = recent - v;\n      } else if (column.comparisonType === 'perc') {\n        v = recent / v;\n      } else if (column.comparisonType === 'perc_change') {\n        v = recent / v - 1;\n      }\n      v = v || 0;\n    } else if (column.colType === 'contrib') {\n      // contribution to column total\n      v =\n        recent /\n        Object.keys(reversedEntries[0])\n          .map(k => (k !== 'time' ? reversedEntries[0][k] : null))\n          .reduce((a, b) => a + b);\n    } else if (column.colType === 'avg') {\n      // Average over the last {timeLag}\n      v =\n        reversedEntries\n          .map((k, i) => (i < column.timeLag ? k[valueField] : 0))\n          .reduce((a, b) => a + b) / column.timeLag;\n    }\n\n    const color = colorFromBounds(v, column.bounds);\n\n    return (\n      <Td\n        column={column.key}\n        key={column.key}\n        value={v}\n        style={\n          color && {\n            boxShadow: `inset 0px -2.5px 0px 0px ${color}`,\n            borderRight: '2px solid #fff',\n          }\n        }\n      >\n        {errorMsg ? (\n          <div>{errorMsg}</div>\n        ) : (\n          <div style={{ color }}>\n            <FormattedNumber num={v} format={column.d3format} />\n          </div>\n        )}\n      </Td>\n    );\n  }\n\n  renderRow(row, entries, reversedEntries) {\n    const { columnConfigs } = this.props;\n    const valueField = row.label || row.metric_name;\n    const leftCell = this.renderLeftCell(row);\n\n    return (\n      <Tr key={leftCell}>\n        <Td column=\"metric\" data={leftCell}>\n          {leftCell}\n        </Td>\n        {columnConfigs.map(c =>\n          c.colType === 'spark'\n            ? this.renderSparklineCell(valueField, c, entries)\n            : this.renderValueCell(valueField, c, reversedEntries),\n        )}\n      </Tr>\n    );\n  }\n\n  render() {\n    const {\n      className,\n      height,\n      data,\n      columnConfigs,\n      rowType,\n      rows,\n    } = this.props;\n\n    const entries = Object.keys(data)\n      .sort()\n      .map(time => ({ ...data[time], time }));\n    const reversedEntries = entries.concat().reverse();\n\n    const defaultSort =\n      rowType === 'column' && columnConfigs.length\n        ? {\n            column: columnConfigs[0].key,\n            direction: 'desc',\n          }\n        : false;\n\n    return (\n      <div className={`time-table ${className}`} style={{ height }}>\n        <Table\n          className=\"table table-no-hover\"\n          defaultSort={defaultSort}\n          sortBy={defaultSort}\n          sortable={columnConfigs.map(c => c.key)}\n        >\n          <Thead>\n            <Th column=\"metric\">Metric</Th>\n            {columnConfigs.map((c, i) => (\n              <Th\n                key={c.key}\n                column={c.key}\n                width={c.colType === 'spark' ? '1%' : null}\n              >\n                {c.label}{' '}\n                {c.tooltip && (\n                  <InfoTooltipWithTrigger\n                    tooltip={c.tooltip}\n                    label={`tt-col-${i}`}\n                    placement=\"top\"\n                  />\n                )}\n              </Th>\n            ))}\n          </Thead>\n          {rows.map(row => this.renderRow(row, entries, reversedEntries))}\n        </Table>\n      </div>\n    );\n  }\n}\n\nTimeTable.propTypes = propTypes;\nTimeTable.defaultProps = defaultProps;\n\nexport default TimeTable;\n"]},"metadata":{},"sourceType":"module"}