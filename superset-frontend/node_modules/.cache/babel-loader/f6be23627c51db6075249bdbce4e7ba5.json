{"ast":null,"code":"import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _findInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/find\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";import _parseInt from \"@babel/runtime-corejs3/core-js-stable/parse-int\";import _forEachInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/for-each\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";var _jsxFileName = \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/AceEditorWrapper.tsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            */\nimport React from 'react';\nimport AceEditor from 'react-ace';\nimport 'brace/mode/sql';\nimport 'brace/theme/github';\nimport 'brace/ext/language_tools';\nimport ace from 'brace';\nimport { areArraysShallowEqual } from '../../reduxUtils';\nimport sqlKeywords from '../utils/sqlKeywords';\nimport { SCHEMA_AUTOCOMPLETE_SCORE, TABLE_AUTOCOMPLETE_SCORE, COLUMN_AUTOCOMPLETE_SCORE, SQL_FUNCTIONS_AUTOCOMPLETE_SCORE } from '../constants';import { jsx as ___EmotionJSX } from \"@emotion/core\";\nconst langTools = ace.acequire('ace/ext/language_tools');\nclass AceEditorWrapper extends React.PureComponent {\n  constructor(props) {var _context;\n    super(props);\n    this.state = {\n      sql: props.sql,\n      selectedText: '',\n      words: [] };\n\n    this.onChange = _bindInstanceProperty(_context = this.onChange).call(_context, this);\n  }\n  componentDidMount() {\n    // Making sure no text is selected from previous mount\n    this.props.actions.queryEditorSetSelectedText(this.props.queryEditor, null);\n    this.setAutoCompleter(this.props);\n  }\n  UNSAFE_componentWillReceiveProps(nextProps) {\n    if (!areArraysShallowEqual(this.props.tables, nextProps.tables) ||\n    !areArraysShallowEqual(this.props.schemas, nextProps.schemas) ||\n    !areArraysShallowEqual(this.props.extendedTables, nextProps.extendedTables)) {\n      this.setAutoCompleter(nextProps);\n    }\n    if (nextProps.sql !== this.props.sql) {\n      this.setState({ sql: nextProps.sql });\n    }\n  }\n  onBlur() {\n    this.props.onBlur(this.state.sql);\n  }\n  onAltEnter() {\n    this.props.onBlur(this.state.sql);\n  }\n  onEditorLoad(editor) {var _context2;\n    editor.commands.addCommand({\n      name: 'runQuery',\n      bindKey: { win: 'Alt-enter', mac: 'Alt-enter' },\n      exec: () => {\n        this.onAltEnter();\n      } });\n\n    _forEachInstanceProperty(_context2 = this.props.hotkeys).call(_context2, keyConfig => {\n      editor.commands.addCommand({\n        name: keyConfig.name,\n        bindKey: { win: keyConfig.key, mac: keyConfig.key },\n        exec: keyConfig.func });\n\n    });\n    editor.$blockScrolling = Infinity; // eslint-disable-line no-param-reassign\n    editor.selection.on('changeSelection', () => {\n      const selectedText = editor.getSelectedText();\n      // Backspace trigger 1 character selection, ignoring\n      if (selectedText !== this.state.selectedText &&\n      selectedText.length !== 1) {\n        this.setState({ selectedText });\n        this.props.actions.queryEditorSetSelectedText(this.props.queryEditor, selectedText);\n      }\n    });\n  }\n  onChange(text) {\n    this.setState({ sql: text });\n    this.props.onChange(text);\n  }\n  getCompletions(aceEditor, session, pos, prefix, callback) {var _context4;\n    // If the prefix starts with a number, don't try to autocomplete with a\n    // table name or schema or anything else\n    if (!isNaN(_parseInt(prefix, 10))) {\n      return;\n    }\n    const completer = {\n      insertMatch: (editor, data) => {var _context3;\n        if (data.meta === 'table') {\n          this.props.actions.addTable(this.props.queryEditor, data.value, this.props.queryEditor.schema);\n        }\n        editor.completer.insertMatch({\n          value: \"\" + data.caption + (_includesInstanceProperty(_context3 = ['function', 'schema']).call(_context3, data.meta) ? '' : ' ') });\n\n      } };\n\n    // Mutate instead of object spread here for performance\n    const words = _mapInstanceProperty(_context4 = this.state.words).call(_context4, word => {\n      /* eslint-disable-next-line no-param-reassign */\n      word.completer = completer;\n      return word;\n    });\n    callback(null, words);\n  }\n  setAutoCompleter(props) {var _context5, _context6, _context7, _context8, _context9;\n    // Loading schema, table and column names as auto-completable words\n    const schemas = props.schemas || [];\n    const schemaWords = _mapInstanceProperty(schemas).call(schemas, s => ({\n      name: s.label,\n      value: s.value,\n      score: SCHEMA_AUTOCOMPLETE_SCORE,\n      meta: 'schema' }));\n\n    const columns = {};\n    const tables = props.tables || [];\n    const extendedTables = props.extendedTables || [];\n    const tableWords = _mapInstanceProperty(tables).call(tables, t => {\n      const tableName = t.value;\n      const extendedTable = _findInstanceProperty(extendedTables).call(extendedTables, et => et.name === tableName);\n      const cols = extendedTable && extendedTable.columns || [];\n      _forEachInstanceProperty(cols).call(cols, col => {\n        columns[col.name] = null; // using an object as a unique set\n      });\n      return {\n        name: t.label,\n        value: tableName,\n        score: TABLE_AUTOCOMPLETE_SCORE,\n        meta: 'table' };\n\n    });\n    const columnWords = _mapInstanceProperty(_context5 = _Object$keys(columns)).call(_context5, col => ({\n      name: col,\n      value: col,\n      score: COLUMN_AUTOCOMPLETE_SCORE,\n      meta: 'column' }));\n\n    const functionWords = _mapInstanceProperty(_context6 = props.functionNames).call(_context6, func => ({\n      name: func,\n      value: func,\n      score: SQL_FUNCTIONS_AUTOCOMPLETE_SCORE,\n      meta: 'function' }));\n\n    const words = _concatInstanceProperty(_context7 = _concatInstanceProperty(_context8 = _concatInstanceProperty(_context9 = _concatInstanceProperty(schemaWords).call(schemaWords,\n    tableWords)).call(_context9,\n    columnWords)).call(_context8,\n    functionWords)).call(_context7,\n    sqlKeywords);\n    this.setState({ words }, () => {var _context10;\n      const completer = {\n        getCompletions: _bindInstanceProperty(_context10 = this.getCompletions).call(_context10, this) };\n\n      if (langTools) {\n        langTools.setCompleters([completer]);\n      }\n    });\n  }\n  getAceAnnotations() {\n    const validationResult = this.props.queryEditor.validationResult;\n    const resultIsReady = validationResult && validationResult.completed;\n    if (resultIsReady && validationResult.errors.length > 0) {var _context11;\n      const errors = _mapInstanceProperty(_context11 = validationResult.errors).call(_context11, err => ({\n        type: 'error',\n        row: err.line_number - 1,\n        column: err.start_column - 1,\n        text: err.message }));\n\n      return errors;\n    }\n    return [];\n  }\n  render() {var _context12, _context13;\n    return ___EmotionJSX(AceEditor, { mode: \"sql\", theme: \"github\", onLoad: _bindInstanceProperty(_context12 = this.onEditorLoad).call(_context12, this), onBlur: _bindInstanceProperty(_context13 = this.onBlur).call(_context13, this), height: this.props.height, onChange: this.onChange, width: \"100%\", editorProps: { $blockScrolling: true }, enableLiveAutocompletion: this.props.autocomplete, value: this.state.sql, annotations: this.getAceAnnotations(), __source: { fileName: _jsxFileName, lineNumber: 181 }, __self: this });\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}AceEditorWrapper.defaultProps = {\n  onBlur: () => {},\n  onChange: () => {},\n  schemas: [],\n  tables: [],\n  functionNames: [],\n  extendedTables: [] };const _default =\n\nAceEditorWrapper;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(langTools, \"langTools\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/AceEditorWrapper.tsx\");reactHotLoader.register(AceEditorWrapper, \"AceEditorWrapper\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/AceEditorWrapper.tsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/AceEditorWrapper.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/AceEditorWrapper.tsx"],"names":[],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport AceEditor from 'react-ace';\nimport 'brace/mode/sql';\nimport 'brace/theme/github';\nimport 'brace/ext/language_tools';\nimport ace from 'brace';\nimport { areArraysShallowEqual } from '../../reduxUtils';\nimport sqlKeywords from '../utils/sqlKeywords';\nimport {\n  SCHEMA_AUTOCOMPLETE_SCORE,\n  TABLE_AUTOCOMPLETE_SCORE,\n  COLUMN_AUTOCOMPLETE_SCORE,\n  SQL_FUNCTIONS_AUTOCOMPLETE_SCORE,\n} from '../constants';\n\nconst langTools = ace.acequire('ace/ext/language_tools');\n\ntype HotKey = {\n  key: string;\n  descr: string;\n  name: string;\n  func: () => void;\n};\n\ninterface Props {\n  actions: {\n    queryEditorSetSelectedText: (edit: any, text: null | string) => void;\n    addTable: (queryEditor: any, value: any, schema: any) => void;\n  };\n  autocomplete: boolean;\n  onBlur: (sql: string) => void;\n  sql: string;\n  schemas: any[];\n  tables: any[];\n  functionNames: string[];\n  extendedTables: Array<{ name: string; columns: any[] }>;\n  queryEditor: any;\n  height: string;\n  hotkeys: HotKey[];\n  onChange: (sql: string) => void;\n}\n\ninterface State {\n  sql: string;\n  selectedText: string;\n  words: any[];\n}\n\nclass AceEditorWrapper extends React.PureComponent<Props, State> {\n  static defaultProps = {\n    onBlur: () => {},\n    onChange: () => {},\n    schemas: [],\n    tables: [],\n    functionNames: [],\n    extendedTables: [],\n  };\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      sql: props.sql,\n      selectedText: '',\n      words: [],\n    };\n    this.onChange = this.onChange.bind(this);\n  }\n  componentDidMount() {\n    // Making sure no text is selected from previous mount\n    this.props.actions.queryEditorSetSelectedText(this.props.queryEditor, null);\n    this.setAutoCompleter(this.props);\n  }\n  UNSAFE_componentWillReceiveProps(nextProps: Props) {\n    if (\n      !areArraysShallowEqual(this.props.tables, nextProps.tables) ||\n      !areArraysShallowEqual(this.props.schemas, nextProps.schemas) ||\n      !areArraysShallowEqual(\n        this.props.extendedTables,\n        nextProps.extendedTables,\n      )\n    ) {\n      this.setAutoCompleter(nextProps);\n    }\n    if (nextProps.sql !== this.props.sql) {\n      this.setState({ sql: nextProps.sql });\n    }\n  }\n  onBlur() {\n    this.props.onBlur(this.state.sql);\n  }\n  onAltEnter() {\n    this.props.onBlur(this.state.sql);\n  }\n  onEditorLoad(editor: any) {\n    editor.commands.addCommand({\n      name: 'runQuery',\n      bindKey: { win: 'Alt-enter', mac: 'Alt-enter' },\n      exec: () => {\n        this.onAltEnter();\n      },\n    });\n    this.props.hotkeys.forEach(keyConfig => {\n      editor.commands.addCommand({\n        name: keyConfig.name,\n        bindKey: { win: keyConfig.key, mac: keyConfig.key },\n        exec: keyConfig.func,\n      });\n    });\n    editor.$blockScrolling = Infinity; // eslint-disable-line no-param-reassign\n    editor.selection.on('changeSelection', () => {\n      const selectedText = editor.getSelectedText();\n      // Backspace trigger 1 character selection, ignoring\n      if (\n        selectedText !== this.state.selectedText &&\n        selectedText.length !== 1\n      ) {\n        this.setState({ selectedText });\n        this.props.actions.queryEditorSetSelectedText(\n          this.props.queryEditor,\n          selectedText,\n        );\n      }\n    });\n  }\n  onChange(text: string) {\n    this.setState({ sql: text });\n    this.props.onChange(text);\n  }\n  getCompletions(\n    aceEditor: any,\n    session: any,\n    pos: any,\n    prefix: string,\n    callback: (p0: any, p1: any[]) => void,\n  ) {\n    // If the prefix starts with a number, don't try to autocomplete with a\n    // table name or schema or anything else\n    if (!isNaN(parseInt(prefix, 10))) {\n      return;\n    }\n    const completer = {\n      insertMatch: (editor: any, data: any) => {\n        if (data.meta === 'table') {\n          this.props.actions.addTable(\n            this.props.queryEditor,\n            data.value,\n            this.props.queryEditor.schema,\n          );\n        }\n        editor.completer.insertMatch({\n          value: `${data.caption}${\n            ['function', 'schema'].includes(data.meta) ? '' : ' '\n          }`,\n        });\n      },\n    };\n    // Mutate instead of object spread here for performance\n    const words = this.state.words.map(word => {\n      /* eslint-disable-next-line no-param-reassign */\n      word.completer = completer;\n      return word;\n    });\n    callback(null, words);\n  }\n  setAutoCompleter(props: Props) {\n    // Loading schema, table and column names as auto-completable words\n    const schemas = props.schemas || [];\n    const schemaWords = schemas.map(s => ({\n      name: s.label,\n      value: s.value,\n      score: SCHEMA_AUTOCOMPLETE_SCORE,\n      meta: 'schema',\n    }));\n    const columns = {};\n    const tables = props.tables || [];\n    const extendedTables = props.extendedTables || [];\n    const tableWords = tables.map(t => {\n      const tableName = t.value;\n      const extendedTable = extendedTables.find(et => et.name === tableName);\n      const cols = (extendedTable && extendedTable.columns) || [];\n      cols.forEach(col => {\n        columns[col.name] = null; // using an object as a unique set\n      });\n      return {\n        name: t.label,\n        value: tableName,\n        score: TABLE_AUTOCOMPLETE_SCORE,\n        meta: 'table',\n      };\n    });\n\n    const columnWords = Object.keys(columns).map(col => ({\n      name: col,\n      value: col,\n      score: COLUMN_AUTOCOMPLETE_SCORE,\n      meta: 'column',\n    }));\n\n    const functionWords = props.functionNames.map(func => ({\n      name: func,\n      value: func,\n      score: SQL_FUNCTIONS_AUTOCOMPLETE_SCORE,\n      meta: 'function',\n    }));\n\n    const words = schemaWords\n      .concat(tableWords)\n      .concat(columnWords)\n      .concat(functionWords)\n      .concat(sqlKeywords);\n\n    this.setState({ words }, () => {\n      const completer = {\n        getCompletions: this.getCompletions.bind(this),\n      };\n      if (langTools) {\n        langTools.setCompleters([completer]);\n      }\n    });\n  }\n  getAceAnnotations() {\n    const validationResult = this.props.queryEditor.validationResult;\n    const resultIsReady = validationResult && validationResult.completed;\n    if (resultIsReady && validationResult.errors.length > 0) {\n      const errors = validationResult.errors.map((err: any) => ({\n        type: 'error',\n        row: err.line_number - 1,\n        column: err.start_column - 1,\n        text: err.message,\n      }));\n      return errors;\n    }\n    return [];\n  }\n  render() {\n    return (\n      <AceEditor\n        mode=\"sql\"\n        theme=\"github\"\n        onLoad={this.onEditorLoad.bind(this)}\n        onBlur={this.onBlur.bind(this)}\n        height={this.props.height}\n        onChange={this.onChange}\n        width=\"100%\"\n        editorProps={{ $blockScrolling: true }}\n        enableLiveAutocompletion={this.props.autocomplete}\n        value={this.state.sql}\n        annotations={this.getAceAnnotations()}\n      />\n    );\n  }\n}\n\nexport default AceEditorWrapper;\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}