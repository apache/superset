{"ast":null,"code":"import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _sliceInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/slice\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";var _jsxFileName = \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { Button } from 'react-bootstrap';\nimport Select from 'src/components/Select';\nimport { t } from '@superset-ui/translation';\nimport { SupersetClient } from '@superset-ui/connection';\n\nimport Loading from '../../components/Loading';\nimport QueryTable from './QueryTable';\nimport {\nnow,\nepochTimeXHoursAgo,\nepochTimeXDaysAgo,\nepochTimeXYearsAgo } from\n'../../modules/dates';\nimport { STATUS_OPTIONS, TIME_OPTIONS } from '../constants';\nimport AsyncSelect from '../../components/AsyncSelect';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  height: PropTypes.string.isRequired,\n  displayLimit: PropTypes.number.isRequired };\n\n\nclass QuerySearch extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6, _context7, _context8, _context9, _context10, _context11, _context12;\n    super(props);\n    this.state = {\n      userLoading: false,\n      userOptions: [],\n      databaseId: null,\n      userId: null,\n      searchText: null,\n      from: '28 days ago',\n      to: 'now',\n      status: 'success',\n      queriesArray: [],\n      queriesLoading: true };\n\n    this.userMutator = _bindInstanceProperty(_context = this.userMutator).call(_context, this);\n    this.changeUser = _bindInstanceProperty(_context2 = this.changeUser).call(_context2, this);\n    this.dbMutator = _bindInstanceProperty(_context3 = this.dbMutator).call(_context3, this);\n    this.onChange = _bindInstanceProperty(_context4 = this.onChange).call(_context4, this);\n    this.changeSearch = _bindInstanceProperty(_context5 = this.changeSearch).call(_context5, this);\n    this.onKeyDown = _bindInstanceProperty(_context6 = this.onKeyDown).call(_context6, this);\n    this.changeFrom = _bindInstanceProperty(_context7 = this.changeFrom).call(_context7, this);\n    this.changeTo = _bindInstanceProperty(_context8 = this.changeTo).call(_context8, this);\n    this.changeStatus = _bindInstanceProperty(_context9 = this.changeStatus).call(_context9, this);\n    this.refreshQueries = _bindInstanceProperty(_context10 = this.refreshQueries).call(_context10, this);\n    this.onUserClicked = _bindInstanceProperty(_context11 = this.onUserClicked).call(_context11, this);\n    this.onDbClicked = _bindInstanceProperty(_context12 = this.onDbClicked).call(_context12, this);\n  }\n\n  componentDidMount() {\n    this.refreshQueries();\n  }\n\n  onUserClicked(userId) {\n    this.setState({ userId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onDbClicked(dbId) {\n    this.setState({ databaseId: dbId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onChange(db) {\n    const val = db ? db.value : null;\n    this.setState({ databaseId: val });\n  }\n\n  onKeyDown(event) {\n    if (event.keyCode === 13) {\n      this.refreshQueries();\n    }\n  }\n\n  getTimeFromSelection(selection) {\n    switch (selection) {\n      case 'now':\n        return now();\n      case '1 hour ago':\n        return epochTimeXHoursAgo(1);\n      case '1 day ago':\n        return epochTimeXDaysAgo(1);\n      case '7 days ago':\n        return epochTimeXDaysAgo(7);\n      case '28 days ago':\n        return epochTimeXDaysAgo(28);\n      case '90 days ago':\n        return epochTimeXDaysAgo(90);\n      case '1 year ago':\n        return epochTimeXYearsAgo(1);\n      default:\n        return null;}\n\n  }\n\n  changeFrom(user) {\n    const val = user ? user.value : null;\n    this.setState({ from: val });\n  }\n\n  changeTo(status) {\n    const val = status ? status.value : null;\n    this.setState({ to: val });\n  }\n\n  changeUser(user) {\n    const val = user ? user.value : null;\n    this.setState({ userId: val });\n  }\n\n  insertParams(baseUrl, params) {\n    const validParams = _filterInstanceProperty(params).call(params, function (p) {\n      return p !== '';\n    });\n    return baseUrl + '?' + validParams.join('&');\n  }\n\n  changeStatus(status) {\n    const val = status ? status.value : null;\n    this.setState({ status: val });\n  }\n\n  changeSearch(event) {\n    this.setState({ searchText: event.target.value });\n  }\n\n  userLabel(user) {\n    if (user.first_name && user.last_name) {\n      return user.first_name + ' ' + user.last_name;\n    }\n    return user.username;\n  }\n\n  userMutator(data) {\n    const options = [];\n    for (let i = 0; i < data.pks.length; i++) {\n      options.push({\n        value: data.pks[i],\n        label: this.userLabel(data.result[i]) });\n\n    }\n    return options;\n  }\n\n  dbMutator(data) {var _context13;\n    const options = _mapInstanceProperty(_context13 = data.result).call(_context13, db => ({\n      value: db.id,\n      label: db.database_name }));\n\n    this.props.actions.setDatabases(data.result);\n    if (data.result.length === 0) {\n      this.props.actions.addDangerToast(\n      t(\"It seems you don't have access to any database\"));\n\n    }\n    return options;\n  }\n\n  refreshQueries() {\n    this.setState({ queriesLoading: true });\n    const params = [\n    this.state.userId ? \"user_id=\" + this.state.userId : '',\n    this.state.databaseId ? \"database_id=\" + this.state.databaseId : '',\n    this.state.searchText ? \"search_text=\" + this.state.searchText : '',\n    this.state.status ? \"status=\" + this.state.status : '',\n    this.state.from ? \"from=\" +\n    this.getTimeFromSelection(this.state.from) :\n    '',\n    this.state.to ? \"to=\" + this.getTimeFromSelection(this.state.to) : ''];\n\n\n    SupersetClient.get({\n      endpoint: this.insertParams('/superset/search_queries', params) }).\n\n    then(({ json }) => {\n      this.setState({ queriesArray: json, queriesLoading: false });\n    }).\n    catch(() => {\n      this.props.actions.addDangerToast(\n      t('An error occurred when refreshing queries'));\n\n    });\n  }\n\n  render() {var _context14, _context15;\n    return (\n      ___EmotionJSX(\"div\", { __source: { fileName: _jsxFileName, lineNumber: 211 }, __self: this },\n      ___EmotionJSX(\"div\", { id: \"search-header\", className: \"row space-1\", __source: { fileName: _jsxFileName, lineNumber: 212 }, __self: this },\n      ___EmotionJSX(\"div\", { className: \"col-sm-2\", __source: { fileName: _jsxFileName, lineNumber: 213 }, __self: this },\n      ___EmotionJSX(AsyncSelect, {\n        dataEndpoint: \"/users/api/read\",\n        mutator: this.userMutator,\n        value: this.state.userId,\n        onChange: this.changeUser,\n        placeholder: t('Filter by user'), __source: { fileName: _jsxFileName, lineNumber: 214 }, __self: this })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-2\", __source: { fileName: _jsxFileName, lineNumber: 222 }, __self: this },\n      ___EmotionJSX(AsyncSelect, {\n        onChange: this.onChange,\n        dataEndpoint: \"/api/v1/database/?q=(filters:!((col:expose_in_sqllab,opr:eq,value:!t)))\",\n        value: this.state.databaseId,\n        mutator: this.dbMutator,\n        placeholder: t('Filter by database'), __source: { fileName: _jsxFileName, lineNumber: 223 }, __self: this })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-4\", __source: { fileName: _jsxFileName, lineNumber: 231 }, __self: this },\n      ___EmotionJSX(\"input\", {\n        type: \"text\",\n        onChange: this.changeSearch,\n        onKeyDown: this.onKeyDown,\n        className: \"form-control input-sm\",\n        placeholder: t('Query search string'), __source: { fileName: _jsxFileName, lineNumber: 232 }, __self: this })),\n\n\n      ___EmotionJSX(\"div\", { className: \"col-sm-4 search-date-filter-container\", __source: { fileName: _jsxFileName, lineNumber: 240 }, __self: this },\n      ___EmotionJSX(Select, {\n        name: \"select-from\",\n        placeholder: t('[From]-'),\n        options: _mapInstanceProperty(_context14 = _sliceInstanceProperty(TIME_OPTIONS).call(TIME_OPTIONS, 1, TIME_OPTIONS.length)).call(_context14, xt => ({\n          value: xt,\n          label: xt })),\n\n        value: this.state.from,\n        autosize: false,\n        onChange: this.changeFrom, __source: { fileName: _jsxFileName, lineNumber: 241 }, __self: this }),\n\n\n      ___EmotionJSX(Select, {\n        name: \"select-to\",\n        placeholder: t('[To]-'),\n        options: _mapInstanceProperty(TIME_OPTIONS).call(TIME_OPTIONS, xt => ({ value: xt, label: xt })),\n        value: this.state.to,\n        autosize: false,\n        onChange: this.changeTo, __source: { fileName: _jsxFileName, lineNumber: 253 }, __self: this }),\n\n\n      ___EmotionJSX(Select, {\n        name: \"select-status\",\n        placeholder: t('Filter by status'),\n        options: _mapInstanceProperty(_context15 = _Object$keys(STATUS_OPTIONS)).call(_context15, s => ({\n          value: s,\n          label: s })),\n\n        value: this.state.status,\n        isLoading: false,\n        autosize: false,\n        onChange: this.changeStatus, __source: { fileName: _jsxFileName, lineNumber: 262 }, __self: this }),\n\n\n      ___EmotionJSX(Button, {\n        bsSize: \"small\",\n        bsStyle: \"success\",\n        onClick: this.refreshQueries, __source: { fileName: _jsxFileName, lineNumber: 275 }, __self: this },\n\n      t('Search')))),\n\n\n\n      ___EmotionJSX(\"div\", { className: \"scrollbar-container\", __source: { fileName: _jsxFileName, lineNumber: 284 }, __self: this },\n      this.state.queriesLoading ?\n      ___EmotionJSX(Loading, { __source: { fileName: _jsxFileName, lineNumber: 286 }, __self: this }) :\n\n      ___EmotionJSX(\"div\", {\n        className: \"scrollbar-content\",\n        style: { height: this.props.height }, __source: { fileName: _jsxFileName, lineNumber: 288 }, __self: this },\n\n      ___EmotionJSX(QueryTable, {\n        columns: [\n        'state',\n        'db',\n        'user',\n        'time',\n        'progress',\n        'rows',\n        'sql',\n        'querylink'],\n\n        onUserClicked: this.onUserClicked,\n        onDbClicked: this.onDbClicked,\n        queries: this.state.queriesArray,\n        actions: this.props.actions,\n        displayLimit: this.props.displayLimit, __source: { fileName: _jsxFileName, lineNumber: 292 }, __self: this })))));\n\n\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}QuerySearch.propTypes = propTypes;const _default =\nQuerySearch;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(QuerySearch, \"QuerySearch\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/QuerySearch.jsx"],"names":["React","PropTypes","Button","Select","t","SupersetClient","Loading","QueryTable","now","epochTimeXHoursAgo","epochTimeXDaysAgo","epochTimeXYearsAgo","STATUS_OPTIONS","TIME_OPTIONS","AsyncSelect","propTypes","actions","object","isRequired","height","string","displayLimit","number","QuerySearch","PureComponent","constructor","props","state","userLoading","userOptions","databaseId","userId","searchText","from","to","status","queriesArray","queriesLoading","userMutator","changeUser","dbMutator","onChange","changeSearch","onKeyDown","changeFrom","changeTo","changeStatus","refreshQueries","onUserClicked","onDbClicked","componentDidMount","setState","dbId","db","val","value","event","keyCode","getTimeFromSelection","selection","user","insertParams","baseUrl","params","validParams","p","join","target","userLabel","first_name","last_name","username","data","options","i","pks","length","push","label","result","id","database_name","setDatabases","addDangerToast","get","endpoint","then","json","catch","render","xt","s"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { Button } from 'react-bootstrap';\nimport Select from 'src/components/Select';\nimport { t } from '@superset-ui/translation';\nimport { SupersetClient } from '@superset-ui/connection';\n\nimport Loading from '../../components/Loading';\nimport QueryTable from './QueryTable';\nimport {\n  now,\n  epochTimeXHoursAgo,\n  epochTimeXDaysAgo,\n  epochTimeXYearsAgo,\n} from '../../modules/dates';\nimport { STATUS_OPTIONS, TIME_OPTIONS } from '../constants';\nimport AsyncSelect from '../../components/AsyncSelect';\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  height: PropTypes.string.isRequired,\n  displayLimit: PropTypes.number.isRequired,\n};\n\nclass QuerySearch extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      userLoading: false,\n      userOptions: [],\n      databaseId: null,\n      userId: null,\n      searchText: null,\n      from: '28 days ago',\n      to: 'now',\n      status: 'success',\n      queriesArray: [],\n      queriesLoading: true,\n    };\n    this.userMutator = this.userMutator.bind(this);\n    this.changeUser = this.changeUser.bind(this);\n    this.dbMutator = this.dbMutator.bind(this);\n    this.onChange = this.onChange.bind(this);\n    this.changeSearch = this.changeSearch.bind(this);\n    this.onKeyDown = this.onKeyDown.bind(this);\n    this.changeFrom = this.changeFrom.bind(this);\n    this.changeTo = this.changeTo.bind(this);\n    this.changeStatus = this.changeStatus.bind(this);\n    this.refreshQueries = this.refreshQueries.bind(this);\n    this.onUserClicked = this.onUserClicked.bind(this);\n    this.onDbClicked = this.onDbClicked.bind(this);\n  }\n\n  componentDidMount() {\n    this.refreshQueries();\n  }\n\n  onUserClicked(userId) {\n    this.setState({ userId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onDbClicked(dbId) {\n    this.setState({ databaseId: dbId }, () => {\n      this.refreshQueries();\n    });\n  }\n\n  onChange(db) {\n    const val = db ? db.value : null;\n    this.setState({ databaseId: val });\n  }\n\n  onKeyDown(event) {\n    if (event.keyCode === 13) {\n      this.refreshQueries();\n    }\n  }\n\n  getTimeFromSelection(selection) {\n    switch (selection) {\n      case 'now':\n        return now();\n      case '1 hour ago':\n        return epochTimeXHoursAgo(1);\n      case '1 day ago':\n        return epochTimeXDaysAgo(1);\n      case '7 days ago':\n        return epochTimeXDaysAgo(7);\n      case '28 days ago':\n        return epochTimeXDaysAgo(28);\n      case '90 days ago':\n        return epochTimeXDaysAgo(90);\n      case '1 year ago':\n        return epochTimeXYearsAgo(1);\n      default:\n        return null;\n    }\n  }\n\n  changeFrom(user) {\n    const val = user ? user.value : null;\n    this.setState({ from: val });\n  }\n\n  changeTo(status) {\n    const val = status ? status.value : null;\n    this.setState({ to: val });\n  }\n\n  changeUser(user) {\n    const val = user ? user.value : null;\n    this.setState({ userId: val });\n  }\n\n  insertParams(baseUrl, params) {\n    const validParams = params.filter(function (p) {\n      return p !== '';\n    });\n    return baseUrl + '?' + validParams.join('&');\n  }\n\n  changeStatus(status) {\n    const val = status ? status.value : null;\n    this.setState({ status: val });\n  }\n\n  changeSearch(event) {\n    this.setState({ searchText: event.target.value });\n  }\n\n  userLabel(user) {\n    if (user.first_name && user.last_name) {\n      return user.first_name + ' ' + user.last_name;\n    }\n    return user.username;\n  }\n\n  userMutator(data) {\n    const options = [];\n    for (let i = 0; i < data.pks.length; i++) {\n      options.push({\n        value: data.pks[i],\n        label: this.userLabel(data.result[i]),\n      });\n    }\n    return options;\n  }\n\n  dbMutator(data) {\n    const options = data.result.map(db => ({\n      value: db.id,\n      label: db.database_name,\n    }));\n    this.props.actions.setDatabases(data.result);\n    if (data.result.length === 0) {\n      this.props.actions.addDangerToast(\n        t(\"It seems you don't have access to any database\"),\n      );\n    }\n    return options;\n  }\n\n  refreshQueries() {\n    this.setState({ queriesLoading: true });\n    const params = [\n      this.state.userId ? `user_id=${this.state.userId}` : '',\n      this.state.databaseId ? `database_id=${this.state.databaseId}` : '',\n      this.state.searchText ? `search_text=${this.state.searchText}` : '',\n      this.state.status ? `status=${this.state.status}` : '',\n      this.state.from\n        ? `from=${this.getTimeFromSelection(this.state.from)}`\n        : '',\n      this.state.to ? `to=${this.getTimeFromSelection(this.state.to)}` : '',\n    ];\n\n    SupersetClient.get({\n      endpoint: this.insertParams('/superset/search_queries', params),\n    })\n      .then(({ json }) => {\n        this.setState({ queriesArray: json, queriesLoading: false });\n      })\n      .catch(() => {\n        this.props.actions.addDangerToast(\n          t('An error occurred when refreshing queries'),\n        );\n      });\n  }\n\n  render() {\n    return (\n      <div>\n        <div id=\"search-header\" className=\"row space-1\">\n          <div className=\"col-sm-2\">\n            <AsyncSelect\n              dataEndpoint=\"/users/api/read\"\n              mutator={this.userMutator}\n              value={this.state.userId}\n              onChange={this.changeUser}\n              placeholder={t('Filter by user')}\n            />\n          </div>\n          <div className=\"col-sm-2\">\n            <AsyncSelect\n              onChange={this.onChange}\n              dataEndpoint=\"/api/v1/database/?q=(filters:!((col:expose_in_sqllab,opr:eq,value:!t)))\"\n              value={this.state.databaseId}\n              mutator={this.dbMutator}\n              placeholder={t('Filter by database')}\n            />\n          </div>\n          <div className=\"col-sm-4\">\n            <input\n              type=\"text\"\n              onChange={this.changeSearch}\n              onKeyDown={this.onKeyDown}\n              className=\"form-control input-sm\"\n              placeholder={t('Query search string')}\n            />\n          </div>\n          <div className=\"col-sm-4 search-date-filter-container\">\n            <Select\n              name=\"select-from\"\n              placeholder={t('[From]-')}\n              options={TIME_OPTIONS.slice(1, TIME_OPTIONS.length).map(xt => ({\n                value: xt,\n                label: xt,\n              }))}\n              value={this.state.from}\n              autosize={false}\n              onChange={this.changeFrom}\n            />\n\n            <Select\n              name=\"select-to\"\n              placeholder={t('[To]-')}\n              options={TIME_OPTIONS.map(xt => ({ value: xt, label: xt }))}\n              value={this.state.to}\n              autosize={false}\n              onChange={this.changeTo}\n            />\n\n            <Select\n              name=\"select-status\"\n              placeholder={t('Filter by status')}\n              options={Object.keys(STATUS_OPTIONS).map(s => ({\n                value: s,\n                label: s,\n              }))}\n              value={this.state.status}\n              isLoading={false}\n              autosize={false}\n              onChange={this.changeStatus}\n            />\n\n            <Button\n              bsSize=\"small\"\n              bsStyle=\"success\"\n              onClick={this.refreshQueries}\n            >\n              {t('Search')}\n            </Button>\n          </div>\n        </div>\n        <div className=\"scrollbar-container\">\n          {this.state.queriesLoading ? (\n            <Loading />\n          ) : (\n            <div\n              className=\"scrollbar-content\"\n              style={{ height: this.props.height }}\n            >\n              <QueryTable\n                columns={[\n                  'state',\n                  'db',\n                  'user',\n                  'time',\n                  'progress',\n                  'rows',\n                  'sql',\n                  'querylink',\n                ]}\n                onUserClicked={this.onUserClicked}\n                onDbClicked={this.onDbClicked}\n                queries={this.state.queriesArray}\n                actions={this.props.actions}\n                displayLimit={this.props.displayLimit}\n              />\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n}\nQuerySearch.propTypes = propTypes;\nexport default QuerySearch;\n"]},"metadata":{},"sourceType":"module"}