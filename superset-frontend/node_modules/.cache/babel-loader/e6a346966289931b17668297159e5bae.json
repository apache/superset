{"ast":null,"code":"import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";var _jsxFileName = \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Licensed to the Apache Software Foundation (ASF) under one\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * or more contributor license agreements.  See the NOTICE file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * distributed with this work for additional information\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * regarding copyright ownership.  The ASF licenses this file\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * to you under the Apache License, Version 2.0 (the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * \"License\"); you may not use this file except in compliance\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * with the License.  You may obtain a copy of the License at\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *   http://www.apache.org/licenses/LICENSE-2.0\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * Unless required by applicable law or agreed to in writing,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * software distributed under the License is distributed on an\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * KIND, either express or implied.  See the License for the\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * specific language governing permissions and limitations\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * under the License.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    */\nimport moment from 'moment';\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { bindActionCreators } from 'redux';\nimport { connect } from 'react-redux';\nimport { Alert } from 'react-bootstrap';\nimport Dialog from 'react-bootstrap-dialog';\nimport { t } from '@superset-ui/translation';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\n\nimport shortid from 'shortid';\nimport { exploreChart } from '../../explore/exploreUtils';\nimport * as actions from '../actions/sqlLab';\nimport Button from '../../components/Button';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  query: PropTypes.object,\n  errorMessage: PropTypes.string,\n  timeout: PropTypes.number,\n  database: PropTypes.object.isRequired };\n\nconst defaultProps = {\n  query: {} };\n\n\nclass ExploreResultsButton extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4;\n    super(props);\n    this.visualize = _bindInstanceProperty(_context = this.visualize).call(_context, this);\n    this.onClick = _bindInstanceProperty(_context2 = this.onClick).call(_context2, this);\n    this.getInvalidColumns = _bindInstanceProperty(_context3 = this.getInvalidColumns).call(_context3, this);\n    this.renderInvalidColumnMessage = _bindInstanceProperty(_context4 = this.renderInvalidColumnMessage).call(_context4,\n    this);\n\n  }\n  onClick() {\n    const timeout = this.props.timeout;\n    const msg = this.renderInvalidColumnMessage();\n    if (Math.round(this.getQueryDuration()) > timeout) {\n      this.dialog.show({\n        title: t('Explore'),\n        body: this.renderTimeoutWarning(),\n        actions: [\n        Dialog.CancelAction(),\n        Dialog.OKAction(() => {\n          this.visualize();\n        })],\n\n        bsSize: 'large',\n        onHide: dialog => {\n          dialog.hide();\n        } });\n\n    } else if (msg) {\n      this.dialog.show({\n        title: t('Explore'),\n        body: msg,\n        actions: [Dialog.DefaultAction('Ok', () => {}, 'btn-primary')],\n        bsSize: 'large',\n        bsStyle: 'warning',\n        onHide: dialog => {\n          dialog.hide();\n        } });\n\n    } else {\n      this.visualize();\n    }\n  }\n  getColumns() {\n    const props = this.props;\n    if (\n    props.query &&\n    props.query.results &&\n    props.query.results.selected_columns)\n    {\n      return props.query.results.selected_columns;\n    }\n    return [];\n  }\n  getQueryDuration() {\n    return moment.\n    duration(this.props.query.endDttm - this.props.query.startDttm).\n    asSeconds();\n  }\n  getInvalidColumns() {var _context5, _context6;\n    const re1 = /^[A-Za-z_]\\w*$/; // starts with char or _, then only alphanum\n    const re2 = /__\\d+$/; // does not finish with __ and then a number which screams dup col name\n    const re3 = /^__/; // is not a reserved column name e.g. __timestamp\n\n    return _filterInstanceProperty(_context5 = _mapInstanceProperty(_context6 = this.props.query.results.selected_columns).call(_context6,\n    col => col.name)).call(_context5,\n    col => !re1.test(col) || re2.test(col) || re3.test(col));\n  }\n  datasourceName() {\n    const { query } = this.props;\n    const uniqueId = shortid.generate();\n    let datasourceName = uniqueId;\n    if (query) {\n      datasourceName = query.user ? query.user + \"-\" : '';\n      datasourceName += query.tab + \"-\" + uniqueId;\n    }\n    return datasourceName;\n  }\n  buildVizOptions() {\n    const { schema, sql, dbId, templateParams } = this.props.query;\n    return {\n      dbId,\n      schema,\n      sql,\n      templateParams,\n      datasourceName: this.datasourceName(),\n      columns: this.getColumns() };\n\n  }\n  visualize() {\n    this.props.actions.\n    createDatasource(this.buildVizOptions()).\n    then(data => {\n      const columns = this.getColumns();\n      const formData = {\n        datasource: data.table_id + \"__table\",\n        metrics: [],\n        groupby: [],\n        time_range: 'No filter',\n        viz_type: 'table',\n        all_columns: _mapInstanceProperty(columns).call(columns, c => c.name),\n        row_limit: 1000 };\n\n\n      this.props.actions.addInfoToast(\n      t('Creating a data source and creating a new tab'));\n\n\n      // open new window for data visualization\n      exploreChart(formData);\n    }).\n    catch(() => {\n      this.props.actions.addDangerToast(\n      this.props.errorMessage || t('An error occurred'));\n\n    });\n  }\n  renderTimeoutWarning() {\n    return (\n      ___EmotionJSX(Alert, { bsStyle: \"warning\", __source: { fileName: _jsxFileName, lineNumber: 164 }, __self: this },\n      t(\n      'This query took %s seconds to run, ',\n      Math.round(this.getQueryDuration())) +\n\n      t(\n      'and the explore view times out at %s seconds ',\n      this.props.timeout) +\n\n      t(\n      'following this flow will most likely lead to your query timing out. ') +\n\n      t(\n      'We recommend your summarize your data further before following that flow. ') +\n\n      t('If activated you can use the '),\n      ___EmotionJSX(\"strong\", { __source: { fileName: _jsxFileName, lineNumber: 180 }, __self: this }, \"CREATE TABLE AS \"),\n      t('feature to store a summarized data set that you can then explore.')));\n\n\n  }\n  renderInvalidColumnMessage() {\n    const invalidColumns = this.getInvalidColumns();\n    if (invalidColumns.length === 0) {\n      return null;\n    }\n    return (\n      ___EmotionJSX(\"div\", { __source: { fileName: _jsxFileName, lineNumber: 191 }, __self: this },\n      t('Column name(s) '),\n      ___EmotionJSX(\"code\", { __source: { fileName: _jsxFileName, lineNumber: 193 }, __self: this },\n      ___EmotionJSX(\"strong\", { __source: { fileName: _jsxFileName, lineNumber: 194 }, __self: this }, invalidColumns.join(', '), \" \")),\n\n      t('cannot be used as a column name. Please use aliases (as in '),\n      ___EmotionJSX(\"code\", { __source: { fileName: _jsxFileName, lineNumber: 197 }, __self: this }, \"SELECT count(*)\\xA0\",\n\n      ___EmotionJSX(\"strong\", { __source: { fileName: _jsxFileName, lineNumber: 199 }, __self: this }, \"AS my_alias\")), \")\",\n\n      ' ',\n      t(\"limited to alphanumeric characters and underscores. Column aliases starting\\n          with double underscores or ending with double underscores followed by a\\n          numeric value are not allowed for reasons discussed in Github issue #5739.\\n          \")));\n\n\n\n\n\n  }\n  render() {\n    const allowsSubquery =\n    this.props.database && this.props.database.allows_subquery;\n    return (\n      ___EmotionJSX(React.Fragment, null,\n      ___EmotionJSX(Button, {\n        bsSize: \"small\",\n        onClick: this.onClick,\n        disabled: !allowsSubquery,\n        tooltip: t('Explore the result set in the data exploration view'), __source: { fileName: _jsxFileName, lineNumber: 214 }, __self: this },\n\n      ___EmotionJSX(InfoTooltipWithTrigger, {\n        icon: \"line-chart\",\n        placement: \"top\",\n        label: \"explore\", __source: { fileName: _jsxFileName, lineNumber: 220 }, __self: this }),\n      ' ',\n      t('Explore')),\n\n      ___EmotionJSX(Dialog, {\n        ref: el => {\n          this.dialog = el;\n        }, __source: { fileName: _jsxFileName, lineNumber: 227 }, __self: this })));\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}ExploreResultsButton.propTypes = propTypes;\nExploreResultsButton.defaultProps = defaultProps;\n\nfunction mapStateToProps({ sqlLab, common }) {\n  return {\n    errorMessage: sqlLab.errorMessage,\n    timeout: common.conf ? common.conf.SUPERSET_WEBSERVER_TIMEOUT : null };\n\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    actions: bindActionCreators(actions, dispatch) };\n\n}\n\nexport { ExploreResultsButton };const _default =\nconnect(\nmapStateToProps,\nmapDispatchToProps)(\nExploreResultsButton);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\");reactHotLoader.register(ExploreResultsButton, \"ExploreResultsButton\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\");reactHotLoader.register(mapStateToProps, \"mapStateToProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\");reactHotLoader.register(mapDispatchToProps, \"mapDispatchToProps\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\");reactHotLoader.register(_default, \"default\", \"/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/home/tiago/git-facilit/incubator-superset/superset-frontend/src/SqlLab/components/ExploreResultsButton.jsx"],"names":["moment","React","PropTypes","bindActionCreators","connect","Alert","Dialog","t","InfoTooltipWithTrigger","shortid","exploreChart","actions","Button","propTypes","object","isRequired","query","errorMessage","string","timeout","number","database","defaultProps","ExploreResultsButton","PureComponent","constructor","props","visualize","onClick","getInvalidColumns","renderInvalidColumnMessage","msg","Math","round","getQueryDuration","dialog","show","title","body","renderTimeoutWarning","CancelAction","OKAction","bsSize","onHide","hide","DefaultAction","bsStyle","getColumns","results","selected_columns","duration","endDttm","startDttm","asSeconds","re1","re2","re3","col","name","test","datasourceName","uniqueId","generate","user","tab","buildVizOptions","schema","sql","dbId","templateParams","columns","createDatasource","then","data","formData","datasource","table_id","metrics","groupby","time_range","viz_type","all_columns","c","row_limit","addInfoToast","catch","addDangerToast","invalidColumns","length","join","render","allowsSubquery","allows_subquery","el","mapStateToProps","sqlLab","common","conf","SUPERSET_WEBSERVER_TIMEOUT","mapDispatchToProps","dispatch"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport moment from 'moment';\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { bindActionCreators } from 'redux';\nimport { connect } from 'react-redux';\nimport { Alert } from 'react-bootstrap';\nimport Dialog from 'react-bootstrap-dialog';\nimport { t } from '@superset-ui/translation';\nimport { InfoTooltipWithTrigger } from '@superset-ui/chart-controls';\n\nimport shortid from 'shortid';\nimport { exploreChart } from '../../explore/exploreUtils';\nimport * as actions from '../actions/sqlLab';\nimport Button from '../../components/Button';\n\nconst propTypes = {\n  actions: PropTypes.object.isRequired,\n  query: PropTypes.object,\n  errorMessage: PropTypes.string,\n  timeout: PropTypes.number,\n  database: PropTypes.object.isRequired,\n};\nconst defaultProps = {\n  query: {},\n};\n\nclass ExploreResultsButton extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.visualize = this.visualize.bind(this);\n    this.onClick = this.onClick.bind(this);\n    this.getInvalidColumns = this.getInvalidColumns.bind(this);\n    this.renderInvalidColumnMessage = this.renderInvalidColumnMessage.bind(\n      this,\n    );\n  }\n  onClick() {\n    const timeout = this.props.timeout;\n    const msg = this.renderInvalidColumnMessage();\n    if (Math.round(this.getQueryDuration()) > timeout) {\n      this.dialog.show({\n        title: t('Explore'),\n        body: this.renderTimeoutWarning(),\n        actions: [\n          Dialog.CancelAction(),\n          Dialog.OKAction(() => {\n            this.visualize();\n          }),\n        ],\n        bsSize: 'large',\n        onHide: dialog => {\n          dialog.hide();\n        },\n      });\n    } else if (msg) {\n      this.dialog.show({\n        title: t('Explore'),\n        body: msg,\n        actions: [Dialog.DefaultAction('Ok', () => {}, 'btn-primary')],\n        bsSize: 'large',\n        bsStyle: 'warning',\n        onHide: dialog => {\n          dialog.hide();\n        },\n      });\n    } else {\n      this.visualize();\n    }\n  }\n  getColumns() {\n    const props = this.props;\n    if (\n      props.query &&\n      props.query.results &&\n      props.query.results.selected_columns\n    ) {\n      return props.query.results.selected_columns;\n    }\n    return [];\n  }\n  getQueryDuration() {\n    return moment\n      .duration(this.props.query.endDttm - this.props.query.startDttm)\n      .asSeconds();\n  }\n  getInvalidColumns() {\n    const re1 = /^[A-Za-z_]\\w*$/; // starts with char or _, then only alphanum\n    const re2 = /__\\d+$/; // does not finish with __ and then a number which screams dup col name\n    const re3 = /^__/; // is not a reserved column name e.g. __timestamp\n\n    return this.props.query.results.selected_columns\n      .map(col => col.name)\n      .filter(col => !re1.test(col) || re2.test(col) || re3.test(col));\n  }\n  datasourceName() {\n    const { query } = this.props;\n    const uniqueId = shortid.generate();\n    let datasourceName = uniqueId;\n    if (query) {\n      datasourceName = query.user ? `${query.user}-` : '';\n      datasourceName += `${query.tab}-${uniqueId}`;\n    }\n    return datasourceName;\n  }\n  buildVizOptions() {\n    const { schema, sql, dbId, templateParams } = this.props.query;\n    return {\n      dbId,\n      schema,\n      sql,\n      templateParams,\n      datasourceName: this.datasourceName(),\n      columns: this.getColumns(),\n    };\n  }\n  visualize() {\n    this.props.actions\n      .createDatasource(this.buildVizOptions())\n      .then(data => {\n        const columns = this.getColumns();\n        const formData = {\n          datasource: `${data.table_id}__table`,\n          metrics: [],\n          groupby: [],\n          time_range: 'No filter',\n          viz_type: 'table',\n          all_columns: columns.map(c => c.name),\n          row_limit: 1000,\n        };\n\n        this.props.actions.addInfoToast(\n          t('Creating a data source and creating a new tab'),\n        );\n\n        // open new window for data visualization\n        exploreChart(formData);\n      })\n      .catch(() => {\n        this.props.actions.addDangerToast(\n          this.props.errorMessage || t('An error occurred'),\n        );\n      });\n  }\n  renderTimeoutWarning() {\n    return (\n      <Alert bsStyle=\"warning\">\n        {t(\n          'This query took %s seconds to run, ',\n          Math.round(this.getQueryDuration()),\n        ) +\n          t(\n            'and the explore view times out at %s seconds ',\n            this.props.timeout,\n          ) +\n          t(\n            'following this flow will most likely lead to your query timing out. ',\n          ) +\n          t(\n            'We recommend your summarize your data further before following that flow. ',\n          ) +\n          t('If activated you can use the ')}\n        <strong>CREATE TABLE AS </strong>\n        {t('feature to store a summarized data set that you can then explore.')}\n      </Alert>\n    );\n  }\n  renderInvalidColumnMessage() {\n    const invalidColumns = this.getInvalidColumns();\n    if (invalidColumns.length === 0) {\n      return null;\n    }\n    return (\n      <div>\n        {t('Column name(s) ')}\n        <code>\n          <strong>{invalidColumns.join(', ')} </strong>\n        </code>\n        {t('cannot be used as a column name. Please use aliases (as in ')}\n        <code>\n          SELECT count(*)&nbsp;\n          <strong>AS my_alias</strong>\n        </code>\n        ){' '}\n        {t(`limited to alphanumeric characters and underscores. Column aliases starting\n          with double underscores or ending with double underscores followed by a\n          numeric value are not allowed for reasons discussed in Github issue #5739.\n          `)}\n      </div>\n    );\n  }\n  render() {\n    const allowsSubquery =\n      this.props.database && this.props.database.allows_subquery;\n    return (\n      <>\n        <Button\n          bsSize=\"small\"\n          onClick={this.onClick}\n          disabled={!allowsSubquery}\n          tooltip={t('Explore the result set in the data exploration view')}\n        >\n          <InfoTooltipWithTrigger\n            icon=\"line-chart\"\n            placement=\"top\"\n            label=\"explore\"\n          />{' '}\n          {t('Explore')}\n        </Button>\n        <Dialog\n          ref={el => {\n            this.dialog = el;\n          }}\n        />\n      </>\n    );\n  }\n}\nExploreResultsButton.propTypes = propTypes;\nExploreResultsButton.defaultProps = defaultProps;\n\nfunction mapStateToProps({ sqlLab, common }) {\n  return {\n    errorMessage: sqlLab.errorMessage,\n    timeout: common.conf ? common.conf.SUPERSET_WEBSERVER_TIMEOUT : null,\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    actions: bindActionCreators(actions, dispatch),\n  };\n}\n\nexport { ExploreResultsButton };\nexport default connect(\n  mapStateToProps,\n  mapDispatchToProps,\n)(ExploreResultsButton);\n"]},"metadata":{},"sourceType":"module"}